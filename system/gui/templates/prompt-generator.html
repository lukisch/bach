<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH Prompt-Generator</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* Prompt Generator Specific Styles */
        .prompt-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
            min-height: calc(100vh - 150px);
        }

        @media (max-width: 900px) {
            .prompt-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .template-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .template-item {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text);
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .template-item:hover {
            background: var(--bg-card);
        }

        .template-item.selected {
            background: var(--bg-card);
            border-left-color: var(--accent);
        }

        .template-item .template-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Main Editor */
        .editor-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .editor-card {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            flex: 1;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .editor-header h2 {
            font-size: 1.125rem;
            color: var(--text);
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 300px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text);
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .char-count {
            text-align: right;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Send Options */
        .send-options {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .send-options h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .send-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        @media (max-width: 700px) {
            .send-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .send-btn {
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
        }

        .send-btn:hover {
            background: var(--border);
            transform: translateY(-2px);
        }

        .send-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .send-btn.primary:hover {
            background: var(--accent-light);
        }

        .send-btn-icon {
            font-size: 1.5rem;
        }

        .send-btn-label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .send-btn-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Daemon Panel */
        .daemon-panel {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .daemon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .daemon-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .daemon-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .daemon-setting {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .daemon-setting label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .daemon-setting input,
        .daemon-setting select {
            padding: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.875rem;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Tab Navigation */
        .pg-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
        }
        .pg-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .pg-tab:hover { color: var(--text); }
        .pg-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .pg-tab-content { display: none; }
        .pg-tab-content.active { display: block; }

        /* Auto-Sessions */
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .session-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s;
        }
        .session-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .session-card h3 {
            font-size: 1rem;
            margin: 0 0 0.5rem 0;
            color: var(--text);
        }
        .session-card .session-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            line-height: 1.4;
        }
        .session-card .session-meta {
            display: flex;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        .session-card .session-meta span {
            background: var(--bg-card);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        .session-card .session-actions {
            display: flex;
            gap: 0.5rem;
        }
        .session-category {
            margin-bottom: 1.5rem;
        }
        .session-category h2 {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        /* Variables Panel */
        .variables-panel {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .variables-panel h4 {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            color: var(--text-muted);
        }

        .variable-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .variable-row input {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <!-- Tab Navigation -->
        <div class="pg-tabs">
            <button class="pg-tab active" onclick="switchPgTab('editor')">Prompt Editor</button>
            <button class="pg-tab" onclick="switchPgTab('auto-sessions')">Auto-Sessions</button>
        </div>

        <!-- Tab: Editor (bestehend) -->
        <div class="pg-tab-content active" id="tab-editor">
        <div class="prompt-layout">
            <!-- Sidebar: Templates (PROMPT_GEN_002) -->
            <div class="sidebar">
                <div class="template-section">
                    <h3>System-Vorlagen</h3>
                    <div class="template-list" id="system-templates">
                        <p class="loading">Lade...</p>
                    </div>
                </div>

                <div class="template-section">
                    <h3>Agenten-Vorlagen</h3>
                    <div class="template-list" id="agent-templates">
                        <p class="loading">Lade...</p>
                    </div>
                </div>

                <div class="template-section">
                    <h3>Eigene Vorlagen</h3>
                    <div class="template-list" id="custom-templates">
                        <p style="font-size: 0.8rem; color: var(--text-muted); padding: 0.5rem;">
                            Noch keine eigenen Vorlagen
                        </p>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;"
                            onclick="saveAsTemplate()">
                        + Vorlage speichern
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="editor-container">
                <!-- Editor (PROMPT_GEN_001/003) -->
                <div class="editor-card">
                    <div class="editor-header">
                        <h2>Prompt Editor</h2>
                        <div class="editor-actions">
                            <button class="btn btn-secondary" onclick="resetPrompt()">Reset</button>
                            <button class="btn btn-secondary" onclick="clearPrompt()">Leeren</button>
                        </div>
                    </div>
                    <textarea class="prompt-textarea" id="prompt-editor"
                              placeholder="Schreibe deinen Prompt hier oder waehle eine Vorlage..."
                              oninput="updateCharCount()"></textarea>
                    <div class="char-count">
                        <span id="char-count">0</span> Zeichen
                    </div>

                    <!-- Variables (Optional) -->
                    <div class="variables-panel" id="variables-panel" style="display: none;">
                        <h4>Template-Variablen</h4>
                        <div id="variables-list"></div>
                    </div>
                </div>

                <!-- Session Settings -->
                <div class="send-options" style="margin-bottom: 1rem;">
                    <h3>Session-Einstellungen</h3>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div class="daemon-setting">
                            <label>Session-Dauer (Min)</label>
                            <input type="number" id="session-timeout" value="12" min="5" max="60"
                                   title="Muss kleiner als Daemon-Intervall sein">
                        </div>
                        <div class="daemon-setting" style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="include-header" style="cursor: pointer;">Auto-Session Header</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="include-header" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.8rem; flex-basis: 100%;">
                            Header = BACH-Startup + SKILL.md + Workflow | Aus = Nur dein Prompt-Text
                        </div>
                    </div>
                </div>

                <!-- Send Options (PROMPT_GEN_004) -->
                <div class="send-options">
                    <h3>Senden</h3>
                    <div class="send-buttons">
                        <button class="send-btn" onclick="sendAsTask()">
                            <span class="send-btn-icon">üìã</span>
                            <span class="send-btn-label">Als Task</span>
                            <span class="send-btn-desc">In Warteschlange</span>
                        </button>
                        <button class="send-btn primary" onclick="sendDirectSession()">
                            <span class="send-btn-icon">‚ö°</span>
                            <span class="send-btn-label">Direkt Session</span>
                            <span class="send-btn-desc">Sofort starten</span>
                        </button>
                        <button class="send-btn" onclick="copyToClipboard()">
                            <span class="send-btn-icon">üìã</span>
                            <span class="send-btn-label">Kopieren</span>
                            <span class="send-btn-desc">In Zwischenablage</span>
                        </button>
                        <button class="send-btn" onclick="scheduleWithDaemon()">
                            <span class="send-btn-icon">‚è∞</span>
                            <span class="send-btn-label">Daemon</span>
                            <span class="send-btn-desc">Zeitgesteuert</span>
                        </button>
                    </div>
                </div>

                <!-- Daemon Panel (PROMPT_GEN_005) -->
                <div class="daemon-panel">
                    <div class="daemon-header">
                        <h3>Daemon-Steuerung</h3>
                        <div class="daemon-status">
                            <span class="status-dot" id="daemon-status-dot"></span>
                            <span id="daemon-status-text">Inaktiv</span>
                        </div>
                    </div>
                    <div class="daemon-controls">
                        <div class="daemon-setting">
                            <label>Intervall (Min)</label>
                            <input type="number" id="daemon-interval" value="30" min="5" max="180">
                        </div>
                        <div class="daemon-setting">
                            <label>Max Sessions</label>
                            <input type="number" id="daemon-max" value="0" min="0"
                                   placeholder="0 = unbegrenzt">
                        </div>
                        <div class="daemon-setting">
                            <label>Ruhezeit</label>
                            <select id="daemon-quiet">
                                <option value="">Keine</option>
                                <option value="22:00-08:00" selected>22:00-08:00</option>
                                <option value="23:00-07:00">23:00-07:00</option>
                                <option value="00:00-06:00">00:00-06:00</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" id="daemon-toggle" onclick="toggleDaemon()">
                            Daemon Starten
                        </button>
                        <button class="btn btn-secondary" onclick="saveDaemonConfig()">
                            Einstellungen Speichern
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- /tab-editor -->

        <!-- Tab: Auto-Sessions -->
        <div class="pg-tab-content" id="tab-auto-sessions">
            <div class="session-category">
                <h2>Einzel-Sessions</h2>
                <div class="sessions-grid">
                    <div class="session-card">
                        <h3>Zugewiesene Tasks (15 Min)</h3>
                        <div class="session-desc">Bearbeitet nur Claude zugewiesene Tasks. Stoppt nach 15 Minuten und erstellt Session-Zusammenfassung.</div>
                        <div class="session-meta">
                            <span>15 Min</span><span>Zugewiesen</span><span>50 Turns</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_assigned_15min')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_assigned_15min')">Kopieren</button>
                        </div>
                    </div>
                    <div class="session-card">
                        <h3>Zugewiesene Tasks (unbegrenzt)</h3>
                        <div class="session-desc">Bearbeitet alle Claude zugewiesenen Tasks bis sie erledigt sind. Kein Zeitlimit.</div>
                        <div class="session-meta">
                            <span>Unbegrenzt</span><span>Zugewiesen</span><span>200 Turns</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_assigned_nolimit')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_assigned_nolimit')">Kopieren</button>
                        </div>
                    </div>
                    <div class="session-card">
                        <h3>Alle Tasks (15 Min)</h3>
                        <div class="session-desc">Bearbeitet alle offenen Tasks (P1 zuerst). Stoppt nach 15 Minuten.</div>
                        <div class="session-meta">
                            <span>15 Min</span><span>Alle Tasks</span><span>50 Turns</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_all_15min')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_all_15min')">Kopieren</button>
                        </div>
                    </div>
                    <div class="session-card">
                        <h3>Alle Tasks (30 Min)</h3>
                        <div class="session-desc">Bearbeitet alle offenen Tasks (P1 zuerst). Stoppt nach 30 Minuten.</div>
                        <div class="session-meta">
                            <span>30 Min</span><span>Alle Tasks</span><span>100 Turns</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_all_30min')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_all_30min')">Kopieren</button>
                        </div>
                    </div>
                    <div class="session-card">
                        <h3>Alle Tasks (1 Stunde)</h3>
                        <div class="session-desc">Bearbeitet alle offenen Tasks mit grosszuegigem Zeitbudget von 1 Stunde.</div>
                        <div class="session-meta">
                            <span>60 Min</span><span>Alle Tasks</span><span>200 Turns</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_all_1h')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_all_1h')">Kopieren</button>
                        </div>
                    </div>
                    <div class="session-card">
                        <h3>Wartung</h3>
                        <div class="session-desc">Fuehrt Wartungsaufgaben durch: Recurring-Check, Backup, Docs-Check, Konsolidierung.</div>
                        <div class="session-meta">
                            <span>~20 Min</span><span>Wartung</span><span>60 Turns</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_maintenance')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_maintenance')">Kopieren</button>
                        </div>
                    </div>
                    <div class="session-card">
                        <h3>Volle Rechte</h3>
                        <div class="session-desc">Startet Claude mit vollen Rechten. Arbeitet autonom an Tasks, Features, Bugs und Wartung.</div>
                        <div class="session-meta">
                            <span>Unbegrenzt</span><span>Voll-Autonom</span><span>200 Turns</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_full_access')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_full_access')">Kopieren</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="session-category">
                <h2>Loop-Sessions (wiederkehrend)</h2>
                <div class="sessions-grid">
                    <div class="session-card">
                        <h3>Loop: Alle 15 Minuten</h3>
                        <div class="session-desc">Startet endlos alle 15 Min eine neue Claude-Session. Jede Session arbeitet 12 Min. Ctrl+C zum Beenden.</div>
                        <div class="session-meta">
                            <span>15 Min Intervall</span><span>Endlos</span><span>40 Turns/Session</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_loop_15min')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_loop_15min')">Kopieren</button>
                        </div>
                    </div>
                    <div class="session-card">
                        <h3>Loop: Alle 30 Minuten</h3>
                        <div class="session-desc">Startet endlos alle 30 Min eine neue Claude-Session. Jede Session arbeitet 25 Min.</div>
                        <div class="session-meta">
                            <span>30 Min Intervall</span><span>Endlos</span><span>80 Turns/Session</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_loop_30min')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_loop_30min')">Kopieren</button>
                        </div>
                    </div>
                    <div class="session-card">
                        <h3>Loop: Jede Stunde</h3>
                        <div class="session-desc">Startet endlos jede Stunde eine neue Claude-Session. Jede Session arbeitet 50 Min.</div>
                        <div class="session-meta">
                            <span>60 Min Intervall</span><span>Endlos</span><span>150 Turns/Session</span>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="launchSession('claude_loop_1h')">Starten</button>
                            <button class="btn btn-secondary" onclick="copySessionCmd('claude_loop_1h')">Kopieren</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="session-category" id="session-log-section">
                <h2>Letzte Sessions</h2>
                <div id="session-log" style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 1rem;">
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Noch keine Sessions gestartet.</p>
                </div>
            </div>
        </div><!-- /tab-auto-sessions -->

    </main>

    <footer class="main-footer">
        <span>BACH Prompt-Generator v1.0</span>
        <span id="last-update">-</span>
    </footer>

    <script>
        // State
        let currentTemplate = null;
        let originalPrompt = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTemplates();
            loadDaemonStatus();
            updateStatus();
        });

        // API Helper
        async function api(endpoint, options = {}) {
            try {
                const response = await fetch(`/api${endpoint}`, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast('Fehler: ' + error.message, 'error');
                return null;
            }
        }

        // Load Templates (PROMPT_GEN_002)
        async function loadTemplates() {
            const data = await api('/prompt-generator/templates');
            if (!data) return;

            // System Templates
            const systemList = document.getElementById('system-templates');
            if (data.system && data.system.length > 0) {
                systemList.innerHTML = data.system.map(t => `
                    <div class="template-item" onclick="loadTemplate('${t.path}')">
                        ${t.name}
                        ${t.description ? `<div class="template-desc">${t.description}</div>` : ''}
                    </div>
                `).join('');
            } else {
                systemList.innerHTML = '<p style="font-size: 0.8rem; color: var(--text-muted); padding: 0.5rem;">Keine Vorlagen</p>';
            }

            // Agent Templates
            const agentList = document.getElementById('agent-templates');
            if (data.agents && data.agents.length > 0) {
                agentList.innerHTML = data.agents.map(t => `
                    <div class="template-item" onclick="loadTemplate('${t.path}')">
                        ${t.name}
                        ${t.description ? `<div class="template-desc">${t.description}</div>` : ''}
                    </div>
                `).join('');
            } else {
                agentList.innerHTML = '<p style="font-size: 0.8rem; color: var(--text-muted); padding: 0.5rem;">Keine Vorlagen</p>';
            }
        }

        // Load Template (PROMPT_GEN_003)
        async function loadTemplate(path) {
            const data = await api(`/prompt-generator/template/${encodeURIComponent(path)}`);
            if (data && data.content) {
                document.getElementById('prompt-editor').value = data.content;
                originalPrompt = data.content;
                currentTemplate = path;
                updateCharCount();

                // Highlight selected
                document.querySelectorAll('.template-item').forEach(el => el.classList.remove('selected'));
                event.target.closest('.template-item').classList.add('selected');

                // Check for variables
                checkForVariables(data.content);

                showToast(`Vorlage "${path}" geladen`, 'success');
            }
        }

        // Check for template variables
        function checkForVariables(content) {
            const matches = content.match(/\{\{([A-Z_]+)\}\}/g);
            const panel = document.getElementById('variables-panel');
            const list = document.getElementById('variables-list');

            if (matches && matches.length > 0) {
                const vars = [...new Set(matches)].map(m => m.replace(/[{}]/g, ''));
                list.innerHTML = vars.map(v => `
                    <div class="variable-row">
                        <input type="text" placeholder="${v}" data-var="${v}">
                    </div>
                `).join('');
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // Apply variables
        function applyVariables() {
            let content = document.getElementById('prompt-editor').value;
            document.querySelectorAll('#variables-list input').forEach(input => {
                const varName = input.dataset.var;
                const value = input.value || `[${varName}]`;
                content = content.replace(new RegExp(`\\{\\{${varName}\\}\\}`, 'g'), value);
            });
            return content;
        }

        // Reset Prompt (PROMPT_GEN_003)
        function resetPrompt() {
            if (originalPrompt) {
                document.getElementById('prompt-editor').value = originalPrompt;
                updateCharCount();
                showToast('Prompt zurueckgesetzt', 'success');
            }
        }

        function clearPrompt() {
            document.getElementById('prompt-editor').value = '';
            originalPrompt = '';
            currentTemplate = null;
            document.querySelectorAll('.template-item').forEach(el => el.classList.remove('selected'));
            document.getElementById('variables-panel').style.display = 'none';
            updateCharCount();
        }

        function updateCharCount() {
            const count = document.getElementById('prompt-editor').value.length;
            document.getElementById('char-count').textContent = count.toLocaleString();
        }

        // Send Options (PROMPT_GEN_004)
        async function sendAsTask() {
            const prompt = applyVariables();
            if (!prompt.trim()) {
                showToast('Bitte erst einen Prompt eingeben', 'error');
                return;
            }

            const data = await api('/prompt-generator/send/task', {
                method: 'POST',
                body: JSON.stringify({ prompt, priority: 'P2' })
            });

            if (data && data.status !== 'error') {
                showToast('Task erstellt!', 'success');
            }
        }

        async function sendDirectSession() {
            const prompt = applyVariables();
            if (!prompt.trim()) {
                showToast('Bitte erst einen Prompt eingeben', 'error');
                return;
            }

            const timeout = parseInt(document.getElementById('session-timeout').value) || 12;
            const includeHeader = document.getElementById('include-header').checked;

            // Validierung: Timeout muss < Intervall sein (nur relevant wenn Header aktiv)
            const interval = parseInt(document.getElementById('daemon-interval').value) || 30;
            if (includeHeader && timeout >= interval) {
                showToast(`Session-Dauer (${timeout} Min) muss kleiner als Intervall (${interval} Min) sein!`, 'error');
                return;
            }

            const data = await api('/prompt-generator/send/session', {
                method: 'POST',
                body: JSON.stringify({
                    prompt,
                    timeout_minutes: timeout,
                    include_header: includeHeader
                })
            });

            if (data) {
                if (data.status === 'sent') {
                    const headerInfo = includeHeader ? ' (mit Header)' : ' (nur Prompt)';
                    showToast('Session gestartet!' + headerInfo, 'success');
                } else {
                    showToast(data.message || 'Session-Start fehlgeschlagen', 'error');
                }
            }
        }

        async function copyToClipboard() {
            const prompt = applyVariables();
            if (!prompt.trim()) {
                showToast('Bitte erst einen Prompt eingeben', 'error');
                return;
            }

            try {
                await navigator.clipboard.writeText(prompt);
                showToast('In Zwischenablage kopiert!', 'success');
            } catch (err) {
                // Fallback
                const data = await api('/prompt-generator/send/copy', {
                    method: 'POST',
                    body: JSON.stringify({ prompt })
                });
                if (data && data.status === 'copied') {
                    showToast('Kopiert!', 'success');
                }
            }
        }

        function scheduleWithDaemon() {
            // Scroll to daemon panel
            document.querySelector('.daemon-panel').scrollIntoView({ behavior: 'smooth' });
            showToast('Konfiguriere Daemon-Einstellungen unten', 'success');
        }

        // Daemon Control (PROMPT_GEN_005)
        async function loadDaemonStatus() {
            const data = await api('/prompt-generator/daemon/status');
            if (data) {
                const dot = document.getElementById('daemon-status-dot');
                const text = document.getElementById('daemon-status-text');
                const btn = document.getElementById('daemon-toggle');

                if (data.enabled) {
                    dot.classList.add('online');
                    text.textContent = 'Aktiv';
                    btn.textContent = 'Daemon Stoppen';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                } else {
                    dot.classList.remove('online');
                    text.textContent = 'Inaktiv';
                    btn.textContent = 'Daemon Starten';
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-secondary');
                }

                // Load config values
                if (data.interval_minutes) {
                    document.getElementById('daemon-interval').value = data.interval_minutes;
                }
                if (data.max_sessions !== undefined) {
                    document.getElementById('daemon-max').value = data.max_sessions;
                }
            }
        }

        async function toggleDaemon() {
            const data = await api('/prompt-generator/daemon/toggle', { method: 'POST' });
            if (data) {
                loadDaemonStatus();
                showToast(data.message || 'Daemon-Status geaendert', 'success');
            }
        }

        async function saveDaemonConfig() {
            const config = {
                interval_minutes: parseInt(document.getElementById('daemon-interval').value),
                max_sessions: parseInt(document.getElementById('daemon-max').value),
                quiet_time: document.getElementById('daemon-quiet').value
            };

            const data = await api('/prompt-generator/daemon/config', {
                method: 'PUT',
                body: JSON.stringify(config)
            });

            if (data && data.status === 'updated') {
                showToast('Einstellungen gespeichert', 'success');
            }
        }

        // Save as Template (PROMPT_GEN_007)
        async function saveAsTemplate() {
            const prompt = document.getElementById('prompt-editor').value;
            if (!prompt.trim()) {
                showToast('Bitte erst einen Prompt eingeben', 'error');
                return;
            }

            const name = window.prompt('Name fuer die Vorlage:');
            if (!name) return;

            const data = await api('/prompt-generator/templates/save', {
                method: 'POST',
                body: JSON.stringify({ name, content: prompt })
            });

            if (data && data.status === 'saved') {
                showToast('Vorlage gespeichert!', 'success');
                loadTemplates();
            }
        }

        // Status
        async function updateStatus() {
            const data = await api('/status');
            if (data) {
                document.getElementById('status-dot').classList.add('online');
                document.getElementById('status-text').textContent = 'Online';
                document.getElementById('last-update').textContent =
                    'Aktualisiert: ' + new Date().toLocaleTimeString('de-DE');
            }
        }

        // Tab Switching
        function switchPgTab(tabId) {
            document.querySelectorAll('.pg-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.pg-tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Auto-Sessions
        const SESSION_CMDS = {
            claude_assigned_15min: 'claude --print "Starte mit lesen und ausfuehren von SKILL.md. Bearbeite dann NUR dir (Claude) zugewiesene Tasks aus \'bach task list\'. Arbeite maximal 15 Minuten, dann fuehre \'bach --memory session\' mit einer Zusammenfassung aus und beende mit \'bach --shutdown\'." --max-turns 50',
            claude_assigned_nolimit: 'claude --print "Starte mit lesen und ausfuehren von SKILL.md. Bearbeite dann NUR dir (Claude) zugewiesene Tasks aus \'bach task list\'. Arbeite alle zugewiesenen Tasks ab. Wenn alle erledigt sind, fuehre \'bach --memory session\' aus und beende mit \'bach --shutdown\'." --max-turns 200',
            claude_all_15min: 'claude --print "Starte mit lesen und ausfuehren von SKILL.md. Bearbeite offene Tasks aus \'bach task list\' (P1 zuerst). Arbeite maximal 15 Minuten, dann \'bach --memory session\' und \'bach --shutdown\'." --max-turns 50',
            claude_all_30min: 'claude --print "Starte mit lesen und ausfuehren von SKILL.md. Bearbeite offene Tasks aus \'bach task list\' (P1 zuerst). Arbeite maximal 30 Minuten, dann \'bach --memory session\' und \'bach --shutdown\'." --max-turns 100',
            claude_all_1h: 'claude --print "Starte mit lesen und ausfuehren von SKILL.md. Bearbeite offene Tasks aus \'bach task list\' (P1 zuerst). Arbeite maximal 60 Minuten, dann \'bach --memory session\' und \'bach --shutdown\'." --max-turns 200',
            claude_maintenance: 'claude --print "Starte mit lesen und ausfuehren von SKILL.md. Fuehre Wartungsaufgaben durch: 1) bach --recurring check 2) bach backup status 3) bach --maintain docs 4) bach consolidate run. Dann \'bach --memory session\' und \'bach --shutdown\'." --max-turns 60',
            claude_full_access: 'claude --print "Starte mit lesen und ausfuehren von SKILL.md. Du hast volle Rechte. Arbeite selbststaendig an offenen Tasks, erstelle Features, fixe Bugs." --max-turns 200 --dangerously-skip-permissions',
            claude_loop_15min: 'Loop: Alle 15 Min - Starte claude_loop_15min.bat',
            claude_loop_30min: 'Loop: Alle 30 Min - Starte claude_loop_30min.bat',
            claude_loop_1h: 'Loop: Jede Stunde - Starte claude_loop_1h.bat'
        };

        async function launchSession(sessionId) {
            const cmd = SESSION_CMDS[sessionId];
            if (!cmd) return;

            if (sessionId.includes('loop')) {
                showToast('Loop-Sessions muessen als .bat gestartet werden. Befehl wurde kopiert.', 'success');
                copySessionCmd(sessionId);
                return;
            }

            showToast('Session wird gestartet...', 'success');
            try {
                const data = await api('/auto-sessions/launch', {
                    method: 'POST',
                    body: JSON.stringify({ session_id: sessionId, command: cmd })
                });
                if (data && data.status === 'launched') {
                    addSessionLog(sessionId, 'gestartet');
                    showToast('Session ' + sessionId + ' gestartet!', 'success');
                } else {
                    showToast(data?.message || 'Fehler beim Starten', 'error');
                }
            } catch (e) {
                showToast('Fehler: ' + e.message, 'error');
            }
        }

        async function copySessionCmd(sessionId) {
            const cmd = SESSION_CMDS[sessionId];
            if (!cmd) return;
            try {
                await navigator.clipboard.writeText(cmd);
                showToast('Befehl kopiert!', 'success');
            } catch (e) {
                showToast('Kopieren fehlgeschlagen', 'error');
            }
        }

        function addSessionLog(sessionId, status) {
            const log = document.getElementById('session-log');
            const time = new Date().toLocaleTimeString('de-DE');
            const entry = document.createElement('div');
            entry.style.cssText = 'padding: 0.5rem; border-bottom: 1px solid var(--border); font-size: 0.85rem;';
            entry.innerHTML = `<span style="color: var(--text-muted);">${time}</span> <strong>${sessionId}</strong> - ${status}`;
            if (log.querySelector('p')) log.innerHTML = '';
            log.prepend(entry);
        }

        // Toast
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }
    </script>
    <script src="/static/js/nav.js"></script>
</body>
</html>
