<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - Messages</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* Dreigeteiltes Layout: Messageboxen | Nachrichten-Liste | Nachrichten-Ansicht */
        .messages-layout {
            display: grid;
            grid-template-columns: 200px 320px 1fr;
            gap: 1rem;
            height: calc(100vh - 140px);
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .messages-layout {
                grid-template-columns: 180px 280px 1fr;
            }
        }

        @media (max-width: 900px) {
            .messages-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            .panel-messages, .panel-detail {
                display: none;
            }
            .panel-messages.active, .panel-detail.active {
                display: block;
            }
        }

        /* Panel Styles */
        .panel {
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
        }

        /* Panel 1: Messageboxen */
        .folder-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .folder-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .folder-item:hover {
            background: var(--bg-card);
        }

        .folder-item.active {
            background: var(--bg-card);
            border-left-color: var(--accent);
        }

        .folder-icon {
            margin-right: 0.5rem;
        }

        .folder-count {
            background: var(--bg-dark);
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .folder-count.unread {
            background: var(--accent);
            color: white;
        }

        /* Panel 2: Nachrichten-Liste */
        .message-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .message-item:hover {
            background: var(--bg-card);
        }

        .message-item.active {
            background: var(--bg-card);
            border-left: 3px solid var(--accent);
        }

        .message-item.unread {
            background: rgba(233, 69, 96, 0.1);
        }

        .message-item.unread .message-sender {
            font-weight: 700;
        }

        .message-sender {
            font-size: 0.85rem;
            color: var(--text);
            display: flex;
            justify-content: space-between;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .message-subject {
            font-size: 0.8rem;
            margin: 0.25rem 0;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Panel 3: Nachrichten-Ansicht */
        .detail-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .detail-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .detail-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .detail-subject {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
        }

        .detail-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.25rem 0.75rem;
        }

        .detail-meta-label {
            font-weight: 500;
            color: var(--text);
        }

        .detail-body {
            padding: 1rem;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.9rem;
            flex: 1;
            overflow-y: auto;
        }

        .detail-actions {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            background: var(--bg-card);
        }

        /* Compose Modal */
        .compose-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .compose-modal.active {
            display: flex;
        }

        .compose-content {
            background: var(--bg-panel);
            padding: 1.5rem;
            border-radius: 12px;
            width: 90%;
            max-width: 550px;
            border: 1px solid var(--border);
        }

        .compose-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .compose-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }

        .compose-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.6rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Mobile Navigation */
        .mobile-back {
            display: none;
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.85rem;
        }

        @media (max-width: 900px) {
            .mobile-back {
                display: inline-block;
            }
        }

        /* Empty State */
        .empty-state {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        /* Quick Action Buttons */
        .quick-actions {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }

        .quick-btn {
            flex: 1;
            padding: 0.4rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
    </style>
</head>
<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <div class="messages-layout">
            <!-- Panel 1: Messageboxen -->
            <div class="panel panel-folders">
                <div class="panel-header">
                    Postfaecher
                    <button class="quick-btn" onclick="showCompose()" title="Neue Nachricht">+</button>
                </div>
                <div class="panel-content">
                    <ul class="folder-list">
                        <li class="folder-item active" data-filter="inbox" onclick="selectFolder('inbox')">
                            <span><span class="folder-icon">üì•</span>Inbox</span>
                            <span class="folder-count" id="inbox-count">0</span>
                        </li>
                        <li class="folder-item" data-filter="outbox" onclick="selectFolder('outbox')">
                            <span><span class="folder-icon">üì§</span>Gesendet</span>
                            <span class="folder-count" id="outbox-count">0</span>
                        </li>
                        <li class="folder-item" data-filter="archived" onclick="selectFolder('archived')">
                            <span><span class="folder-icon">üìÅ</span>Archiv</span>
                            <span class="folder-count" id="archived-count">0</span>
                        </li>
                        <li class="folder-item" data-filter="all" onclick="selectFolder('all')">
                            <span><span class="folder-icon">üìã</span>Alle</span>
                            <span class="folder-count" id="all-count">0</span>
                        </li>
                    </ul>

                    <div style="padding: 0.75rem; border-top: 1px solid var(--border);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Partner</div>
                        <ul class="folder-list" id="partner-list">
                            <!-- Dynamisch befuellt -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Panel 2: Nachrichten-Liste -->
            <div class="panel panel-messages">
                <div class="panel-header">
                    <span>
                        <button class="mobile-back" onclick="showFolders()">‚Üê</button>
                        <span id="current-folder-name">Inbox</span>
                    </span>
                    <span id="message-count" style="font-size: 0.75rem; color: var(--text-muted);">0 Nachrichten</span>
                </div>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="refreshMessages()">Aktualisieren</button>
                    <button class="quick-btn" onclick="markAllRead()">Alle gelesen</button>
                </div>
                <div class="panel-content" id="messages-list">
                    <div class="empty-state">Lade Nachrichten...</div>
                </div>
            </div>

            <!-- Panel 3: Nachrichten-Ansicht -->
            <div class="panel panel-detail">
                <div id="detail-container">
                    <div class="detail-empty">
                        <div class="detail-empty-icon">üì¨</div>
                        <p>Waehle eine Nachricht aus</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Compose Modal -->
    <div class="compose-modal" id="compose-modal">
        <div class="compose-content">
            <div class="compose-header">
                <h2>Neue Nachricht</h2>
                <button class="compose-close" onclick="hideCompose()">&times;</button>
            </div>
            <form onsubmit="sendMessage(event)">
                <div class="form-group">
                    <label>Empfaenger</label>
                    <select name="recipient" id="recipient-select">
                        <option value="">-- Waehlen --</option>
                        <option value="system">System</option>
                        <option value="user">User</option>
                        <option value="gemini">Gemini</option>
                        <option value="claude">Claude</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Betreff</label>
                    <input type="text" name="subject" placeholder="Betreff...">
                </div>
                <div class="form-group">
                    <label>Nachricht</label>
                    <textarea name="body" required placeholder="Nachrichtentext..."></textarea>
                </div>
                <div class="form-group">
                    <label>Prioritaet</label>
                    <select name="priority">
                        <option value="normal">Normal</option>
                        <option value="high">Hoch</option>
                        <option value="low">Niedrig</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCompose()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Senden</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        // State
        let currentFolder = 'inbox';
        let selectedMessageId = null;
        let messages = [];

        // API Helper (Fallback falls api.js nicht geladen)
        const api = window.API || {
            get: async (url) => {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            },
            post: async (url, data) => {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            },
            put: async (url, data) => {
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: data ? JSON.stringify(data) : undefined
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            },
            delete: async (url) => {
                const res = await fetch(url, { method: 'DELETE' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            }
        };

        // Folder Selection
        function selectFolder(folder) {
            currentFolder = folder;
            selectedMessageId = null;

            // UI Update
            document.querySelectorAll('.folder-item').forEach(el => {
                el.classList.toggle('active', el.dataset.filter === folder);
            });

            // Folder Name
            const names = {
                inbox: 'Inbox',
                outbox: 'Gesendet',
                archived: 'Archiv',
                all: 'Alle Nachrichten'
            };
            document.getElementById('current-folder-name').textContent = names[folder] || folder;

            // Clear detail
            showEmptyDetail();

            // Load messages
            loadMessages();

            // Mobile: Show messages panel
            document.querySelector('.panel-messages').classList.add('active');
        }

        // Load Messages
        async function loadMessages() {
            const list = document.getElementById('messages-list');
            list.innerHTML = '<div class="empty-state">Lade...</div>';

            try {
                let params = 'limit=500';  // Mehr Nachrichten laden
                if (currentFolder === 'inbox') params += '&direction=inbox';
                else if (currentFolder === 'outbox') params += '&direction=outbox';
                else if (currentFolder === 'archived') params += '&status=archived';
                // 'all' zeigt alle ohne Filter

                const data = await api.get(`/api/messages?${params}`);
                messages = data.messages || [];

                document.getElementById('message-count').textContent = `${messages.length} Nachrichten`;

                if (messages.length === 0) {
                    list.innerHTML = '<div class="empty-state">Keine Nachrichten</div>';
                    return;
                }

                list.innerHTML = messages.map(msg => `
                    <div class="message-item ${msg.status === 'unread' ? 'unread' : ''} ${msg.id === selectedMessageId ? 'active' : ''}"
                         data-id="${msg.id}" onclick="selectMessage(${msg.id})">
                        <div class="message-sender">
                            <span>${escapeHtml(currentFolder === 'outbox' ? msg.recipient : msg.sender)}</span>
                            <span class="message-time">${formatTime(msg.created_at)}</span>
                        </div>
                        <div class="message-subject">${escapeHtml(msg.subject || '(Kein Betreff)')}</div>
                        <div class="message-preview">${escapeHtml(msg.body?.substring(0, 80) || '')}</div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Load messages failed:', e);
                list.innerHTML = '<div class="empty-state">Fehler beim Laden</div>';
            }
        }

        // Select Message
        async function selectMessage(id) {
            selectedMessageId = id;

            // UI Update
            document.querySelectorAll('.message-item').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.id) === id);
            });

            const msg = messages.find(m => m.id === id);
            if (!msg) return;

            // Mark as read
            if (msg.status === 'unread') {
                try {
                    await api.put(`/api/messages/${id}/read`);
                    msg.status = 'read';
                    document.querySelector(`.message-item[data-id="${id}"]`)?.classList.remove('unread');
                    updateCounts();
                } catch (e) {
                    console.error('Mark read failed:', e);
                }
            }

            // Show detail
            showMessageDetail(msg);

            // Mobile: Show detail panel
            document.querySelector('.panel-detail').classList.add('active');
        }

        // Show Message Detail
        function showMessageDetail(msg) {
            const container = document.getElementById('detail-container');
            container.innerHTML = `
                <div class="detail-header">
                    <button class="mobile-back" onclick="showMessages()">‚Üê Zurueck</button>
                    <h3 class="detail-subject">${escapeHtml(msg.subject || '(Kein Betreff)')}</h3>
                    <div class="detail-meta">
                        <span class="detail-meta-label">Von:</span>
                        <span>${escapeHtml(msg.sender)}</span>
                        <span class="detail-meta-label">An:</span>
                        <span>${escapeHtml(msg.recipient)}</span>
                        <span class="detail-meta-label">Datum:</span>
                        <span>${formatDate(msg.created_at)}</span>
                        <span class="detail-meta-label">Status:</span>
                        <span>${msg.status}</span>
                    </div>
                </div>
                <div class="detail-body">${escapeHtml(msg.body || '')}</div>
                <div class="detail-actions">
                    <button class="btn btn-secondary" onclick="replyMessage(${msg.id})">Antworten</button>
                    <button class="btn btn-secondary" onclick="archiveMessage(${msg.id})">Archivieren</button>
                    <button class="btn btn-secondary" onclick="deleteMessage(${msg.id})">Loeschen</button>
                </div>
            `;
        }

        function showEmptyDetail() {
            document.getElementById('detail-container').innerHTML = `
                <div class="detail-empty">
                    <div class="detail-empty-icon">üì¨</div>
                    <p>Waehle eine Nachricht aus</p>
                </div>
            `;
        }

        // Counts
        async function updateCounts() {
            try {
                const [inbox, outbox, all] = await Promise.all([
                    api.get('/api/messages?direction=inbox&limit=1'),
                    api.get('/api/messages?direction=outbox&limit=1'),
                    api.get('/api/messages?limit=1')
                ]);

                document.getElementById('inbox-count').textContent = inbox.count || 0;
                document.getElementById('outbox-count').textContent = outbox.count || 0;
                document.getElementById('all-count').textContent = all.count || 0;

                // Unread count
                const unread = await api.get('/api/messages?status=unread&limit=1');
                const unreadCount = unread.count || 0;

                const inboxCountEl = document.getElementById('inbox-count');
                if (unreadCount > 0) {
                    inboxCountEl.classList.add('unread');
                    inboxCountEl.textContent = unreadCount;
                } else {
                    inboxCountEl.classList.remove('unread');
                }

            } catch (e) {
                console.error('Update counts failed:', e);
            }
        }

        // Load Partners
        async function loadPartners() {
            try {
                const data = await api.get('/api/partners');
                const list = document.getElementById('partner-list');

                if (data.partners && data.partners.length > 0) {
                    list.innerHTML = data.partners.slice(0, 5).map(p => `
                        <li class="folder-item" onclick="filterByPartner('${p.name}')">
                            <span><span class="folder-icon">üë§</span>${escapeHtml(p.name)}</span>
                        </li>
                    `).join('');
                } else {
                    list.innerHTML = '<li style="padding: 0.5rem; color: var(--text-muted); font-size: 0.75rem;">Keine Partner</li>';
                }
            } catch (e) {
                console.error('Load partners failed:', e);
            }
        }

        function filterByPartner(name) {
            // TODO: Filter by partner
            console.log('Filter by partner:', name);
        }

        // Actions
        function showCompose() {
            document.getElementById('compose-modal').classList.add('active');
        }

        function hideCompose() {
            document.getElementById('compose-modal').classList.remove('active');
        }

        async function sendMessage(e) {
            e.preventDefault();
            const form = e.target;

            const data = {
                recipient: form.recipient.value,
                subject: form.subject.value || null,
                body: form.body.value,
                priority: form.priority.value
            };

            if (!data.recipient) {
                alert('Bitte Empfaenger waehlen');
                return;
            }

            try {
                await api.post('/api/messages', data);
                hideCompose();
                form.reset();
                selectFolder('outbox');
            } catch (e) {
                alert('Senden fehlgeschlagen: ' + e.message);
            }
        }

        function refreshMessages() {
            loadMessages();
            updateCounts();
        }

        async function markAllRead() {
            try {
                // TODO: Batch mark read endpoint
                for (const msg of messages.filter(m => m.status === 'unread')) {
                    await api.put(`/api/messages/${msg.id}/read`);
                }
                loadMessages();
                updateCounts();
            } catch (e) {
                console.error('Mark all read failed:', e);
            }
        }

        function replyMessage(id) {
            const msg = messages.find(m => m.id === id);
            if (!msg) return;

            showCompose();
            document.getElementById('recipient-select').value = msg.sender;
            document.querySelector('input[name="subject"]').value = `Re: ${msg.subject || ''}`;
        }

        async function archiveMessage(id) {
            try {
                await api.put(`/api/messages/${id}/archive`);
                loadMessages();
                updateCounts();
                showEmptyDetail();
            } catch (e) {
                console.error('Archive failed:', e);
            }
        }

        async function deleteMessage(id) {
            if (!confirm('Nachricht wirklich loeschen?')) return;
            try {
                await api.put(`/api/messages/${id}/delete`);
                loadMessages();
                updateCounts();
                showEmptyDetail();
            } catch (e) {
                console.error('Delete failed:', e);
            }
        }

        // Mobile Navigation
        function showFolders() {
            document.querySelector('.panel-messages').classList.remove('active');
        }

        function showMessages() {
            document.querySelector('.panel-detail').classList.remove('active');
        }

        // Helpers
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[m]);
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const now = new Date();
            const isToday = d.toDateString() === now.toDateString();

            if (isToday) {
                return d.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
            }
            return d.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'});
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('de-DE') + ' ' + d.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMessages();
            updateCounts();
            loadPartners();

            // Status dot
            document.getElementById('status-dot').classList.add('online');
        });
    </script>
</body>
</html>
