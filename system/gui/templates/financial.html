<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - Finanzassistent</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .financial-content {
            padding: 1.5rem;
            width: 100%;
            margin: 0 auto;
        }

        .page-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.75rem;
        }

        .subtitle {
            color: var(--text-muted, #888);
            margin: 0 0 1.5rem 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card, #1e1e1e);
            border: 1px solid var(--border, #333);
            border-radius: 8px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--primary, #4fc3f7);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .stat-label {
            color: var(--text-muted, #888);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .stat-card.steuer {
            border-color: #4caf50;
        }

        .stat-card.steuer .stat-value {
            color: #4caf50;
        }

        .stat-card.cost {
            border-color: #ff9800;
        }

        .stat-card.cost .stat-value {
            color: #ff9800;
        }

        .stat-card.error {
            border-color: #f44336;
        }

        .stat-card.error .stat-value {
            color: #f44336;
            font-size: 1rem;
        }

        .section {
            background: var(--bg-card, #1e1e1e);
            border: 1px solid var(--border, #333);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color, #333);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color, #333);
        }

        .data-table th {
            background: var(--header-bg, #252525);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: var(--hover-bg, #2a2a2a);
        }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.neu {
            background: #2196f3;
            color: white;
        }

        .badge.verarbeitet {
            background: #4caf50;
            color: white;
        }

        .badge.exportiert {
            background: #9e9e9e;
            color: white;
        }

        .badge.steuer {
            background: #4caf50;
            color: white;
        }

        .badge.aktiv {
            background: #4caf50;
            color: white;
        }

        .badge.inaktiv {
            background: #f44336;
            color: white;
        }

        .badge.gmail {
            background: #ea4335;
            color: white;
        }

        .badge.imap {
            background: #2196f3;
            color: white;
        }

        .category-tag {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            background: var(--tag-bg, #333);
        }

        .subscription-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color, #333);
        }

        .subscription-card:last-child {
            border-bottom: none;
        }

        .sub-info h4 {
            margin: 0 0 0.25rem 0;
        }

        .sub-info .category {
            color: var(--text-muted, #888);
            font-size: 0.85rem;
        }

        .sub-price {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--accent-color, #4fc3f7);
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-primary {
            background: var(--accent-color, #4fc3f7);
            color: #000;
        }

        .btn-primary:hover {
            background: #81d4fa;
        }

        .btn-secondary {
            background: var(--border-color, #333);
            color: var(--text-color, #fff);
        }

        .btn-secondary:hover {
            background: #444;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar select,
        .filter-bar input[type="text"] {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color, #333);
            background: var(--input-bg, #2a2a2a);
            color: var(--text-color, #fff);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg, #1e1e1e);
            border: 1px solid var(--border-color, #333);
            border-radius: 8px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color, #333);
            border-radius: 4px;
            background: var(--input-bg, #2a2a2a);
            color: var(--text-color, #fff);
        }

        .form-group .hint {
            font-size: 0.8rem;
            color: var(--text-muted, #888);
            margin-top: 0.25rem;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .account-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color, #333);
        }

        .account-card:last-child {
            border-bottom: none;
        }

        .account-info h4 {
            margin: 0 0 0.25rem 0;
        }

        .account-info .email {
            color: var(--text-muted, #888);
            font-size: 0.9rem;
        }

        .account-actions {
            display: flex;
            gap: 0.5rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color, #333);
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-muted, #888);
        }

        .tab:hover {
            color: var(--text-color, #fff);
        }

        .tab.active {
            border-bottom-color: var(--accent-color, #4fc3f7);
            color: var(--accent-color, #4fc3f7);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <header class="main-header" id="main-header"></header>

    <main class="financial-content">
        <h1 class="page-title">Finanzassistent</h1>
        <p class="subtitle">Finanzdaten aus E-Mails sammeln und verarbeiten</p>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="overview">Uebersicht</div>
            <div class="tab" data-tab="emails">E-Mails</div>
            <div class="tab" data-tab="subscriptions">Abonnements</div>
            <div class="tab" data-tab="insurances">Versicherungen</div>
            <div class="tab" data-tab="bankkonten">Bankkonten</div>
            <div class="tab" data-tab="kredite">Kredite</div>
            <div class="tab" data-tab="profiles">Profile</div>
            <div class="tab" data-tab="accounts">E-Mail Konten</div>
            <div class="tab" data-tab="reports">Reports</div>
        </div>

        <!-- Tab: Uebersicht -->
        <div class="tab-content active" id="tab-overview">
            <div class="stats-grid" id="stats">
                <div class="stat-card">
                    <div class="stat-value" id="stat-accounts">-</div>
                    <div class="stat-label">E-Mail Konten</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-new">-</div>
                    <div class="stat-label">Neue E-Mails</div>
                </div>
                <div class="stat-card steuer">
                    <div class="stat-value" id="stat-steuer">-</div>
                    <div class="stat-label">Steuer-relevant</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-subs">-</div>
                    <div class="stat-label">Aktive Abos</div>
                </div>
                <div class="stat-card cost">
                    <div class="stat-value" id="stat-cost">-</div>
                    <div class="stat-label">Monatl. Kosten</div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="syncEmails()">Synchronisieren</button>
                <button class="btn btn-secondary" onclick="exportData()">JSON Export</button>
                <button class="btn btn-secondary" onclick="generateReport('monthly')">Report (Monat)</button>
                <button class="btn btn-secondary" onclick="showAddAccountModal()">+ Konto hinzufuegen</button>
                <button class="btn btn-secondary" onclick="showSettingsModal()">Einstellungen</button>
            </div>

            <div class="section">
                <h2>Letzte Erkennungen</h2>
                <div id="recent-emails">Lade...</div>
            </div>
        </div>

        <!-- Tab: E-Mails -->
        <div class="tab-content" id="tab-emails">
            <div class="section">
                <h2>Finanz-E-Mails</h2>
                <div class="filter-bar">
                    <select id="filter-category" onchange="loadEmails()">
                        <option value="">Alle Kategorien</option>
                        <option value="telekommunikation">Telekommunikation</option>
                        <option value="versicherung">Versicherung</option>
                        <option value="shopping">Shopping</option>
                        <option value="software">Software</option>
                        <option value="banking">Banking</option>
                        <option value="energie">Energie</option>
                    </select>
                    <label>
                        <input type="checkbox" id="filter-steuer" onchange="loadEmails()">
                        Nur Steuer-relevant
                    </label>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Anbieter</th>
                            <th>Betreff</th>
                            <th>Kategorie</th>
                            <th>Betrag</th>
                            <th>Datum</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="emails-body">
                        <tr>
                            <td colspan="6">Lade...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Abonnements -->
        <div class="tab-content" id="tab-subscriptions">
            <div class="section">
                <h2>
                    Abonnements & Vertraege
                    <button class="btn btn-primary btn-sm" onclick="showAddContractModal()">+ Neu</button>
                </h2>
                <div id="subscriptions">Lade...</div>
            </div>
        </div>

        <!-- Tab: Versicherungen (v1.1.73 - Claude/Gemini Kollaboration) -->
        <div class="tab-content" id="tab-insurances">
            <div class="section">
                <h2>
                    Versicherungen
                    <button class="btn btn-primary btn-sm" onclick="showAddInsuranceModal()">+ Neu</button>
                </h2>
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-ins-total">-</div>
                        <div class="stat-label">Versicherungen</div>
                    </div>
                    <div class="stat-card cost">
                        <div class="stat-value" id="stat-ins-yearly">-</div>
                        <div class="stat-label">Jahreskosten</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-ins-monthly">-</div>
                        <div class="stat-label">Monatlich</div>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Typ</th>
                            <th>Anbieter</th>
                            <th>Beitrag</th>
                            <th>Intervall</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="insurances-table">
                        <tr>
                            <td colspan="6">Lade Versicherungen...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Profile -->
        <div class="tab-content" id="tab-profiles">
            <div class="section">
                <h2>
                    Mail-Profile
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-sm" onclick="importProfiles()">Import</button>
                        <button class="btn btn-primary btn-sm" onclick="showAddProfileModal()">+ Neu</button>
                    </div>
                </h2>

                <!-- Test-Bereich -->
                <div
                    style="background: var(--bg-secondary, #252525); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 style="margin-top: 0; font-size: 1rem;">Profile testen</h3>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Absender</label>
                            <input type="text" id="test-sender" placeholder="z.B. noreply@amazon.de">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Betreff</label>
                            <input type="text" id="test-subject" placeholder="z.B. Ihre Rechnung">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                        <label>Body (optional)</label>
                        <textarea id="test-body" rows="2"
                            style="width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); padding: 0.5rem;"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="testProfile()">Testen</button>
                    <div id="test-result" style="margin-top: 1rem;"></div>
                </div>

                <!-- Falsch-Positive Bereich -->
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem;">Falsch-Positive (<span id="fp-count">0</span>)</h3>
                    <div id="false-positives-list"></div>
                </div>

                <!-- System-Profile -->
                <h3 style="font-size: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">
                    System-Profile</h3>
                <div id="system-profiles">Lade...</div>

                <!-- Eigene Profile -->
                <h3
                    style="font-size: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 1.5rem;">
                    Eigene Profile</h3>
                <div id="user-profiles">Keine eigenen Profile</div>
            </div>
        </div>

        <!-- Tab: Bankkonten (v1.1.84 - Task 783) -->
        <div class="tab-content" id="tab-bankkonten">
            <div class="section">
                <h2>
                    Bankkonten
                    <button class="btn btn-primary btn-sm" onclick="showAddBankAccountModal()">+ Neues Konto</button>
                </h2>
                <p class="subtitle" style="margin-top: -0.5rem;">Verwalte deine Bankkonten fuer die Finanzverwaltung</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Bank</th>
                            <th>IBAN</th>
                            <th>Typ</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="bankkonten-table">
                        <tr><td colspan="5">Lade Bankkonten...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Kredite (v1.1.85 - Credits Management) -->
        <div class="tab-content" id="tab-kredite">
            <div class="section">
                <h2>
                    Kredite & Darlehen
                    <button class="btn btn-primary btn-sm" onclick="showAddCreditModal()">+ Neuer Kredit</button>
                </h2>
                <p class="subtitle" style="margin-top: -0.5rem;">Verwalte deine Kredite, Darlehen und Ratenzahlungen</p>
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-credits-total">-</div>
                        <div class="stat-label">Aktive Kredite</div>
                    </div>
                    <div class="stat-card cost">
                        <div class="stat-value" id="stat-credits-remaining">-</div>
                        <div class="stat-label">Restschuld gesamt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-credits-monthly">-</div>
                        <div class="stat-label">Monatl. Raten</div>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Bank</th>
                            <th>Restschuld</th>
                            <th>Rate</th>
                            <th>Zinssatz</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="kredite-table">
                        <tr><td colspan="7">Lade Kredite...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: E-Mail Konten -->
        <div class="tab-content" id="tab-accounts">
            <div class="section">
                <h2>
                    E-Mail Konten
                    <button class="btn btn-primary btn-sm" onclick="showAddAccountModal()">+ Hinzufuegen</button>
                </h2>
                <div id="accounts-list">Lade...</div>
            </div>
        </div>
        <!-- Tab: Reports -->
        <div class="tab-content" id="tab-reports">
            <div class="section">
                <h2>ðŸ“Š Financial Report Generator</h2>
                <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
                    <p>Erstelle professionelle Berichte ueber deine Einnahmen, Ausgaben und Abonnements.</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem;">
                        <div>
                            <h3>Optionen</h3>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>Zeitraum</label>
                                <select id="report-period"
                                    style="width: 100%; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text);">
                                    <option value="current_month">Aktueller Monat</option>
                                    <option value="last_month">Letzter Monat</option>
                                    <option value="current_quarter">Aktuelles Quartal</option>
                                    <option value="current_year">Aktuelles Jahr</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>Format</label>
                                <select id="report-format"
                                    style="width: 100%; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text);">
                                    <option value="pdf">PDF (Interaktiv)</option>
                                    <option value="json">JSON (Rohdaten)</option>
                                    <option value="csv">CSV (Excel-kompatibel)</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" onclick="generateReportFromTab()">Report
                                    generieren</button>
                                <button class="btn btn-secondary" onclick="previewReport()">Vorschau</button>
                            </div>
                        </div>
                        <div id="report-preview-pane"
                            style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; border: 1px solid var(--border);">
                            <h4 style="margin-top:0;">Vorschau</h4>
                            <div id="report-preview-content" style="font-size: 0.85rem; color: var(--text-muted);">
                                Waehle Optionen und klicke auf Vorschau...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>Verfuegbare Berichte</h3>
                    <div id="available-reports-list">
                        <div class="empty-state">Noch keine Berichte generiert.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Einstellungen -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h3>Sync-Einstellungen</h3>
            <form id="settings-form" onsubmit="saveSettings(event)">
                <div class="form-group">
                    <label>Datumsbereich (Tage in die Vergangenheit)</label>
                    <input type="number" id="setting-date-range" min="7" max="365" value="90">
                    <div class="hint">Wie weit zurueck sollen E-Mails durchsucht werden? (7-365 Tage)</div>
                </div>
                <div class="form-group">
                    <label>Max. E-Mails pro Sync</label>
                    <input type="number" id="setting-max-emails" min="10" max="500" value="50">
                    <div class="hint">Maximal verarbeitete E-Mails pro Synchronisierung (10-500)</div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="setting-auto-extract" checked>
                        Automatische Datenextraktion
                    </label>
                    <div class="hint">Betraege und Rechnungsnummern automatisch aus E-Mails extrahieren</div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Profil hinzufuegen/bearbeiten -->
    <div class="modal" id="profile-modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="profile-modal-title">Neues Profil</h3>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <input type="hidden" id="profile-edit-id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>ID *</label>
                        <input type="text" id="profile-id" required placeholder="z.B. amazon_rechnung">
                    </div>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="profile-name" required placeholder="z.B. Amazon Rechnungen">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Kategorie</label>
                        <select id="profile-category">
                            <option value="sonstiges">Sonstiges</option>
                            <option value="shopping">Shopping</option>
                            <option value="telekommunikation">Telekommunikation</option>
                            <option value="versicherung">Versicherung</option>
                            <option value="software">Software</option>
                            <option value="banking">Banking</option>
                            <option value="energie">Energie</option>
                            <option value="streaming">Streaming</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Typ</label>
                        <select id="profile-type">
                            <option value="rechnung">Rechnung</option>
                            <option value="abo">Abonnement</option>
                            <option value="bestaetigung">Bestaetigung</option>
                            <option value="kontoauszug">Kontoauszug</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Sender-Patterns (ein Pattern pro Zeile)</label>
                    <textarea id="profile-sender" rows="2" placeholder="amazon.de&#10;amazon.com"
                        style="width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); padding: 0.5rem;"></textarea>
                </div>
                <div class="form-group">
                    <label>Subject-Patterns (ein Pattern pro Zeile)</label>
                    <textarea id="profile-subject" rows="2" placeholder="Rechnung&#10;Invoice&#10;Bestellung"
                        style="width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); padding: 0.5rem;"></textarea>
                </div>
                <div class="form-group">
                    <label>Blacklist (Begriffe die NICHT vorkommen duerfen)</label>
                    <textarea id="profile-blacklist" rows="2" placeholder="Werbung&#10;Angebot&#10;Deal"
                        style="width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); padding: 0.5rem;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <label><input type="checkbox" id="profile-steuer"> Steuer-relevant</label>
                    <label><input type="checkbox" id="profile-recurring"> Wiederkehrend (Abo)</label>
                    <label><input type="checkbox" id="profile-enabled" checked> Aktiv</label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: False-Positive markieren -->
    <div class="modal" id="fp-modal">
        <div class="modal-content">
            <h3>Als Falsch-Positiv markieren</h3>
            <form id="fp-form" onsubmit="saveFalsePositive(event)">
                <input type="hidden" id="fp-message-id">
                <div class="form-group">
                    <label>Absender</label>
                    <input type="text" id="fp-sender" readonly>
                </div>
                <div class="form-group">
                    <label>Betreff</label>
                    <input type="text" id="fp-subject" readonly>
                </div>
                <div class="form-group">
                    <label>Grund (optional)</label>
                    <input type="text" id="fp-reason" placeholder="z.B. Werbung, kein Finanz-Mail">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="fp-add-blacklist"> Begriffe zur Blacklist hinzufuegen</label>
                    <div id="fp-blacklist-options" style="display: none; margin-top: 0.5rem;">
                        <input type="text" id="fp-blacklist-terms" placeholder="Begriffe kommasepariert">
                        <div class="hint">Diese Begriffe werden bei zukuenftigen Mails blockiert</div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFpModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-danger">Als Falsch-Positiv markieren</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Konto hinzufuegen -->
    <div class="modal" id="add-account-modal">
        <div class="modal-content">
            <h3>E-Mail Konto hinzufuegen</h3>
            <form id="add-account-form" onsubmit="addAccount(event)">
                <div class="form-group">
                    <label>E-Mail Adresse *</label>
                    <input type="email" id="acc-email" required placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>Konto-Name</label>
                    <input type="text" id="acc-name" placeholder="z.B. Privat, Geschaeftlich">
                </div>
                <div class="form-group">
                    <label>Zugangsart</label>
                    <select id="acc-provider" onchange="updateProviderFields()">
                        <option value="imap">IMAP (Standard)</option>
                        <option value="gmail_api">Gmail API (OAuth2)</option>
                    </select>
                </div>
                <div id="imap-fields">
                    <div class="form-group">
                        <label>Passwort *</label>
                        <input type="password" id="acc-password">
                        <div class="hint" id="password-hint">Bei Gmail: App-Passwort verwenden</div>
                    </div>
                    <div class="form-group">
                        <label>IMAP Server</label>
                        <input type="text" id="acc-host" placeholder="Automatisch erkannt">
                    </div>
                    <div class="form-group">
                        <label>IMAP Port</label>
                        <input type="number" id="acc-port" value="993">
                    </div>
                </div>
                <div id="gmail-api-fields" style="display: none;">
                    <div class="form-group">
                        <div class="hint">
                            Gmail API verwendet OAuth2. Nach dem Speichern oeffnet sich ein Browser-Fenster zur
                            Autorisierung.<br><br>
                            Voraussetzung: <code>credentials.json</code> aus Google Cloud Console
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Versicherung verwalten (Task #570) -->
    <div class="modal" id="insurance-modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="insurance-modal-title">Versicherung verwalten</h3>
            <form id="insurance-form" onsubmit="saveInsurance(event)">
                <input type="hidden" id="ins-edit-id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Anbieter *</label>
                        <input type="text" id="ins-anbieter" required>
                    </div>
                    <div class="form-group">
                        <label>Sparte *</label>
                        <select id="ins-sparte">
                            <option value="Haftpflicht">Haftpflicht</option>
                            <option value="KFZ">KFZ</option>
                            <option value="Hausrat">Hausrat</option>
                            <option value="BU">Berufsunfaehigkeit</option>
                            <option value="Rechtsschutz">Rechtsschutz</option>
                            <option value="Unfall">Unfall</option>
                            <option value="Kranken">Kranken</option>
                            <option value="Leben">Lebensversicherung</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tarif Name</label>
                    <input type="text" id="ins-tarif_name">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Beitrag (â‚¬)</label>
                        <input type="number" step="0.01" id="ins-beitrag">
                    </div>
                    <div class="form-group">
                        <label>Zahlweise</label>
                        <select id="ins-zahlweise">
                            <option value="monatlich">monatlich</option>
                            <option value="quartalsweise">quartalsweise</option>
                            <option value="jaehrlich">jaehrlich</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Beginn Datum</label>
                        <input type="date" id="ins-beginn_datum">
                    </div>
                    <div class="form-group">
                        <label>Ablauf Datum</label>
                        <input type="date" id="ins-ablauf_datum">
                    </div>
                </div>
                <div class="form-group">
                    <label>Police-Nr.</label>
                    <input type="text" id="ins-police_nr">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeInsuranceModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Abonnement/Vertrag verwalten (Task #573) -->
    <div class="modal" id="contract-modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="contract-modal-title">Vertrag/Abo verwalten</h3>
            <form id="contract-form" onsubmit="saveContract(event)">
                <input type="hidden" id="contract-edit-id">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="contract-name" required placeholder="z.B. Netflix, Fitnessstudio">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Anbieter</label>
                        <input type="text" id="contract-anbieter">
                    </div>
                    <div class="form-group">
                        <label>Kategorie</label>
                        <select id="contract-kategorie">
                            <option value="streaming">Streaming</option>
                            <option value="software">Software (SaaS)</option>
                            <option value="fitness">Sport/Fitness</option>
                            <option value="telekommunikation">Internet/Mobilfunk</option>
                            <option value="energie">Strom/Gas</option>
                            <option value="wohnen">Miete/Wohnen</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Betrag (â‚¬)</label>
                        <input type="number" step="0.01" id="contract-betrag">
                    </div>
                    <div class="form-group">
                        <label>Intervall</label>
                        <select id="contract-intervall">
                            <option value="monatlich">monatlich</option>
                            <option value="quartalsweise">quartalsweise</option>
                            <option value="jaehrlich">jaehrlich</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Naechste Zahlung</label>
                    <input type="date" id="contract-naechste_zahlung">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeContractModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: E-Mail Inhalt (Task 483) -->
    <div class="modal" id="email-modal">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <h3 id="email-view-subject">E-Mail Details</h3>
                <button class="btn btn-secondary btn-sm" onclick="closeEmailModal()">Schliessen</button>
            </div>
            <div id="email-view-meta"
                style="font-size: 0.85rem; color: var(--text-muted); padding-bottom: 1rem; border-bottom: 1px solid var(--border-color, #333);">
                <!-- Metadaten hier -->
            </div>
            <div id="email-view-body"
                style="margin-top: 1.5rem; max-height: 500px; overflow-y: auto; background: #000; padding: 1rem; border-radius: 4px; font-family: monospace; white-space: pre-wrap; font-size: 0.9rem; color: #fff;">
                <!-- Inhalt hier -->
            </div>
        </div>
    </div>

    <!-- Modal: Bankkonto verwalten (v1.1.84 - Task 783) -->
    <div class="modal" id="bankkonto-modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="bankkonto-modal-title">Neues Bankkonto</h3>
            <form id="bankkonto-form" onsubmit="saveBankAccount(event)">
                <input type="hidden" id="bank-edit-id">
                <div class="form-group">
                    <label>Kontoname *</label>
                    <input type="text" id="bank-name" required placeholder="z.B. Girokonto, Sparkonto">
                </div>
                <div class="form-group">
                    <label>Bank/Institut *</label>
                    <input type="text" id="bank-bank_name" required placeholder="z.B. Sparkasse, DKB">
                </div>
                <div class="form-group">
                    <label>IBAN</label>
                    <input type="text" id="bank-iban" placeholder="DE89 3704 0044 0532 0130 00">
                </div>
                <div class="form-group">
                    <label>BIC</label>
                    <input type="text" id="bank-bic" placeholder="COBADEFFXXX">
                </div>
                <div class="form-group">
                    <label>Kontoart</label>
                    <select id="bank-account_type">
                        <option value="girokonto">Girokonto</option>
                        <option value="sparkonto">Sparkonto</option>
                        <option value="tagesgeld">Tagesgeld</option>
                        <option value="festgeld">Festgeld</option>
                        <option value="depot">Depot</option>
                        <option value="kreditkarte">Kreditkarte</option>
                        <option value="sonstige">Sonstige</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notizen</label>
                    <textarea id="bank-notes" rows="2"
                        style="width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); padding: 0.5rem;"
                        placeholder="Optionale Notizen zum Konto"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBankAccountModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Kredit verwalten (v1.1.85 - Credits Management) -->
    <div class="modal" id="kredit-modal">
        <div class="modal-content" style="max-width: 550px;">
            <h3 id="kredit-modal-title">Neuer Kredit</h3>
            <form id="kredit-form" onsubmit="saveCredit(event)">
                <input type="hidden" id="credit-edit-id">
                <div class="form-group">
                    <label>Bezeichnung *</label>
                    <input type="text" id="credit-name" required placeholder="z.B. Autokredit, Immobiliendarlehen">
                </div>
                <div class="form-group">
                    <label>Verwendungszweck</label>
                    <input type="text" id="credit-purpose" placeholder="z.B. Autokauf, Renovierung">
                </div>
                <div class="form-group">
                    <label>Bank/Kreditgeber *</label>
                    <input type="text" id="credit-bank_name" required placeholder="z.B. Sparkasse, Santander">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Ursprungsbetrag (EUR)</label>
                        <input type="number" step="0.01" id="credit-original_amount" placeholder="10000.00">
                    </div>
                    <div class="form-group">
                        <label>Restschuld (EUR)</label>
                        <input type="number" step="0.01" id="credit-remaining_amount" placeholder="5000.00">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Zinssatz (%)</label>
                        <input type="number" step="0.01" id="credit-interest_rate" placeholder="3.5">
                    </div>
                    <div class="form-group">
                        <label>Monatliche Rate (EUR)</label>
                        <input type="number" step="0.01" id="credit-payment_amount" placeholder="250.00">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Startdatum</label>
                        <input type="date" id="credit-start_date">
                    </div>
                    <div class="form-group">
                        <label>Enddatum</label>
                        <input type="date" id="credit-end_date">
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="credit-status">
                        <option value="active">Aktiv (laufend)</option>
                        <option value="paid_off">Abbezahlt</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notizen</label>
                    <textarea id="credit-notes" rows="2"
                        style="width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); padding: 0.5rem;"
                        placeholder="Optionale Notizen zum Kredit"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreditModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api/financial';
        let apiError = false;

        // Tab-Navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

                // Daten laden
                if (tab.dataset.tab === 'emails') loadEmails();
                if (tab.dataset.tab === 'subscriptions') loadSubscriptions();
                if (tab.dataset.tab === 'insurances') loadInsurances();
                if (tab.dataset.tab === 'bankkonten') loadBankAccounts();
                if (tab.dataset.tab === 'kredite') loadCredits();
                if (tab.dataset.tab === 'profiles') loadProfiles();
                if (tab.dataset.tab === 'accounts') loadAccounts();
            });
        });

        function showError(message) {
            const statsGrid = document.getElementById('stats');
            statsGrid.innerHTML = `
                <div class="stat-card error" style="grid-column: span 5;">
                    <div class="stat-value">${message}</div>
                    <div class="stat-label">Datenbank-Tabellen moeglicherweise nicht initialisiert</div>
                </div>
            `;
        }

        async function loadStatus() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();

                // Check for API error
                if (data.error) {
                    apiError = true;
                    showError(data.error);
                    document.getElementById('recent-emails').innerHTML =
                        '<p>Datenbank nicht initialisiert. Bitte zuerst ein E-Mail-Konto hinzufuegen.</p>';
                    return;
                }

                apiError = false;
                document.getElementById('stat-accounts').textContent = data.accounts || 0;
                document.getElementById('stat-new').textContent = data.new_emails || 0;
                document.getElementById('stat-steuer').textContent = data.steuer_relevant || 0;
                document.getElementById('stat-subs').textContent = data.active_subscriptions || 0;
                document.getElementById('stat-cost').textContent =
                    (data.monthly_subscription_cost || 0).toFixed(2) + ' EUR';

                // Letzte E-Mails laden
                loadRecentEmails();
            } catch (e) {
                console.error('Status-Fehler:', e);
                showError('API nicht erreichbar');
            }
        }

        async function loadRecentEmails() {
            const container = document.getElementById('recent-emails');

            if (apiError) {
                container.innerHTML = '<p>Datenbank nicht initialisiert</p>';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/emails?limit=5`);
                const data = await res.json();

                if (!data.emails || data.emails.length === 0) {
                    container.innerHTML = '<p>Keine E-Mails vorhanden. Fuege zuerst ein E-Mail-Konto hinzu und starte die Synchronisierung.</p>';
                    return;
                }

                container.innerHTML = data.emails.map(e => `
                    <div class="subscription-card">
                        <div class="sub-info">
                            <h4>${e.provider_name || 'Unbekannt'} ${e.steuer_relevant ? '<span class="badge steuer">Steuer</span>' : ''}</h4>
                            <div class="category">${e.subject ? e.subject.substring(0, 60) : '-'}</div>
                        </div>
                        <div class="sub-price">${e.betrag ? e.betrag.toFixed(2) + ' EUR' : '-'}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Recent-Fehler:', e);
                container.innerHTML = '<p>Fehler beim Laden der E-Mails</p>';
            }
        }

        async function loadEmails() {
            const category = document.getElementById('filter-category').value;
            const steuerOnly = document.getElementById('filter-steuer').checked;

            let url = `${API_BASE}/emails?limit=50`;
            if (category) url += `&category=${category}`;
            if (steuerOnly) url += `&steuer_only=true`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                const tbody = document.getElementById('emails-body');

                if (!data.emails || data.emails.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">Keine E-Mails gefunden</td></tr>';
                    return;
                }

                tbody.innerHTML = data.emails.map(email => `
                    <tr ondblclick="showEmailContent(${email.id})" style="cursor: pointer;" title="Doppelklick fuer Inhalt">
                        <td>
                            <strong>${email.provider_name}</strong>
                            ${email.steuer_relevant ? '<span class="badge steuer">Steuer</span>' : ''}
                        </td>
                        <td>${email.subject ? email.subject.substring(0, 50) + '...' : '-'}</td>
                        <td><span class="category-tag">${email.category}</span></td>
                        <td>${email.betrag ? email.betrag.toFixed(2) + ' EUR' : '-'}</td>
                        <td>${email.email_date ? new Date(email.email_date).toLocaleDateString('de-DE') : '-'}</td>
                        <td>
                            <span class="badge ${email.status}">${email.status}</span>
                            <button class="btn btn-sm" style="margin-left: 0.25rem; padding: 0.1rem 0.3rem; font-size: 0.65rem; background: #666;" onclick="showFpModal('${email.message_id || email.id || ''}', '${(email.sender || '').replace(/'/g, '')}', '${(email.subject || '').replace(/'/g, '')}')">FP</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Emails-Fehler:', e);
            }
        }

        async function loadSubscriptions() {
            try {
                const container = document.getElementById('subscriptions');
                let html = '';

                // 1. Contracts aus fin_contracts laden (neue Tabelle)
                try {
                    const cRes = await fetch(`${API_BASE}/contracts`);
                    const cData = await cRes.json();
                    if (cData.contracts && cData.contracts.length > 0) {
                        html += '<h3 style="margin-bottom:0.5rem;">Vertraege (fin_contracts)</h3>';
                        html += cData.contracts.map(c => `
                            <div class="subscription-card">
                                <div class="sub-info">
                                    <h4>${c.name || c.anbieter}</h4>
                                    <div class="category">${c.kategorie || '-'} | ${c.intervall || '-'}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="sub-price">${c.betrag ? c.betrag.toFixed(2) : '?'} ${c.waehrung || 'EUR'}</div>
                                    <div style="font-size:0.75rem;color:var(--text-muted);">Naechste: ${c.naechste_zahlung || '-'}</div>
                                    <div style="display: flex; gap: 0.25rem;">
                                        <button class="btn btn-sm btn-secondary" onclick="editContract(${c.id})">Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteContract(${c.id})">X</button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (e) { console.log('Contracts nicht verfuegbar'); }

                // 2. Alte Subscriptions laden (fallback)
                const res = await fetch(`${API_BASE}/subscriptions`);
                const data = await res.json();
                if (data.subscriptions && data.subscriptions.length > 0) {
                    html += '<h3 style="margin:1rem 0 0.5rem;">Erkannte Abos (E-Mail)</h3>';
                    html += data.subscriptions.map(sub => `
                        <div class="subscription-card">
                            <div class="sub-info">
                                <h4>${sub.provider_name}</h4>
                                <div class="category">${sub.category} ${sub.steuer_relevant ? '- Steuer-relevant' : ''}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1.5rem;">
                                <div class="sub-price">${sub.betrag_monatlich ? sub.betrag_monatlich.toFixed(2) : '?'} EUR/Mo</div>
                                <button class="btn btn-danger btn-sm" onclick="deleteSubscription(${sub.id})">Loeschen</button>
                            </div>
                        </div>
                    `).join('');
                }

                container.innerHTML = html || '<p>Keine Abonnements gefunden</p>';
            } catch (e) {
                console.error('Subscriptions-Fehler:', e);
            }
        }

        async function loadInsurances() {
            try {
                const res = await fetch(`${API_BASE}/insurances`);
                const data = await res.json();
                const tbody = document.getElementById('insurances-table');

                // Stats aktualisieren
                document.getElementById('stat-ins-total').textContent = data.count || 0;
                const yearly = data.yearly_cost || 0;
                document.getElementById('stat-ins-yearly').textContent = yearly.toFixed(2) + ' EUR';
                document.getElementById('stat-ins-monthly').textContent = (yearly / 12).toFixed(2) + ' EUR';

                if (!data.insurances || data.insurances.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">Keine Versicherungen gefunden</td></tr>';
                    return;
                }

                tbody.innerHTML = data.insurances.map(ins => `
                    <tr>
                        <td>${ins.tarif_name || '-'}</td>
                        <td>${ins.sparte || '-'}</td>
                        <td>${ins.anbieter || '-'}</td>
                        <td>${ins.beitrag ? ins.beitrag.toFixed(2) + ' EUR' : '-'}</td>
                        <td>${ins.zahlweise || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editInsurance(${ins.id})">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteInsurance(${ins.id})">Loeschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Insurances-Fehler:', e);
            }
        }

        // â”€â”€â”€ Insurance Functions (Task #570) â”€â”€â”€

        function showAddInsuranceModal() {
            document.getElementById('insurance-modal-title').textContent = 'Neue Versicherung';
            document.getElementById('insurance-form').reset();
            document.getElementById('ins-edit-id').value = '';
            document.getElementById('insurance-modal').classList.add('active');
        }

        function closeInsuranceModal() {
            document.getElementById('insurance-modal').classList.remove('active');
        }

        async function editInsurance(id) {
            try {
                const res = await fetch(`${API_BASE}/insurances`);
                const data = await res.json();
                const ins = data.insurances.find(i => i.id === id);
                if (!ins) return;

                document.getElementById('insurance-modal-title').textContent = 'Versicherung bearbeiten';
                document.getElementById('ins-edit-id').value = id;
                document.getElementById('ins-anbieter').value = ins.anbieter || '';
                document.getElementById('ins-sparte').value = ins.sparte || 'Haftpflicht';
                document.getElementById('ins-tarif_name').value = ins.tarif_name || '';
                document.getElementById('ins-beitrag').value = ins.beitrag || 0;
                document.getElementById('ins-zahlweise').value = ins.zahlweise || 'monatlich';
                document.getElementById('ins-beginn_datum').value = ins.beginn_datum || '';
                document.getElementById('ins-ablauf_datum').value = ins.ablauf_datum || '';
                document.getElementById('ins-police_nr').value = ins.police_nr || '';

                document.getElementById('insurance-modal').classList.add('active');
            } catch (e) { console.error(e); }
        }

        async function saveInsurance(event) {
            event.preventDefault();
            const id = document.getElementById('ins-edit-id').value;
            const data = {
                anbieter: document.getElementById('ins-anbieter').value,
                sparte: document.getElementById('ins-sparte').value,
                tarif_name: document.getElementById('ins-tarif_name').value,
                beitrag: parseFloat(document.getElementById('ins-beitrag').value) || 0,
                zahlweise: document.getElementById('ins-zahlweise').value,
                beginn_datum: document.getElementById('ins-beginn_datum').value || null,
                ablauf_datum: document.getElementById('ins-ablauf_datum').value || null,
                police_nr: document.getElementById('ins-police_nr').value || ''
            };

            try {
                const url = id ? `${API_BASE}/insurances/${id}` : `${API_BASE}/insurances`;
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if ((await res.json()).success) {
                    closeInsuranceModal();
                    loadInsurances();
                }
            } catch (e) { alert('Fehler beim Speichern'); }
        }

        async function deleteInsurance(id) {
            if (!confirm('Versicherung wirklich loeschen?')) return;
            try {
                const res = await fetch(`${API_BASE}/insurances/${id}`, { method: 'DELETE' });
                if ((await res.json()).success) loadInsurances();
            } catch (e) { console.error(e); }
        }

        // â”€â”€â”€ Bank Account Functions (v1.1.84 - Task 783) â”€â”€â”€

        async function loadBankAccounts() {
            try {
                const res = await fetch(`${API_BASE}/bank-accounts`);
                const data = await res.json();
                const tbody = document.getElementById('bankkonten-table');

                if (!data.accounts || data.accounts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">Keine Bankkonten hinterlegt. Klicke auf "+ Neues Konto" um ein Konto hinzuzufuegen.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.accounts.map(acc => `
                    <tr>
                        <td><strong>${acc.name || '-'}</strong></td>
                        <td>${acc.bank_name || '-'}</td>
                        <td><code style="font-size: 0.85rem;">${acc.iban ? acc.iban.replace(/(.{4})/g, '$1 ').trim() : '-'}</code></td>
                        <td><span class="badge">${acc.account_type || 'girokonto'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editBankAccount(${acc.id})">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBankAccount(${acc.id})">Loeschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('BankAccounts-Fehler:', e);
                document.getElementById('bankkonten-table').innerHTML = '<tr><td colspan="5">Fehler beim Laden der Bankkonten</td></tr>';
            }
        }

        function showAddBankAccountModal() {
            document.getElementById('bankkonto-modal-title').textContent = 'Neues Bankkonto';
            document.getElementById('bankkonto-form').reset();
            document.getElementById('bank-edit-id').value = '';
            document.getElementById('bankkonto-modal').classList.add('active');
        }

        function closeBankAccountModal() {
            document.getElementById('bankkonto-modal').classList.remove('active');
        }

        async function editBankAccount(id) {
            try {
                const res = await fetch(`${API_BASE}/bank-accounts`);
                const data = await res.json();
                const acc = data.accounts.find(a => a.id === id);
                if (!acc) return;

                document.getElementById('bankkonto-modal-title').textContent = 'Bankkonto bearbeiten';
                document.getElementById('bank-edit-id').value = id;
                document.getElementById('bank-name').value = acc.name || '';
                document.getElementById('bank-bank_name').value = acc.bank_name || '';
                document.getElementById('bank-iban').value = acc.iban || '';
                document.getElementById('bank-bic').value = acc.bic || '';
                document.getElementById('bank-account_type').value = acc.account_type || 'girokonto';
                document.getElementById('bank-notes').value = acc.notes || '';

                document.getElementById('bankkonto-modal').classList.add('active');
            } catch (e) { console.error(e); }
        }

        async function saveBankAccount(event) {
            event.preventDefault();
            const id = document.getElementById('bank-edit-id').value;
            const data = {
                name: document.getElementById('bank-name').value,
                bank_name: document.getElementById('bank-bank_name').value,
                iban: document.getElementById('bank-iban').value.replace(/\s/g, ''),
                bic: document.getElementById('bank-bic').value,
                account_type: document.getElementById('bank-account_type').value,
                notes: document.getElementById('bank-notes').value
            };

            try {
                const url = id ? `${API_BASE}/bank-accounts/${id}` : `${API_BASE}/bank-accounts`;
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if ((await res.json()).success) {
                    closeBankAccountModal();
                    loadBankAccounts();
                }
            } catch (e) { alert('Fehler beim Speichern'); }
        }

        async function deleteBankAccount(id) {
            if (!confirm('Bankkonto wirklich loeschen?')) return;
            try {
                const res = await fetch(`${API_BASE}/bank-accounts/${id}`, { method: 'DELETE' });
                if ((await res.json()).success) loadBankAccounts();
            } catch (e) { console.error(e); }
        }

        // â”€â”€â”€ Credit Functions (v1.1.85 - Credits Management) â”€â”€â”€

        async function loadCredits() {
            try {
                const res = await fetch(`${API_BASE}/credits`);
                const data = await res.json();
                const tbody = document.getElementById('kredite-table');

                // Stats aktualisieren
                const activeCredits = data.credits ? data.credits.filter(c => c.status === 'active') : [];
                document.getElementById('stat-credits-total').textContent = activeCredits.length;

                const totalRemaining = activeCredits.reduce((sum, c) => sum + (c.remaining_amount || 0), 0);
                document.getElementById('stat-credits-remaining').textContent = totalRemaining.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});

                const monthlyPayments = activeCredits.reduce((sum, c) => sum + (c.payment_amount || 0), 0);
                document.getElementById('stat-credits-monthly').textContent = monthlyPayments.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});

                if (!data.credits || data.credits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">Keine Kredite hinterlegt. Klicke auf "+ Neuer Kredit" um einen Kredit hinzuzufuegen.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.credits.map(credit => `
                    <tr>
                        <td><strong>${credit.name || '-'}</strong>${credit.purpose ? '<br><small style="color: var(--text-muted);">' + credit.purpose + '</small>' : ''}</td>
                        <td>${credit.bank_name || '-'}</td>
                        <td><strong>${credit.remaining_amount ? credit.remaining_amount.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'}) : '-'}</strong></td>
                        <td>${credit.payment_amount ? credit.payment_amount.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'}) + '/Monat' : '-'}</td>
                        <td>${credit.interest_rate ? credit.interest_rate + ' %' : '-'}</td>
                        <td><span class="badge ${credit.status === 'active' ? 'aktiv' : 'inaktiv'}">${credit.status === 'active' ? 'Laufend' : 'Abbezahlt'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editCredit(${credit.id})">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCredit(${credit.id})">Loeschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Credits-Fehler:', e);
                document.getElementById('kredite-table').innerHTML = '<tr><td colspan="7">Fehler beim Laden der Kredite</td></tr>';
            }
        }

        function showAddCreditModal() {
            document.getElementById('kredit-modal-title').textContent = 'Neuer Kredit';
            document.getElementById('kredit-form').reset();
            document.getElementById('credit-edit-id').value = '';
            document.getElementById('kredit-modal').classList.add('active');
        }

        function closeCreditModal() {
            document.getElementById('kredit-modal').classList.remove('active');
        }

        async function editCredit(id) {
            try {
                const res = await fetch(`${API_BASE}/credits`);
                const data = await res.json();
                const credit = data.credits.find(c => c.id === id);
                if (!credit) return;

                document.getElementById('kredit-modal-title').textContent = 'Kredit bearbeiten';
                document.getElementById('credit-edit-id').value = id;
                document.getElementById('credit-name').value = credit.name || '';
                document.getElementById('credit-purpose').value = credit.purpose || '';
                document.getElementById('credit-bank_name').value = credit.bank_name || '';
                document.getElementById('credit-original_amount').value = credit.original_amount || '';
                document.getElementById('credit-remaining_amount').value = credit.remaining_amount || '';
                document.getElementById('credit-interest_rate').value = credit.interest_rate || '';
                document.getElementById('credit-payment_amount').value = credit.payment_amount || '';
                document.getElementById('credit-start_date').value = credit.start_date || '';
                document.getElementById('credit-end_date').value = credit.end_date || '';
                document.getElementById('credit-status').value = credit.status || 'active';
                document.getElementById('credit-notes').value = credit.notes || '';

                document.getElementById('kredit-modal').classList.add('active');
            } catch (e) { console.error(e); }
        }

        async function saveCredit(event) {
            event.preventDefault();
            const id = document.getElementById('credit-edit-id').value;
            const data = {
                name: document.getElementById('credit-name').value,
                purpose: document.getElementById('credit-purpose').value,
                bank_name: document.getElementById('credit-bank_name').value,
                original_amount: parseFloat(document.getElementById('credit-original_amount').value) || null,
                remaining_amount: parseFloat(document.getElementById('credit-remaining_amount').value) || null,
                interest_rate: parseFloat(document.getElementById('credit-interest_rate').value) || null,
                payment_amount: parseFloat(document.getElementById('credit-payment_amount').value) || null,
                start_date: document.getElementById('credit-start_date').value || null,
                end_date: document.getElementById('credit-end_date').value || null,
                status: document.getElementById('credit-status').value,
                notes: document.getElementById('credit-notes').value
            };

            try {
                const url = id ? `${API_BASE}/credits/${id}` : `${API_BASE}/credits`;
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if ((await res.json()).success) {
                    closeCreditModal();
                    loadCredits();
                }
            } catch (e) { alert('Fehler beim Speichern'); }
        }

        async function deleteCredit(id) {
            if (!confirm('Kredit wirklich loeschen?')) return;
            try {
                const res = await fetch(`${API_BASE}/credits/${id}`, { method: 'DELETE' });
                if ((await res.json()).success) loadCredits();
            } catch (e) { console.error(e); }
        }

        // â”€â”€â”€ Contract Functions (Task #573) â”€â”€â”€

        function showAddContractModal() {
            document.getElementById('contract-modal-title').textContent = 'Neuer Vertrag/Abo';
            document.getElementById('contract-form').reset();
            document.getElementById('contract-edit-id').value = '';
            document.getElementById('contract-modal').classList.add('active');
        }

        function closeContractModal() {
            document.getElementById('contract-modal').classList.remove('active');
        }

        async function editContract(id) {
            try {
                const res = await fetch(`${API_BASE}/financial/contracts`);
                const data = await res.json();
                const c = data.contracts.find(i => i.id === id);
                if (!c) return;

                document.getElementById('contract-modal-title').textContent = 'Vertrag bearbeiten';
                document.getElementById('contract-edit-id').value = id;
                document.getElementById('contract-name').value = c.name || '';
                document.getElementById('contract-anbieter').value = c.anbieter || '';
                document.getElementById('contract-kategorie').value = c.kategorie || 'sonstiges';
                document.getElementById('contract-betrag').value = c.betrag || 0;
                document.getElementById('contract-intervall').value = c.intervall || 'monatlich';
                document.getElementById('contract-naechste_zahlung').value = c.naechste_zahlung || '';

                document.getElementById('contract-modal').classList.add('active');
            } catch (e) { console.error(e); }
        }

        async function saveContract(event) {
            event.preventDefault();
            const id = document.getElementById('contract-edit-id').value;
            const data = {
                name: document.getElementById('contract-name').value,
                anbieter: document.getElementById('contract-anbieter').value,
                kategorie: document.getElementById('contract-kategorie').value,
                betrag: parseFloat(document.getElementById('contract-betrag').value) || 0,
                intervall: document.getElementById('contract-intervall').value,
                naechste_zahlung: document.getElementById('contract-naechste_zahlung').value || null
            };

            try {
                const url = id ? `${API_BASE}/financial/contracts/${id}` : `${API_BASE}/financial/contracts`;
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if ((await res.json()).success) {
                    closeContractModal();
                    loadSubscriptions(); // Reload list
                }
            } catch (e) { alert('Fehler beim Speichern'); }
        }

        async function deleteContract(id) {
            if (!confirm('Vertrag wirklich loeschen?')) return;
            try {
                const res = await fetch(`${API_BASE}/financial/contracts/${id}`, { method: 'DELETE' });
                if ((await res.json()).success) loadSubscriptions();
            } catch (e) { console.error(e); }
        }

        async function loadAccounts() {
            try {
                const res = await fetch(`${API_BASE}/accounts`);
                const data = await res.json();
                const container = document.getElementById('accounts-list');

                if (!data.accounts || data.accounts.length === 0) {
                    container.innerHTML = `
                        <p>Keine E-Mail-Konten konfiguriert</p>
                        <p><button class="btn btn-primary" onclick="showAddAccountModal()">Erstes Konto hinzufuegen</button></p>
                    `;
                    return;
                }

                container.innerHTML = data.accounts.map(acc => `
                    <div class="account-card">
                        <div class="account-info">
                            <h4>
                                ${acc.name || acc.email.split('@')[0]}
                                <span class="badge ${acc.provider === 'gmail_api' ? 'gmail' : 'imap'}">${acc.provider === 'gmail_api' ? 'Gmail API' : 'IMAP'}</span>
                                <span class="badge ${acc.is_active ? 'aktiv' : 'inaktiv'}">${acc.is_active ? 'Aktiv' : 'Inaktiv'}</span>
                            </h4>
                            <div class="email">${acc.email}</div>
                            ${acc.imap_host ? `<div class="email">${acc.imap_host}:${acc.imap_port}</div>` : ''}
                        </div>
                        <div class="account-actions">
                            <button class="btn btn-sm btn-secondary" onclick="testAccount(${acc.id})">Testen</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleAccount(${acc.id})">${acc.is_active ? 'Deaktivieren' : 'Aktivieren'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAccount(${acc.id})">Loeschen</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Accounts-Fehler:', e);
            }
        }

        function showAddAccountModal() {
            document.getElementById('add-account-modal').classList.add('active');
            document.getElementById('acc-email').focus();
        }

        function closeModal() {
            document.getElementById('add-account-modal').classList.remove('active');
            document.getElementById('add-account-form').reset();
        }

        function updateProviderFields() {
            const provider = document.getElementById('acc-provider').value;
            document.getElementById('imap-fields').style.display = provider === 'imap' ? 'block' : 'none';
            document.getElementById('gmail-api-fields').style.display = provider === 'gmail_api' ? 'block' : 'none';
        }

        // Auto-fill IMAP settings
        document.getElementById('acc-email').addEventListener('blur', async function () {
            const email = this.value;
            if (!email || !email.includes('@')) return;

            const domain = email.split('@')[1].toLowerCase();

            try {
                const res = await fetch(`${API_BASE}/imap-presets`);
                const data = await res.json();

                if (data.presets[domain]) {
                    const preset = data.presets[domain];
                    document.getElementById('acc-host').value = preset.host;
                    document.getElementById('acc-port').value = preset.port;
                    document.getElementById('acc-name').placeholder = preset.name;
                    if (preset.note) {
                        document.getElementById('password-hint').textContent = preset.note;
                    }

                    // Gmail: API vorschlagen
                    if (domain.includes('gmail') || domain.includes('googlemail')) {
                        document.getElementById('acc-provider').value = 'gmail_api';
                        updateProviderFields();
                    }
                }
            } catch (e) { }
        });

        async function addAccount(event) {
            event.preventDefault();

            const email = document.getElementById('acc-email').value;
            const name = document.getElementById('acc-name').value || email.split('@')[0];
            const provider = document.getElementById('acc-provider').value;
            const password = document.getElementById('acc-password').value;
            const host = document.getElementById('acc-host').value;
            const port = parseInt(document.getElementById('acc-port').value) || 993;

            // Bei Gmail API: Automatische Einrichtung
            if (provider === 'gmail_api') {
                await setupGmailApi();
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        email,
                        provider,
                        password: provider === 'imap' ? password : null,
                        imap_host: host,
                        imap_port: port,
                        use_oauth: provider === 'gmail_api'
                    })
                });

                const data = await res.json();

                if (data.success) {
                    alert('Konto hinzugefuegt!');
                    closeModal();
                    loadAccounts();
                    loadStatus();
                } else {
                    alert('Fehler: ' + (data.detail || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function setupGmailApi() {
            // Zeige Fortschritt
            const statusDiv = document.getElementById('gmail-api-fields');
            statusDiv.innerHTML = '<div class="form-group"><div class="hint">Suche nach Gmail credentials.json...</div></div>';

            try {
                // Erst Status pruefen
                const statusRes = await fetch(`${API_BASE}/gmail/status`);
                const status = await statusRes.json();

                if (status.is_valid && status.email) {
                    alert(`Gmail API bereits eingerichtet: ${status.email}`);
                    closeModal();
                    loadAccounts();
                    loadStatus();
                    return;
                }

                if (!status.has_credentials) {
                    statusDiv.innerHTML = `
                        <div class="form-group">
                            <div class="hint" style="color: #f44336;">
                                Keine credentials.json gefunden!<br><br>
                                Bitte laden Sie die OAuth-Credentials von der Google Cloud Console herunter:<br>
                                <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #4fc3f7;">
                                    Google Cloud Console oeffnen
                                </a><br><br>
                                Anleitung:<br>
                                1. "Create Credentials" > "OAuth client ID"<br>
                                2. Application type: "Desktop app"<br>
                                3. JSON herunterladen<br>
                                4. In Downloads oder einem Projekt-Ordner speichern
                            </div>
                        </div>
                    `;
                    return;
                }

                // Gefundene Credentials anzeigen
                statusDiv.innerHTML = `
                    <div class="form-group">
                        <div class="hint">
                            Gefundene credentials.json:<br>
                            <small>${status.found_credentials[0] || 'Unbekannt'}</small><br><br>
                            <em>Starte OAuth-Autorisierung... Ein Browser-Fenster wird geoeffnet.</em>
                        </div>
                    </div>
                `;

                // Setup starten
                const setupRes = await fetch(`${API_BASE}/gmail/setup`, { method: 'POST' });
                const result = await setupRes.json();

                if (result.success) {
                    alert(`Gmail API erfolgreich eingerichtet!\n\nE-Mail: ${result.email}`);
                    closeModal();
                    loadAccounts();
                    loadStatus();
                } else {
                    statusDiv.innerHTML = `
                        <div class="form-group">
                            <div class="hint" style="color: #f44336;">
                                Fehler: ${result.message}<br><br>
                                ${result.help_url ? `<a href="${result.help_url}" target="_blank" style="color: #4fc3f7;">Hilfe</a>` : ''}
                            </div>
                        </div>
                    `;
                }

            } catch (e) {
                statusDiv.innerHTML = `
                    <div class="form-group">
                        <div class="hint" style="color: #f44336;">Fehler: ${e.message}</div>
                    </div>
                `;
            }
        }

        async function checkGmailStatus() {
            // Wird beim Tab-Wechsel zu "Konten" aufgerufen
            try {
                const res = await fetch(`${API_BASE}/gmail/status`);
                const status = await res.json();

                // Gmail-Status in Konten-Liste anzeigen falls konfiguriert
                if (status.is_valid) {
                    console.log('Gmail API aktiv:', status.email);
                }
            } catch (e) {
                console.error('Gmail Status Check:', e);
            }
        }

        async function testAccount(id) {
            try {
                const res = await fetch(`${API_BASE}/accounts/${id}/test`, { method: 'POST' });
                const data = await res.json();
                alert(data.success ? 'OK: ' + data.message : 'Fehler: ' + data.message);
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function toggleAccount(id) {
            try {
                await fetch(`${API_BASE}/accounts/${id}/toggle`, { method: 'PUT' });
                loadAccounts();
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function deleteAccount(id) {
            if (!confirm('Konto wirklich loeschen?')) return;

            try {
                await fetch(`${API_BASE}/accounts/${id}`, { method: 'DELETE' });
                loadAccounts();
                loadStatus();
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function syncEmails() {
            try {
                const res = await fetch(`${API_BASE}/sync`, { method: 'POST' });
                alert('Synchronisierung gestartet!');
                setTimeout(() => { loadStatus(); loadEmails(); }, 5000);
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function exportData() {
            try {
                const res = await fetch(`${API_BASE}/export`);
                const data = await res.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'financial_export_' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
            } catch (e) {
                alert('Export-Fehler: ' + e.message);
            }
        }

        // â”€â”€â”€ Settings Modal â”€â”€â”€
        async function showSettingsModal() {
            // Aktuelle Config laden
            try {
                const res = await fetch(`${API_BASE}/config`);
                const config = await res.json();

                document.getElementById('setting-date-range').value = config.date_range_days || 90;
                document.getElementById('setting-max-emails').value = config.max_emails_per_run || 50;
                document.getElementById('setting-auto-extract').checked = config.auto_extract !== false;

                document.getElementById('settings-modal').classList.add('active');
            } catch (e) {
                alert('Fehler beim Laden der Einstellungen: ' + e.message);
            }
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        async function saveSettings(event) {
            event.preventDefault();

            const dateRange = parseInt(document.getElementById('setting-date-range').value);
            const maxEmails = parseInt(document.getElementById('setting-max-emails').value);
            const autoExtract = document.getElementById('setting-auto-extract').checked;

            try {
                const res = await fetch(`${API_BASE}/config?date_range_days=${dateRange}&max_emails_per_run=${maxEmails}&auto_extract=${autoExtract}`, {
                    method: 'PUT'
                });

                const data = await res.json();

                if (data.success) {
                    alert('Einstellungen gespeichert!\n\nDatumsbereich: ' + dateRange + ' Tage');
                    closeSettingsModal();
                } else {
                    alert('Fehler: ' + (data.detail || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // â”€â”€â”€ Profile Functions â”€â”€â”€

        async function loadProfiles() {
            try {
                const res = await fetch(`${API_BASE}/profiles`);
                const data = await res.json();

                // System-Profile
                const systemDiv = document.getElementById('system-profiles');
                if (data.system_profiles && data.system_profiles.length > 0) {
                    systemDiv.innerHTML = data.system_profiles.map(p => renderProfileCard(p)).join('');
                } else {
                    systemDiv.innerHTML = '<p>Keine System-Profile gefunden</p>';
                }

                // User-Profile
                const userDiv = document.getElementById('user-profiles');
                if (data.user_profiles && data.user_profiles.length > 0) {
                    userDiv.innerHTML = data.user_profiles.map(p => renderProfileCard(p, true)).join('');
                } else {
                    userDiv.innerHTML = '<p>Keine eigenen Profile. Klicke auf "+ Neu" um eines zu erstellen.</p>';
                }

                // False-Positives laden
                await loadFalsePositives();
            } catch (e) {
                console.error('Profile-Fehler:', e);
            }
        }

        function renderProfileCard(profile, editable = false) {
            const senderPatterns = (profile.sender_patterns || []).join(', ') || '-';
            const subjectPatterns = (profile.subject_patterns || []).join(', ') || '-';
            const blacklist = (profile.blacklist || []).join(', ') || '-';

            return `
                <div class="subscription-card" style="flex-direction: column; align-items: stretch;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0;">
                                ${profile.name}
                                ${profile.steuer_relevant ? '<span class="badge steuer">Steuer</span>' : ''}
                                ${profile.recurring ? '<span class="badge">Abo</span>' : ''}
                                <span class="badge" style="background: ${profile.source === 'system' ? '#666' : '#2196f3'};">${profile.source || 'system'}</span>
                            </h4>
                            <small style="color: var(--text-muted);">${profile.id} | ${profile.category}</small>
                        </div>
                        ${editable ? `
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-secondary" onclick="editProfile('${profile.id}')">Bearbeiten</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProfile('${profile.id}')">Loeschen</button>
                        </div>
                        ` : ''}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                        <div><strong>Sender:</strong> ${senderPatterns}</div>
                        <div><strong>Subject:</strong> ${subjectPatterns}</div>
                        ${blacklist !== '-' ? `<div style="color: #f44336;"><strong>Blacklist:</strong> ${blacklist}</div>` : ''}
                    </div>
                </div>
            `;
        }

        async function loadFalsePositives() {
            try {
                const res = await fetch(`${API_BASE}/false-positives`);
                const data = await res.json();

                document.getElementById('fp-count').textContent = data.message_ids?.length || 0;

                const historyDiv = document.getElementById('false-positives-list');
                const history = data.history || [];

                if (history.length > 0) {
                    historyDiv.innerHTML = history.slice(0, 10).map(fp => `
                        <div class="subscription-card" style="padding: 0.75rem;">
                            <div class="sub-info">
                                <small style="color: var(--text-muted);">${fp.sender}</small>
                                <div>${fp.subject}</div>
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="removeFalsePositive('${fp.message_id}')">Entfernen</button>
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = '<p style="color: var(--text-muted);">Keine Falsch-Positive markiert</p>';
                }
            } catch (e) {
                console.error('FP-Fehler:', e);
            }
        }

        function showAddProfileModal() {
            document.getElementById('profile-modal-title').textContent = 'Neues Profil';
            document.getElementById('profile-form').reset();
            document.getElementById('profile-edit-id').value = '';
            document.getElementById('profile-enabled').checked = true;
            document.getElementById('profile-modal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        async function editProfile(profileId) {
            try {
                const res = await fetch(`${API_BASE}/profiles`);
                const data = await res.json();

                const profile = data.user_profiles.find(p => p.id === profileId);
                if (!profile) {
                    alert('Profil nicht gefunden');
                    return;
                }

                document.getElementById('profile-modal-title').textContent = 'Profil bearbeiten';
                document.getElementById('profile-edit-id').value = profileId;
                document.getElementById('profile-id').value = profile.id;
                document.getElementById('profile-name').value = profile.name;
                document.getElementById('profile-category').value = profile.category || 'sonstiges';
                document.getElementById('profile-type').value = profile.type || 'rechnung';
                document.getElementById('profile-sender').value = (profile.sender_patterns || []).join('\n');
                document.getElementById('profile-subject').value = (profile.subject_patterns || []).join('\n');
                document.getElementById('profile-blacklist').value = (profile.blacklist || []).join('\n');
                document.getElementById('profile-steuer').checked = profile.steuer_relevant;
                document.getElementById('profile-recurring').checked = profile.recurring;
                document.getElementById('profile-enabled').checked = profile.enabled !== false;

                document.getElementById('profile-modal').classList.add('active');
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function saveProfile(event) {
            event.preventDefault();

            const editId = document.getElementById('profile-edit-id').value;
            const isEdit = !!editId;

            const profile = {
                id: document.getElementById('profile-id').value.trim(),
                name: document.getElementById('profile-name').value.trim(),
                category: document.getElementById('profile-category').value,
                type: document.getElementById('profile-type').value,
                sender_patterns: document.getElementById('profile-sender').value.split('\n').map(s => s.trim()).filter(Boolean),
                subject_patterns: document.getElementById('profile-subject').value.split('\n').map(s => s.trim()).filter(Boolean),
                blacklist: document.getElementById('profile-blacklist').value.split('\n').map(s => s.trim()).filter(Boolean),
                body_must_contain: [],
                body_must_not_contain: [],
                steuer_relevant: document.getElementById('profile-steuer').checked,
                recurring: document.getElementById('profile-recurring').checked,
                enabled: document.getElementById('profile-enabled').checked
            };

            try {
                const url = isEdit ? `${API_BASE}/profiles/${editId}` : `${API_BASE}/profiles`;
                const method = isEdit ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profile)
                });

                const data = await res.json();

                if (data.success) {
                    closeProfileModal();
                    loadProfiles();
                } else {
                    alert('Fehler: ' + (data.error || data.detail || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function deleteProfile(profileId) {
            if (!confirm('Profil wirklich loeschen?')) return;

            try {
                const res = await fetch(`${API_BASE}/profiles/${profileId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    loadProfiles();
                } else {
                    alert('Fehler: ' + (data.error || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function testProfile() {
            const sender = document.getElementById('test-sender').value.trim();
            const subject = document.getElementById('test-subject').value.trim();
            const body = document.getElementById('test-body').value.trim();

            if (!sender && !subject) {
                alert('Bitte Absender oder Betreff eingeben');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/profiles/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sender, subject, body })
                });

                const data = await res.json();
                const resultDiv = document.getElementById('test-result');

                if (data.best_match) {
                    resultDiv.innerHTML = `
                        <div style="background: #4caf50; color: white; padding: 1rem; border-radius: 4px;">
                            <strong>Match:</strong> ${data.best_match.profile_name} (Score: ${data.best_match.score})
                            <br><small>Kategorie: ${data.best_match.category} | Steuer: ${data.best_match.steuer_relevant ? 'Ja' : 'Nein'}</small>
                            <br><small>${data.best_match.details.join(' | ')}</small>
                        </div>
                    `;
                } else if (data.all_matches?.length > 0) {
                    resultDiv.innerHTML = `
                        <div style="background: #ff9800; color: white; padding: 1rem; border-radius: 4px;">
                            <strong>Kein Match (blockiert)</strong>
                            <br><small>Gefundene Profile: ${data.all_matches.map(m => m.profile_name).join(', ')}</small>
                            <br><small>Grund: ${data.all_matches[0].details.filter(d => d.includes('BLOCKED')).join(', ')}</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #f44336; color: white; padding: 1rem; border-radius: 4px;">
                            <strong>Kein Match</strong>
                            <br><small>${data.total_tested} Profile getestet</small>
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById('test-result').innerHTML = `<div style="color: #f44336;">Fehler: ${e.message}</div>`;
            }
        }

        async function importProfiles() {
            if (!confirm('Profile aus UniversalInvoiceMail importieren?')) return;

            try {
                const res = await fetch(`${API_BASE}/profiles/import`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    alert(`${data.imported} Profile importiert von:\n${data.source}`);
                    loadProfiles();
                } else {
                    alert('Import-Fehler: ' + (data.error || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        function showFpModal(messageId, sender, subject) {
            document.getElementById('fp-message-id').value = messageId;
            document.getElementById('fp-sender').value = sender;
            document.getElementById('fp-subject').value = subject;
            document.getElementById('fp-reason').value = '';
            document.getElementById('fp-add-blacklist').checked = false;
            document.getElementById('fp-blacklist-terms').value = '';
            document.getElementById('fp-blacklist-options').style.display = 'none';
            document.getElementById('fp-modal').classList.add('active');
        }

        function closeFpModal() {
            document.getElementById('fp-modal').classList.remove('active');
        }

        document.getElementById('fp-add-blacklist')?.addEventListener('change', function () {
            document.getElementById('fp-blacklist-options').style.display = this.checked ? 'block' : 'none';
        });

        async function saveFalsePositive(event) {
            event.preventDefault();

            const data = {
                message_id: document.getElementById('fp-message-id').value,
                sender: document.getElementById('fp-sender').value,
                subject: document.getElementById('fp-subject').value,
                reason: document.getElementById('fp-reason').value,
                add_to_blacklist: document.getElementById('fp-add-blacklist').checked,
                blacklist_terms: document.getElementById('fp-blacklist-terms').value.split(',').map(s => s.trim()).filter(Boolean)
            };

            try {
                const res = await fetch(`${API_BASE}/false-positives`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    closeFpModal();
                    loadFalsePositives();
                    loadEmails(); // Aktualisiere E-Mail-Liste
                } else {
                    alert('Fehler: ' + (result.error || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function removeFalsePositive(messageId) {
            if (!confirm('Falsch-Positiv Markierung entfernen?')) return;

            try {
                const res = await fetch(`${API_BASE}/false-positives/${encodeURIComponent(messageId)}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    loadFalsePositives();
                } else {
                    alert('Fehler: ' + (data.error || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function deleteSubscription(id) {
            if (!confirm('Abonnement wirklich loeschen?')) return;
            try {
                const res = await fetch(`${API_BASE}/subscriptions/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    loadSubscriptions();
                    loadStatus();
                }
            } catch (e) {
                console.error('Fehler beim Loeschen:', e);
            }
        }

        async function showEmailContent(id) {
            try {
                const res = await fetch(`${API_BASE}/emails/${id}`);
                const data = await res.json();
                if (data.email) {
                    const e = data.email;
                    document.getElementById('email-view-subject').textContent = e.subject || 'Kein Betreff';
                    document.getElementById('email-view-meta').innerHTML = `
                        <div><strong>Von:</strong> ${e.sender || '-'}</div>
                        <div><strong>Anbieter:</strong> ${e.provider_name || '-'}</div>
                        <div><strong>Datum:</strong> ${e.email_date ? new Date(e.email_date).toLocaleString('de-DE') : '-'}</div>
                        <div><strong>Betrag:</strong> ${e.betrag ? e.betrag.toFixed(2) + ' EUR' : '-'}</div>
                        <div style="margin-top: 0.5rem; color: var(--accent-color);">ID: ${e.message_id || '-'}</div>
                    `;
                    document.getElementById('email-view-body').textContent = e.body || '(Kein Inhalt extrahiert)';
                    document.getElementById('email-modal').classList.add('active');
                }
            } catch (e) {
                console.error('Fehler beim Laden der E-Mail:', e);
                alert('E-Mail konnte nicht geladen werden.');
            }
        }

        function closeEmailModal() {
            document.getElementById('email-modal').classList.remove('active');
        }

        // Report Generator (Task 487)
        async function previewReport() {
            const period = document.getElementById('report-period').value;
            const preview = document.getElementById('report-preview-content');
            preview.innerHTML = "Generiere Vorschau...";

            try {
                // Hier koennte eine API-Anfrage zur Daten-Aggregierung sein
                const res = await fetch(`${API_BASE}/emails`);
                const data = await res.json();
                const emails = data.emails || [];

                // Einfache Aggregation fuer Vorschau
                const total = emails.reduce((sum, e) => sum + (e.betrag || 0), 0);
                const count = emails.length;
                const taxCount = emails.filter(e => e.is_steuer_relevant).length;

                preview.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Zusammenfassung (${period})</div>
                    <div>Erfasste Belege: ${count}</div>
                    <div>Steuer-relevant: ${taxCount}</div>
                    <div style="font-size: 1.1rem; color: var(--accent-color); margin-top: 0.5rem;">
                        Gesamtsumme: ${total.toFixed(2)} EUR
                    </div>
                    <div style="margin-top: 1rem; border-top: 1px solid #444; padding-top: 0.5rem; font-size: 0.75rem;">
                        <i>Dies ist eine vorlaeufige Vorschau basierend auf allen lokalen Daten.</i>
                    </div>
                `;
            } catch (e) {
                preview.innerHTML = "Fehler bei der Vorschau.";
            }
        }

        async function generateReportFromTab() {
            const period = document.getElementById('report-period').value;
            const format = document.getElementById('report-format').value;
            alert(`Report-Generierung gestartet:\nZeitraum: ${period}\nFormat: ${format}\n\nDer Report wird im Hintergrund erstellt und unter 'Verfuegbare Berichte' erscheinen.`);

            // Simulation: In Eurer Integration wuerdet ihr hier eine API aufrufen
            setTimeout(() => {
                const list = document.getElementById('available-reports-list');
                const now = new Date().toLocaleString('de-DE');
                if (list.querySelector('.empty-state')) list.innerHTML = '';

                list.insertAdjacentHTML('afterbegin', `
                    <div class="card" style="margin-bottom: 0.5rem; padding: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Financial_Report_${period}_${new Date().toISOString().split('T')[0]}.${format}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${now}</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="alert('Download gestartet...')">Download</button>
                    </div>
                `);
            }, 2000);
        }

        async function generateReport(type) {
            // Button aus overview tab
            const tab = document.querySelector('.tab[data-tab="reports"]');
            if (tab) tab.click();
            document.getElementById('report-period').value = type === 'monthly' ? 'current_month' : 'current_year';
            previewReport();
        }

        // Initial laden
        loadStatus();
        setInterval(loadStatus, 60000);
    </script>
    <script src="/static/js/nav.js"></script>
</body>

</html>