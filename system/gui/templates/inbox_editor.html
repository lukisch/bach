<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>BACH - Inbox Editor</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .editor-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        .rule-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .rule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 100px 50px;
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        input,
        select {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
        }

        .btn-remove {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 2rem;
        }
    </style>
</head>

<body>
    <header class="main-header" id="main-header"></header>
    <main class="editor-container">
        <h1>Inbox Profil-Editor</h1>
        <p class="text-muted">Konfiguration der automatischen Dokumenten-Sortierung (inbox_config.json)</p>

        <div id="settings" class="settings-grid">
            <!-- Settings werden dynamisch geladen -->
        </div>

        <h3>Sortier-Regeln</h3>
        <div id="rules-list">
            <!-- Regeln werden dynamisch geladen -->
        </div>

        <div class="actions">
            <button class="btn btn-secondary" onclick="addRule()">+ Regel hinzufügen</button>
            <button class="btn btn-primary" onclick="saveConfig()">Konfiguration speichern</button>
        </div>
    </main>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        let config = { settings: {}, rules: [] };

        async function loadConfig() {
            const data = await api.get('/api/inbox/config');
            config = data;
            renderSettings();
            renderRules();
        }

        function renderSettings() {
            const container = document.getElementById('settings');
            container.innerHTML = `
                <div class="form-group">
                    <label>Aktiviert</label>
                    <select id="setting-enabled" onchange="updateSetting('enabled', this.value === 'true')">
                        <option value="true" ${config.settings.enabled ? 'selected' : ''}>Ja</option>
                        <option value="false" ${!config.settings.enabled ? 'selected' : ''}>Nein</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>OCR aktiviert</label>
                    <select id="setting-ocr" onchange="updateSetting('ocr_enabled', this.value === 'true')">
                        <option value="true" ${config.settings.ocr_enabled ? 'selected' : ''}>Ja</option>
                        <option value="false" ${!config.settings.ocr_enabled ? 'selected' : ''}>Nein</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Transfer-Zone (Pfad)</label>
                    <input type="text" value="${config.settings.transfer_zone}" onchange="updateSetting('transfer_zone', this.value)">
                </div>
                <div class="form-group">
                    <label>Auto-Task bei unbekannten Dokumenten</label>
                    <select id="setting-task" onchange="updateSetting('auto_task_on_unknown', this.value === 'true')">
                        <option value="true" ${config.settings.auto_task_on_unknown ? 'selected' : ''}>Ja</option>
                        <option value="false" ${!config.settings.auto_task_on_unknown ? 'selected' : ''}>Nein</option>
                    </select>
                </div>
            `;
        }

        function updateSetting(key, val) { config.settings[key] = val; }

        function renderRules() {
            const container = document.getElementById('rules-list');
            container.innerHTML = config.rules.map((rule, index) => `
                <div class="rule-card">
                    <div class="rule-grid">
                        <div class="form-group">
                            <label>ID / Name</label>
                            <input type="text" value="${rule.id}" onchange="updateRule(${index}, 'id', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Pattern (Regex)</label>
                            <input type="text" value="${rule.pattern}" onchange="updateRule(${index}, 'pattern', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Zielpfad</label>
                            <input type="text" value="${rule.target}" onchange="updateRule(${index}, 'target', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Typ</label>
                            <select onchange="updateRule(${index}, 'pattern_type', this.value)">
                                <option value="filename" ${rule.pattern_type === 'filename' ? 'selected' : ''}>Name</option>
                                <option value="content" ${rule.pattern_type === 'content' ? 'selected' : ''}>Inhalt</option>
                            </select>
                        </div>
                        <button class="btn-remove" onclick="removeRule(${index})">×</button>
                    </div>
                </div>
            `).join('');
        }

        function updateRule(index, key, val) {
            if (key === 'priority') val = parseInt(val);
            config.rules[index][key] = val;
        }

        function addRule() {
            config.rules.push({ id: "neu", pattern: ".*", pattern_type: "filename", target: "inbox", priority: 99, enabled: true });
            renderRules();
        }

        function removeRule(index) {
            config.rules.splice(index, 1);
            renderRules();
        }

        async function saveConfig() {
            const res = await api.post('/api/inbox/config', config);
            if (res.success) alert("Gespeichert!");
            else alert("Fehler: " + res.error);
        }

        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>

</html>