<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wartung-Board | BACH</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .maint-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .maint-card {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .maint-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .maint-card h2 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .maint-icon {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
        }

        .maint-desc {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            flex-grow: 1;
        }

        /* System Health Stats */
        .health-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .health-item {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .health-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .health-val {
            font-weight: 700;
            color: var(--success);
        }

        .health-val.warning {
            color: var(--warning);
        }

        .health-val.error {
            color: var(--error);
        }

        /* Quick Action Bar */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .quick-action {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action:hover {
            background: var(--bg-card);
            border-color: var(--accent-blue);
        }

        .quick-action-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .quick-action-label {
            font-size: 0.85rem;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <div class="page-header">
            <h1>üõ†Ô∏è Wartung & <span>System-Status</span></h1>
            <p style="color: var(--text-muted);">Zentrale Steuerung der BACH System-Integrit√§t.</p>
        </div>

        <!-- System Health Section -->
        <div class="card" style="margin-bottom: 2.5rem;">
            <h2>üíì System Health</h2>
            <div class="health-grid">
                <div class="health-item">
                    <span class="health-label">FastAPI Server</span>
                    <span class="health-val" id="health-api">Online</span>
                </div>
                <div class="health-item">
                    <span class="health-label">Database (SQLite)</span>
                    <span class="health-val" id="health-db">Connected</span>
                </div>
                <div class="health-item">
                    <span class="health-label">Main Daemon</span>
                    <span class="health-val" id="health-daemon">-</span>
                </div>
                <div class="health-item">
                    <span class="health-label">Storage Capacity</span>
                    <span class="health-val" id="health-storage">-</span>
                </div>
                <div class="health-item">
                    <span class="health-label">Active Agents</span>
                    <span class="health-val" id="health-agents">-</span>
                </div>
                <div class="health-item">
                    <span class="health-label">Memory Utilization</span>
                    <span class="health-val" id="health-mem">-</span>
                </div>
            </div>
        </div>

        <div class="maint-grid">
            <!-- Daemon Control -->
            <div class="maint-card">
                <div class="maint-icon">‚öôÔ∏è</div>
                <h2>Daemon & Jobs</h2>
                <p class="maint-desc">
                    Verwalten Sie Hintergrundprozesse, zyklische Scanner und automatisierte Task-Erstellung.
                    Hier k√∂nnen Sie den Scheduler starten, stoppen oder einzelne Jobs manuell triggern.
                </p>
                <a href="/daemon" class="btn btn-primary">Steuerung √∂ffnen</a>
            </div>

            <!-- Logs Section -->
            <div class="maint-card">
                <div class="maint-icon">üìù</div>
                <h2>System Logs</h2>
                <p class="maint-desc">
                    Echtzeit-Einsicht in System-Protokolle, Fehlerberichte und Prozess-Logs.
                    Analysieren Sie das Verhalten von ATI, Daemon und Mail-Services.
                </p>
                <a href="/logs" class="btn btn-secondary">Logs durchsuchen</a>
            </div>

            <!-- Database Clean-up -->
            <div class="maint-card">
                <div class="maint-icon">üßπ</div>
                <h2>Systempflege</h2>
                <p class="maint-desc">
                    Bereinigen Sie veraltete Eintr√§ge, komprimieren Sie die Datenbank oder setzen Sie
                    tempor√§re Verzeichnisse zur√ºck. Optimieren Sie die Performance des Kernsystems.
                </p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="vacuumDb()">DB Vacuum</button>
                    <button class="btn btn-secondary" onclick="clearTemp()">Clear Temp</button>
                </div>
            </div>

            <!-- Usecases & Tests -->
            <div class="maint-card">
                <div class="maint-icon">üß™</div>
                <h2>Usecases & Tests</h2>
                <p class="maint-desc">
                    Definierte Anwendungsf√§lle verwalten, testen und ausf√ºhren.
                    Pr√ºfen Sie ob BACH-Workflows korrekt funktionieren und dokumentieren Sie Testl√§ufe.
                </p>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <span id="usecases-total" style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">-</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;"> Usecases</span>
                    </div>
                    <div style="font-size: 0.85rem;">
                        <span style="color: var(--success);">‚úì <span id="usecases-pass">0</span></span> |
                        <span style="color: var(--error);">‚úó <span id="usecases-fail">0</span></span> |
                        <span style="color: var(--warning);">‚óã <span id="usecases-pending">0</span></span>
                    </div>
                </div>
                <a href="/usecases" class="btn btn-primary">Usecases verwalten</a>
            </div>

            <!-- T√úV Workflow -->
            <div class="maint-card">
                <div class="maint-icon">‚úÖ</div>
                <h2>Workflow T√úV</h2>
                <p class="maint-desc">
                    Pr√ºfen Sie Workflows auf Vollst√§ndigkeit und G√ºltigkeit.
                    Dokumentieren Sie Test-Ergebnisse und verl√§ngern Sie T√úV-Siegel.
                </p>
                <a href="/workflow-tuev" class="btn btn-secondary">T√úV Dashboard</a>
            </div>
        </div>

        <h2>üöÄ Schnellzugriff</h2>
        <div class="action-grid">
            <div class="quick-action" onclick="window.location.href='/ati'">
                <span class="quick-action-icon">ü§ñ</span>
                <span class="quick-action-label">ATI Dashboard</span>
            </div>
            <div class="quick-action" onclick="triggerMaintenance()">
                <span class="quick-action-icon">‚ôªÔ∏è</span>
                <span class="quick-action-label">System Refresh</span>
            </div>
            <div class="quick-action" onclick="window.location.href='/prompt-generator'">
                <span class="quick-action-icon">üé≠</span>
                <span class="quick-action-label">Prompt Management</span>
            </div>
            <div class="quick-action" onclick="window.open('/api/status', '_blank')">
                <span class="quick-action-icon">ü©∫</span>
                <span class="quick-action-label">Raw API Status</span>
            </div>
            <div class="quick-action" onclick="window.location.href='/usecases'">
                <span class="quick-action-icon">üß™</span>
                <span class="quick-action-label">Usecases</span>
            </div>
            <div class="quick-action" onclick="runAllUsecaseTests()">
                <span class="quick-action-icon">‚ñ∂Ô∏è</span>
                <span class="quick-action-label">Alle Tests starten</span>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div>BACH v1.1 | Maintenance Control Panel</div>
        <div id="status-text">Ready</div>
    </footer>

    <script src="/static/js/api.js?v=2"></script>
    <script src="/static/js/nav.js?v=2"></script>
    <script>
        async function loadHealth() {
            try {
                const status = await api.status();
                const daemon = await api.get('/api/daemon/status');
                const agents = await api.agents.list();

                document.getElementById('health-api').textContent = 'Online';
                document.getElementById('health-daemon').textContent = daemon.running ? 'Running' : 'Stopped';
                document.getElementById('health-daemon').className = daemon.running ? 'health-val' : 'health-val error';

                document.getElementById('health-agents').textContent = agents.agents ? agents.agents.filter(a => a.is_active).length : 0;
                document.getElementById('health-db').textContent = status.db_connected ? 'Connected' : 'Offline';
                document.getElementById('health-db').className = status.db_connected ? 'health-val' : 'health-val error';

                // System-Ressourcen aus API (NEU v1.1.85)
                if (status.system && !status.system.error) {
                    const sys = status.system;
                    document.getElementById('health-mem').textContent =
                        `${sys.ram_used_gb} GB / ${sys.ram_total_gb} GB (${sys.ram_percent}%)`;
                    // Farbe je nach Auslastung
                    const memEl = document.getElementById('health-mem');
                    if (sys.ram_percent > 90) {
                        memEl.className = 'health-val error';
                    } else if (sys.ram_percent > 75) {
                        memEl.className = 'health-val warning';
                    } else {
                        memEl.className = 'health-val';
                    }

                    // Storage
                    if (sys.disk_percent !== null) {
                        document.getElementById('health-storage').textContent =
                            `${100 - sys.disk_percent}% frei`;
                        const storEl = document.getElementById('health-storage');
                        if (sys.disk_percent > 90) {
                            storEl.className = 'health-val error';
                        } else if (sys.disk_percent > 80) {
                            storEl.className = 'health-val warning';
                        }
                    }
                } else {
                    document.getElementById('health-mem').textContent = 'N/A';
                    document.getElementById('health-storage').textContent = 'N/A';
                }

            } catch (e) {
                console.error('Health Check failed:', e);
            }
        }

        async function vacuumDb() {
            if (!confirm('Datenbank optimieren?')) return;
            // API vorhanden? Fallback Alert
            alert('DB Vacuum gestartet (Simuliert)');
        }

        async function clearTemp() {
            if (!confirm('Tempor√§re Dateien l√∂schen?')) return;
            alert('Systempflege abgeschlossen.');
        }

        async function triggerMaintenance() {
            alert('Wartungs-Routine wird im Hintergrund ausgef√ºhrt.');
        }

        async function loadUsecasesStats() {
            try {
                const res = await fetch('/api/usecases');
                const data = await res.json();
                if (data.stats) {
                    document.getElementById('usecases-total').textContent = data.stats.total || 0;
                    document.getElementById('usecases-pass').textContent = data.stats.pass || 0;
                    document.getElementById('usecases-fail').textContent = data.stats.fail || 0;
                    document.getElementById('usecases-pending').textContent = data.stats.pending || 0;
                }
            } catch (e) {
                console.error('Usecases-Stats laden fehlgeschlagen:', e);
            }
        }

        async function runAllUsecaseTests() {
            if (!confirm('Alle Usecase-Tests starten? Dies kann einige Zeit dauern.')) return;
            try {
                const res = await fetch('/api/usecases/test-all', { method: 'POST' });
                const data = await res.json();
                alert(`Tests abgeschlossen!\n\nGesamt: ${data.total || 0}\nBestanden: ${data.passed || 0}\nFehlgeschlagen: ${data.failed || 0}`);
                loadUsecasesStats();
            } catch (e) {
                alert('Fehler beim Ausf√ºhren der Tests: ' + e.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHealth();
            loadUsecasesStats();
        });
    </script>
</body>

</html>