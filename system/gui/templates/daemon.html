<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - Wartung</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .daemon-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .daemon-grid {
                grid-template-columns: 1fr;
            }
        }

        .jobs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .jobs-table th,
        .jobs-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .jobs-table th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .job-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .job-status.active {
            background: #d4edda;
            color: #155724;
        }

        .job-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .run-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .run-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .run-item:last-child {
            border-bottom: none;
        }

        .run-result {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .run-result.success {
            background: #d4edda;
            color: #155724;
        }

        .run-result.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .job-actions {
            display: flex;
            gap: 0.5rem;
        }

        .job-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
        }

        .job-actions button:hover {
            background: var(--bg-secondary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg);
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-value.running {
            color: #28a745;
        }

        .stat-value.stopped {
            color: #6c757d;  /* Grau statt Rot - Stopped ist OK, nicht Fehler */
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .btn-success {
            background: #28a745;
            color: white;
            border: none;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
        }

        .next-run {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .timer {
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h1 style="margin: 0;">âš™ï¸ Daemon Jobs</h1>
            <div class="page-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-danger" onclick="killAllDaemons()" title="Alle Daemon/Session-Prozesse sofort beenden">â˜ ï¸ Kill All</button>
                <button class="btn btn-primary" onclick="showAddJobModal()">+ Neuer Job</button>
                <button class="btn btn-secondary" onclick="refreshDaemon()">ğŸ”„</button>
            </div>
        </div>

        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
            âš ï¸ Jobs sind standardmÃ¤ÃŸig deaktiviert. Manuelle AusfÃ¼hrung Ã¼ber ğŸš€ empfohlen.
        </p>

        <!-- Recurring Tasks -->
        <div class="card" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>ğŸ”„ Wiederkehrende Aufgaben</h2>
                <button class="btn btn-sm" onclick="checkRecurringTasks()" title="Faellige Tasks pruefen">ğŸ”
                    Check</button>
            </div>
            <div id="recurring-tasks-container">
                <p class="loading">Lade...</p>
            </div>
        </div>

        <div class="daemon-grid">
            <!-- Jobs Liste -->
            <div class="card">
                <h2>Jobs</h2>
                <table class="jobs-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Name</th>
                            <th>Typ</th>
                            <th>Schedule</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-body">
                        <tr>
                            <td colspan="5" class="loading">Lade...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Run History -->
            <div class="card">
                <h2>Letzte Ausfuehrungen</h2>
                <div class="run-log" id="run-log">
                    <p class="loading">Lade...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Job Modal -->
    <div class="modal" id="add-job-modal">
        <div class="modal-content">
            <h2>Neuer Daemon-Job</h2>
            <form id="add-job-form" onsubmit="submitNewJob(event)">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="name" required placeholder="z.B. backup-daily">
                </div>
                <div class="form-group">
                    <label>Beschreibung</label>
                    <input type="text" name="description" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label>Job-Typ</label>
                    <select name="job_type" required>
                        <option value="interval">Interval (z.B. 30m, 1h)</option>
                        <option value="cron">Cron-Ausdruck</option>
                        <option value="manual">Manuell</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Schedule</label>
                    <input type="text" name="schedule" placeholder="z.B. 30m oder 0 3 * * *">
                </div>
                <div class="form-group">
                    <label>Command</label>
                    <input type="text" name="command" required placeholder="z.B. python tools/backup.py">
                </div>
                <div class="form-group" style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Erstellen</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DAEMON DASHBOARD - JavaScript
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let daemonStartTime = null;
        let uptimeInterval = null;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STATUS & CONTROLS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // Max Sessions speichern (DAEMON_005)
        async function saveMaxSessions() {
            const input = document.getElementById('max-sessions-input');
            const value = parseInt(input.value) || 0;

            try {
                await api.put('/api/daemon/config', { max_sessions: value });
                // Kurze BestÃ¤tigung
                input.style.borderColor = '#28a745';
                setTimeout(() => { input.style.borderColor = 'var(--border)'; }, 1000);
                loadStatus();
            } catch (e) {
                alert('Speichern fehlgeschlagen: ' + e.message);
                input.style.borderColor = '#dc3545';
            }
        }

        async function loadStatus() {
            try {
                const data = await api.get('/api/daemon/status');

                // Status-Anzeige
                const statusEl = document.getElementById('stat-status');
                const btnStart = document.getElementById('btn-start');
                const btnStop = document.getElementById('btn-stop');
                const dotEl = document.getElementById('daemon-status-dot');
                const textEl = document.getElementById('daemon-status-text');

                if (data.running) {
                    statusEl.textContent = 'ğŸŸ¢ Running';
                    statusEl.className = 'stat-value running';
                    btnStart.style.display = 'none';
                    btnStop.style.display = 'inline-block';
                    dotEl.className = 'status-dot online';
                    textEl.textContent = 'Daemon aktiv';

                    // Uptime starten
                    if (!daemonStartTime) {
                        daemonStartTime = new Date();
                        startUptimeTimer();
                    }
                } else {
                    statusEl.textContent = 'â¸ï¸ Bereit';
                    statusEl.className = 'stat-value stopped';
                    btnStart.style.display = 'inline-block';
                    btnStop.style.display = 'none';
                    dotEl.className = 'status-dot offline';
                    textEl.textContent = 'Daemon inaktiv';

                    // Uptime stoppen
                    daemonStartTime = null;
                    if (uptimeInterval) {
                        clearInterval(uptimeInterval);
                        uptimeInterval = null;
                    }
                    document.getElementById('stat-uptime').textContent = '-';
                }

                // Statistiken
                if (data.stats) {
                    document.getElementById('stat-jobs').textContent = data.stats.active_jobs || 0;
                    document.getElementById('stat-runs').textContent = data.stats.runs_today || 0;
                }

                // Session-Statistiken (NEU v1.1.45)
                document.getElementById('stat-sessions').textContent = data.sessions_generated || 0;

                // Countdown fÃ¼r nÃ¤chste Session
                if (data.next_session_in && data.next_session_in > 0) {
                    updateSessionCountdown(data.next_session_in);
                } else if (data.running) {
                    document.getElementById('stat-next-session').textContent = 'Bald';
                } else {
                    document.getElementById('stat-next-session').textContent = '--:--';
                }

                // Max Sessions Input und Fortschritt (DAEMON_005)
                const maxSessions = data.config?.max_sessions || 0;
                const sessionsGenerated = data.sessions_generated || 0;
                const maxInput = document.getElementById('max-sessions-input');
                const progressContainer = document.getElementById('session-progress-container');
                const progressFill = document.getElementById('session-progress-fill');
                const progressText = document.getElementById('session-progress-text');

                if (maxInput && maxInput !== document.activeElement) {
                    maxInput.value = maxSessions;
                }

                // Fortschrittsanzeige wenn max_sessions > 0
                if (maxSessions > 0 && progressContainer) {
                    progressContainer.style.display = 'block';
                    const percent = Math.min((sessionsGenerated / maxSessions) * 100, 100);
                    progressFill.style.width = `${percent}%`;
                    progressText.textContent = `${sessionsGenerated}/${maxSessions}`;

                    // Farbe je nach Fortschritt
                    if (percent >= 100) {
                        progressFill.style.background = '#dc3545'; // Rot - Limit erreicht
                    } else if (percent >= 80) {
                        progressFill.style.background = '#ffc107'; // Gelb - fast erreicht
                    } else {
                        progressFill.style.background = 'var(--primary)';
                    }
                } else if (progressContainer) {
                    progressContainer.style.display = 'none';
                }

            } catch (e) {
                console.error('Status laden fehlgeschlagen:', e);
            }
        }

        function startUptimeTimer() {
            if (uptimeInterval) return;

            uptimeInterval = setInterval(() => {
                if (!daemonStartTime) return;

                const diff = Math.floor((new Date() - daemonStartTime) / 1000);
                const hours = Math.floor(diff / 3600);
                const mins = Math.floor((diff % 3600) / 60);
                const secs = diff % 60;

                document.getElementById('stat-uptime').textContent =
                    `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        async function startDaemon() {
            try {
                const result = await api.post('/api/daemon/start');
                if (result.status === 'already_running') {
                    alert('Daemon laeuft bereits');
                } else {
                    setTimeout(loadStatus, 1000);
                }
            } catch (e) {
                alert('Start fehlgeschlagen: ' + e.message);
            }
        }

        async function stopDaemon() {
            if (!confirm('Daemon wirklich stoppen?')) return;

            try {
                await api.post('/api/daemon/stop');
                setTimeout(loadStatus, 500);
            } catch (e) {
                alert('Stop fehlgeschlagen: ' + e.message);
            }
        }

        async function killAllDaemons() {
            if (!confirm('Alle Daemon-Prozesse beenden?\n\nDies beendet auch Zombie-Prozesse.')) return;

            try {
                const result = await api.post('/api/daemon/kill-all');
                let msg = `${result.killed_count} Prozess(e) beendet`;
                if (result.pid_file_removed) msg += '\nPID-File entfernt';
                if (result.errors && result.errors.length > 0) {
                    msg += '\n\nFehler:\n' + result.errors.join('\n');
                }
                alert(msg);
                loadStatus();
            } catch (e) {
                alert('Kill fehlgeschlagen: ' + e.message);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // JOBS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadJobs() {
            try {
                const data = await api.get('/api/daemon/jobs');
                const tbody = document.getElementById('jobs-body');

                if (!data.jobs || data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">Keine Jobs definiert</td></tr>';
                    return;
                }

                tbody.innerHTML = data.jobs.map(job => {
                    const nextRun = job.next_run ? formatDateTime(job.next_run) : '-';
                    return `
                    <tr>
                        <td>
                            <span class="job-status ${job.is_active ? 'active' : 'inactive'}">
                                ${job.is_active ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </td>
                        <td>
                            <strong>${job.name}</strong>
                            ${job.next_run ? `<div class="next-run">Naechster: ${nextRun}</div>` : ''}
                        </td>
                        <td>${job.job_type}</td>
                        <td><code>${job.schedule || '-'}</code></td>
                        <td class="job-actions">
                            <button onclick="toggleJob(${job.id})" title="${job.is_active ? 'Deaktivieren' : 'Aktivieren'}">
                                ${job.is_active ? 'â¸ï¸' : 'â–¶ï¸'}
                            </button>
                            <button onclick="runJobNow(${job.id})" title="Jetzt ausfuehren">ğŸš€</button>
                        </td>
                    </tr>
                `}).join('');

            } catch (e) {
                console.error('Jobs laden fehlgeschlagen:', e);
            }
        }

        async function toggleJob(jobId) {
            try {
                await api.put(`/api/daemon/jobs/${jobId}/toggle`);
                loadJobs();
                loadStatus();
            } catch (e) {
                alert('Toggle fehlgeschlagen: ' + e.message);
            }
        }

        async function runJobNow(jobId) {
            if (!confirm('Job jetzt ausfuehren?')) return;

            try {
                await api.post(`/api/daemon/jobs/${jobId}/run`);
                alert('Job gestartet - siehe Run-Historie');
                setTimeout(loadRuns, 2000);
            } catch (e) {
                alert('Start fehlgeschlagen: ' + e.message);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // RUNS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadRuns() {
            try {
                const data = await api.get('/api/daemon/runs?limit=15');
                const container = document.getElementById('run-log');

                if (!data.runs || data.runs.length === 0) {
                    container.innerHTML = '<p>Keine Ausfuehrungen</p>';
                    return;
                }

                container.innerHTML = data.runs.map(run => `
                    <div class="run-item">
                        <div>
                            <strong>Job #${run.job_id}</strong>
                            <br>
                            <small>${formatDateTime(run.started_at)}</small>
                        </div>
                        <div>
                            <span class="run-result ${run.result}">${run.result}</span>
                            <br>
                            <small class="timer">${run.duration_seconds ? run.duration_seconds.toFixed(1) + 's' : '-'}</small>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Runs laden fehlgeschlagen:', e);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MODALS & FORMS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function showAddJobModal() {
            document.getElementById('add-job-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('add-job-modal').classList.remove('active');
        }

        async function submitNewJob(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form.name.value,
                description: form.description.value,
                job_type: form.job_type.value,
                schedule: form.schedule.value,
                command: form.command.value
            };

            try {
                await api.post('/api/daemon/jobs', data);
                closeModal();
                form.reset();
                loadJobs();
                loadStatus();
            } catch (e) {
                alert('Erstellen fehlgeschlagen: ' + e.message);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // RECURRING TASKS (NEU RECURRING_002 v1.1.48)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadRecurringTasks() {
            const container = document.getElementById('recurring-tasks-container');
            if (!container) return;

            try {
                const data = await api.get('/api/recurring');

                // API gibt Object zurÃ¼ck, nicht Array - konvertieren
                const tasksObj = data.tasks || {};
                const taskIds = Object.keys(tasksObj);

                if (taskIds.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">Keine recurring Tasks konfiguriert</p>';
                    return;
                }

                // Konvertiere Object zu Array mit ID
                const tasksArray = taskIds.map(id => ({
                    id: id,
                    ...tasksObj[id]
                }));

                // Sortiere: fÃ¤llige zuerst, dann nach Name
                const sortedTasks = tasksArray.sort((a, b) => {
                    if (a.is_due && !b.is_due) return -1;
                    if (!a.is_due && b.is_due) return 1;
                    return (a.id || '').localeCompare(b.id || '');
                });

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        ${sortedTasks.map(task => renderRecurringTask(task)).join('')}
                    </div>
                `;

            } catch (e) {
                if (e.message && e.message.includes('503')) {
                    container.innerHTML = '<p style="color: var(--text-muted);">âš ï¸ Recurring Tasks Modul nicht verfuegbar</p>';
                } else {
                    console.error('Recurring Tasks laden fehlgeschlagen:', e);
                    container.innerHTML = '<p style="color: #dc3545;">Fehler beim Laden</p>';
                }
            }
        }

        function renderRecurringTask(task) {
            const isDue = task.is_due;
            const statusColor = isDue ? '#28a745' : 'var(--text-muted)';
            const statusIcon = isDue ? 'ğŸŸ¢' : 'â¸ï¸';
            const enabled = task.enabled !== false;

            // Formatiere letzte AusfÃ¼hrung
            let lastRun = 'Noch nie';
            if (task.last_run) {
                lastRun = formatDateTime(task.last_run);
            }

            // Formatiere Intervall
            let interval = task.interval_days ? `${task.interval_days}d` : (task.interval || '-');
            if (task.frequency) {
                interval = task.frequency;
            }

            return `
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; ${isDue ? 'border-left: 3px solid #28a745;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="font-size: 0.95rem;">${statusIcon} ${task.name || task.id}</strong>
                        ${!enabled ? '<span style="font-size: 0.7rem; color: #dc3545;">DEAKTIVIERT</span>' : ''}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        <div>ğŸ“… Intervall: ${interval}</div>
                        <div>â° Letzte: ${lastRun}</div>
                        ${isDue ? '<div style="color: #28a745; font-weight: 500; margin-top: 0.25rem;">âœ… FÃ„LLIG</div>' : ''}
                    </div>
                    <button onclick="triggerRecurringTask('${task.id}')" 
                            style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; cursor: pointer; border: 1px solid var(--border); border-radius: 4px; background: var(--bg);"
                            ${!enabled ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        ğŸš€ Ausloesen
                    </button>
                </div>
            `;
        }

        async function checkRecurringTasks() {
            try {
                const result = await api.post('/api/recurring/check');
                if (result.created_count > 0) {
                    alert(`${result.created_count} Task(s) erstellt!`);
                } else {
                    alert('Keine faelligen Tasks.');
                }
                loadRecurringTasks();
            } catch (e) {
                alert('Check fehlgeschlagen: ' + e.message);
            }
        }

        async function triggerRecurringTask(taskId) {
            if (!confirm(`Recurring Task "${taskId}" jetzt ausloesen?`)) return;

            try {
                await api.post(`/api/recurring/trigger/${taskId}`);
                alert(`Task "${taskId}" ausgeloest!`);
                loadRecurringTasks();
            } catch (e) {
                alert('Ausloesen fehlgeschlagen: ' + e.message);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // HELPERS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const d = new Date(isoString);
            return d.toLocaleString('de-DE', {
                day: '2-digit', month: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // Session-Countdown formatieren (NEU v1.1.45)
        function updateSessionCountdown(seconds) {
            const el = document.getElementById('stat-next-session');
            if (!el) return;

            if (seconds <= 0) {
                el.textContent = 'Jetzt!';
                el.style.color = '#28a745';
                return;
            }

            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            el.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            // Farbe je nach Dringlichkeit
            if (seconds < 60) {
                el.style.color = '#dc3545'; // Rot - unter 1 Minute
            } else if (seconds < 300) {
                el.style.color = '#ffc107'; // Gelb - unter 5 Minuten
            } else {
                el.style.color = 'var(--primary)';
            }
        }

        function refreshDaemon() {
            loadStatus();
            loadJobs();
            loadRuns();
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // INIT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        document.addEventListener('DOMContentLoaded', async () => {
            loadStatus();
            loadJobs();
            loadRuns();
            await loadRecurringTasks();

            // Auto-Check: FÃ¤llige Recurring Tasks automatisch erstellen (silent)
            try {
                const result = await api.post('/api/recurring/check');
                if (result.created_count > 0) {
                    console.log(`[Recurring] ${result.created_count} Task(s) automatisch erstellt`);
                    loadRecurringTasks(); // Refresh nach Check
                }
            } catch(e) {
                console.log('[Recurring] Auto-Check fehlgeschlagen:', e.message);
            }

            // Auto-Refresh alle 30 Sekunden
            setInterval(() => {
                loadStatus();
                loadRuns();
                loadRecurringTasks();
            }, 30000);
        });
    </script>
</body>

</html>