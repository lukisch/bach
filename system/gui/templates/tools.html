<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - Tools</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .tools-layout {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 1.5rem;
            min-height: calc(100vh - 180px);
        }

        @media (max-width: 900px) {
            .tools-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar */
        .tools-sidebar {
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 1rem;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
        }

        .sidebar-section h3 {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .filter-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .filter-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .filter-item:hover {
            background: var(--bg-card);
        }

        .filter-item.active {
            background: var(--accent);
            color: white;
        }

        .filter-count {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Search */
        .search-box {
            width: 100%;
            padding: 0.6rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Main Content */
        .tools-main {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .tools-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tools-header h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .tools-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .stat-badge {
            background: var(--bg-card);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
        }

        /* Tool Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .tool-card {
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .tool-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .tool-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
        }

        .tool-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .tool-badge.python {
            background: #306998;
            color: white;
        }

        .tool-badge.cli {
            background: #4a5568;
            color: white;
        }

        .tool-badge.external {
            background: #805ad5;
            color: white;
        }

        .tool-prefix {
            font-size: 0.7rem;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .tool-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
            margin-top: 0.5rem;
        }

        .tool-path {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            font-family: monospace;
        }

        /* Tool Detail Modal */
        .tool-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .tool-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-section {
            margin-bottom: 1rem;
        }

        .modal-section h3 {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .modal-section pre {
            background: var(--bg-card);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <div class="tools-layout">
            <!-- Sidebar -->
            <div class="tools-sidebar">
                <input type="text" class="search-box" id="search-input"
                       placeholder="Tool suchen..." oninput="filterTools()">

                <div class="sidebar-section">
                    <h3>Typ</h3>
                    <ul class="filter-list">
                        <li class="filter-item active" data-type="all" onclick="setTypeFilter('all')">
                            <span>Alle</span>
                            <span class="filter-count" id="count-all">0</span>
                        </li>
                        <li class="filter-item" data-type="python" onclick="setTypeFilter('python')">
                            <span>Python</span>
                            <span class="filter-count" id="count-python">0</span>
                        </li>
                        <li class="filter-item" data-type="cli" onclick="setTypeFilter('cli')">
                            <span>CLI</span>
                            <span class="filter-count" id="count-cli">0</span>
                        </li>
                        <li class="filter-item" data-type="external" onclick="setTypeFilter('external')">
                            <span>Extern</span>
                            <span class="filter-count" id="count-external">0</span>
                        </li>
                    </ul>
                </div>

                <div class="sidebar-section">
                    <h3>Praefix</h3>
                    <ul class="filter-list" id="prefix-list">
                        <!-- Dynamisch befuellt -->
                    </ul>
                </div>

                <div class="sidebar-section">
                    <h3>Kategorie</h3>
                    <ul class="filter-list" id="category-list">
                        <!-- Dynamisch befuellt -->
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="tools-main">
                <div class="tools-header">
                    <h1>Tools</h1>
                    <div class="tools-stats">
                        <span class="stat-badge" id="stats-total">0 Tools</span>
                    </div>
                </div>

                <div class="tools-grid" id="tools-grid">
                    <div class="empty-state">
                        <div class="empty-icon">Lade...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Tool Detail Modal -->
    <div class="tool-modal" id="tool-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Tool Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Dynamisch befuellt -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="copyCommand()">Befehl kopieren</button>
                <button class="btn btn-primary" id="run-btn" onclick="runTool()">Ausfuehren</button>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        // State
        let allTools = [];
        let currentTypeFilter = 'all';
        let currentPrefixFilter = null;
        let currentCategoryFilter = null;
        let selectedTool = null;

        // API Helper
        const api = window.api || {
            get: async (url) => (await fetch(url)).json(),
            post: async (url, data) => {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                return res.json();
            }
        };

        // Load Tools
        async function loadTools() {
            try {
                const data = await api.get('/api/tools');

                // Merge tools
                allTools = [];

                // Python tools
                (data.python_tools || []).forEach(t => {
                    t.type = 'python';
                    allTools.push(t);
                });

                // DB tools
                (data.db_tools || []).forEach(t => {
                    allTools.push(t);
                });

                // Update counts
                updateCounts();

                // Update filters
                updatePrefixList();
                updateCategoryList(data.categories || []);

                // Render
                renderTools();

                // Stats
                document.getElementById('stats-total').textContent = `${allTools.length} Tools`;
                document.getElementById('status-dot').classList.add('online');
                document.getElementById('status-text').textContent = 'Online';

            } catch (e) {
                console.error('Load tools failed:', e);
                document.getElementById('tools-grid').innerHTML =
                    '<div class="empty-state"><div class="empty-icon">Fehler beim Laden</div></div>';
            }
        }

        // Update Counts
        function updateCounts() {
            const counts = {
                all: allTools.length,
                python: allTools.filter(t => t.type === 'python').length,
                cli: allTools.filter(t => t.type === 'cli').length,
                external: allTools.filter(t => t.type === 'external').length
            };

            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-python').textContent = counts.python;
            document.getElementById('count-cli').textContent = counts.cli;
            document.getElementById('count-external').textContent = counts.external;
        }

        // Update Prefix List
        function updatePrefixList() {
            const prefixes = {};
            allTools.filter(t => t.type === 'python' && t.prefix).forEach(t => {
                prefixes[t.prefix] = (prefixes[t.prefix] || 0) + 1;
            });

            const list = document.getElementById('prefix-list');
            list.innerHTML = Object.entries(prefixes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(([prefix, count]) => `
                    <li class="filter-item" data-prefix="${prefix}" onclick="setPrefixFilter('${prefix}')">
                        <span>${prefix}_*</span>
                        <span class="filter-count">${count}</span>
                    </li>
                `).join('');
        }

        // Update Category List
        function updateCategoryList(categories) {
            const list = document.getElementById('category-list');
            list.innerHTML = categories.slice(0, 10).map(cat => `
                <li class="filter-item" data-category="${cat}" onclick="setCategoryFilter('${cat}')">
                    <span>${cat}</span>
                </li>
            `).join('');
        }

        // Filter Functions
        function setTypeFilter(type) {
            currentTypeFilter = type;
            currentPrefixFilter = null;
            currentCategoryFilter = null;

            document.querySelectorAll('.filter-item[data-type]').forEach(el => {
                el.classList.toggle('active', el.dataset.type === type);
            });
            document.querySelectorAll('.filter-item[data-prefix]').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.filter-item[data-category]').forEach(el => el.classList.remove('active'));

            renderTools();
        }

        function setPrefixFilter(prefix) {
            currentPrefixFilter = currentPrefixFilter === prefix ? null : prefix;
            currentCategoryFilter = null;

            document.querySelectorAll('.filter-item[data-prefix]').forEach(el => {
                el.classList.toggle('active', el.dataset.prefix === currentPrefixFilter);
            });
            document.querySelectorAll('.filter-item[data-category]').forEach(el => el.classList.remove('active'));

            renderTools();
        }

        function setCategoryFilter(category) {
            currentCategoryFilter = currentCategoryFilter === category ? null : category;
            currentPrefixFilter = null;

            document.querySelectorAll('.filter-item[data-category]').forEach(el => {
                el.classList.toggle('active', el.dataset.category === currentCategoryFilter);
            });
            document.querySelectorAll('.filter-item[data-prefix]').forEach(el => el.classList.remove('active'));

            renderTools();
        }

        function filterTools() {
            renderTools();
        }

        // Render Tools
        function renderTools() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const grid = document.getElementById('tools-grid');

            let filtered = allTools;

            // Type filter
            if (currentTypeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === currentTypeFilter);
            }

            // Prefix filter
            if (currentPrefixFilter) {
                filtered = filtered.filter(t => t.prefix === currentPrefixFilter);
            }

            // Category filter
            if (currentCategoryFilter) {
                filtered = filtered.filter(t => t.category === currentCategoryFilter);
            }

            // Search filter
            if (search) {
                filtered = filtered.filter(t =>
                    t.name.toLowerCase().includes(search) ||
                    (t.description || '').toLowerCase().includes(search)
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <p>Keine Tools gefunden</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(tool => `
                <div class="tool-card" onclick="showToolDetail('${tool.name}')">
                    <div class="tool-header">
                        <div>
                            ${tool.prefix ? `<div class="tool-prefix">${tool.prefix}</div>` : ''}
                            <div class="tool-name">${escapeHtml(tool.name)}</div>
                        </div>
                        <span class="tool-badge ${tool.type}">${tool.type}</span>
                    </div>
                    ${tool.description ? `<div class="tool-desc">${escapeHtml(tool.description)}</div>` : ''}
                    ${tool.path ? `<div class="tool-path">${escapeHtml(tool.path)}</div>` : ''}
                    ${tool.category ? `<div class="tool-path">${escapeHtml(tool.category)}</div>` : ''}
                </div>
            `).join('');
        }

        // Show Tool Detail
        async function showToolDetail(name) {
            try {
                const data = await api.get(`/api/tools/${encodeURIComponent(name)}`);
                selectedTool = data;

                document.getElementById('modal-title').textContent = name;

                let body = '';

                if (data.type) {
                    body += `<div class="modal-section"><h3>Typ</h3><p>${data.type}</p></div>`;
                }

                if (data.path) {
                    body += `<div class="modal-section"><h3>Pfad</h3><pre>${data.path}</pre></div>`;
                }

                if (data.docstring) {
                    body += `<div class="modal-section"><h3>Beschreibung</h3><pre>${escapeHtml(data.docstring)}</pre></div>`;
                }

                if (data.description) {
                    body += `<div class="modal-section"><h3>Beschreibung</h3><p>${escapeHtml(data.description)}</p></div>`;
                }

                if (data.command) {
                    body += `<div class="modal-section"><h3>Befehl</h3><pre>${escapeHtml(data.command)}</pre></div>`;
                }

                if (data.endpoint) {
                    body += `<div class="modal-section"><h3>Endpoint</h3><pre>${escapeHtml(data.endpoint)}</pre></div>`;
                }

                if (data.use_for) {
                    body += `<div class="modal-section"><h3>Verwendung</h3><p>${escapeHtml(data.use_for)}</p></div>`;
                }

                if (data.lines) {
                    body += `<div class="modal-section"><h3>Zeilen</h3><p>${data.lines}</p></div>`;
                }

                document.getElementById('modal-body').innerHTML = body || '<p>Keine Details verfuegbar</p>';

                // Run button nur fuer Python
                document.getElementById('run-btn').style.display = data.type === 'python' ? 'block' : 'none';

                document.getElementById('tool-modal').classList.add('active');

            } catch (e) {
                console.error('Load tool detail failed:', e);
            }
        }

        function closeModal() {
            document.getElementById('tool-modal').classList.remove('active');
            selectedTool = null;
        }

        function copyCommand() {
            if (!selectedTool) return;

            let cmd = '';
            if (selectedTool.type === 'python') {
                cmd = `bach ${selectedTool.name}`;
            } else if (selectedTool.command) {
                cmd = selectedTool.command;
            } else {
                cmd = selectedTool.name;
            }

            navigator.clipboard.writeText(cmd).then(() => {
                alert('Befehl kopiert: ' + cmd);
            });
        }

        async function runTool() {
            if (!selectedTool || selectedTool.type !== 'python') return;

            const args = prompt('Argumente (optional):');

            try {
                const result = await api.post(`/api/tools/${selectedTool.name}/run`, {
                    args: args ? args.split(' ') : []
                });

                let output = '';
                if (result.stdout) output += result.stdout;
                if (result.stderr) output += '\n\nSTDERR:\n' + result.stderr;

                document.getElementById('modal-body').innerHTML = `
                    <div class="modal-section">
                        <h3>Ausgabe</h3>
                        <pre>${escapeHtml(output || '(keine Ausgabe)')}</pre>
                    </div>
                `;

            } catch (e) {
                alert('Ausfuehrung fehlgeschlagen: ' + e.message);
            }
        }

        // Helpers
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[m]);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadTools);
    </script>
</body>
</html>
