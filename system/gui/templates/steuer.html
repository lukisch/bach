<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - Steuer Agent Dashboard</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .steuer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .steuer-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--text);
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .beleg-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .beleg-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .beleg-item:last-child {
            border-bottom: none;
        }

        .beleg-kategorie {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .beleg-betrag {
            font-weight: 600;
            font-size: 1rem;
        }

        .beleg-betrag.einnahme {
            color: #28a745;
        }

        .beleg-betrag.ausgabe {
            color: #dc3545;
        }

        .kategorie-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .kategorie-badge.werbungskosten {
            background: #cce5ff;
            color: #004085;
        }

        .kategorie-badge.sonderausgaben {
            background: #d4edda;
            color: #155724;
        }

        .kategorie-badge.vorsorge {
            background: #fff3cd;
            color: #856404;
        }

        .kategorie-badge.sonstiges {
            background: #e2e3e5;
            color: #383d41;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th,
        .summary-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .summary-table th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }

        .upload-zone .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <div class="page-header">
            <h1>ğŸ“Š Steuer-Assistent</h1>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <select id="steuer-profil" class="btn btn-secondary" onchange="refreshSteuer()">
                    <option value="user_a">Profil: Person A</option>
                    <option value="user_b">Profil: Person B</option>
                    <option value="gemeinsam">Profil: Gemeinsam</option>
                </select>
                <select id="steuer-jahr" class="btn btn-secondary" onchange="refreshSteuer()">
                    <option value="2024">Jahr: 2024</option>
                    <option value="2025" selected>Jahr: 2025</option>
                    <option value="2026">Jahr: 2026</option>
                </select>
            </div>
            <div class="page-actions action-buttons">
                <button class="btn btn-primary" onclick="scanBelege()">ğŸ” Belege scannen</button>
                <button class="btn btn-secondary" onclick="syncAnbieter()">ğŸ”„ Anbieter sync</button>
                <button class="btn btn-secondary" onclick="refreshSteuer()">ğŸ”„</button>
            </div>
        </div>

        <!-- Statistik-Karten -->
        <div class="stat-cards">
            <div class="stat-card">
                <div class="stat-value" id="stat-belege">-</div>
                <div class="stat-label">Belege erfasst</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-einnahmen">-</div>
                <div class="stat-label">Einnahmen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-ausgaben">-</div>
                <div class="stat-label">Ausgaben</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-offen">-</div>
                <div class="stat-label">Offene Tasks</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="showTab('uebersicht')">Uebersicht</button>
            <button class="tab-btn" onclick="showTab('belege')">ğŸ§¾ Belege</button>
            <button class="tab-btn" onclick="showTab('kategorien')">ğŸ“ Kategorien</button>
            <button class="tab-btn" onclick="showTab('anbieter')">ğŸª Anbieter</button>
        </div>

        <!-- Tab: Uebersicht -->
        <div id="tab-uebersicht" class="tab-content active">
            <div class="steuer-grid">
                <!-- Letzte Belege -->
                <div class="card">
                    <h2>ğŸ§¾ Letzte Belege</h2>
                    <div class="beleg-list" id="beleg-list">
                        <p class="loading">Lade...</p>
                    </div>
                </div>

                <!-- Offene Tasks -->
                <div class="card">
                    <h2>ğŸ“‹ Offene Tasks</h2>
                    <div class="beleg-list" id="task-list">
                        <p class="loading">Lade...</p>
                    </div>
                </div>
            </div>

            <!-- Zusammenfassung -->
            <div class="card" style="margin-top: 1.5rem;">
                <h2>ğŸ“Š Jahresuebersicht</h2>
                <table class="summary-table" id="summary-table">
                    <thead>
                        <tr>
                            <th>Kategorie</th>
                            <th>Anzahl</th>
                            <th>Summe</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="loading">Lade...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Belege -->
        <div id="tab-belege" class="tab-content">
            <div class="card">
                <h2>Beleg erfassen</h2>
                <div class="upload-zone" onclick="document.getElementById('beleg-upload').click()">
                    <div class="icon">ğŸ“„</div>
                    <p>Beleg hier ablegen oder klicken zum Auswaehlen</p>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">PDF, JPG, PNG</p>
                </div>
                <input type="file" id="beleg-upload" style="display:none" accept=".pdf,.jpg,.jpeg,.png"
                    onchange="uploadBeleg(this)">
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <h2>Alle Belege</h2>
                <div class="beleg-list" id="all-belege">
                    <p class="loading">Lade...</p>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;" id="unlinked-section">
                <h2>ğŸ”— UnverknÃ¼pfte Belege</h2>
                <p class="text-muted">Diese Belege sind hochgeladen, aber noch keinem Posten zugeordnet.</p>
                <div class="beleg-list" id="unlinked-belege">
                    <p class="loading">Lade...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Kategorien -->
        <div id="tab-kategorien" class="tab-content">
            <div class="steuer-grid">
                <div class="card">
                    <h2>ğŸ  Werbungskosten</h2>
                    <div class="beleg-list" id="kat-werbungskosten">
                        <p>Arbeitsmittel, Fahrtkosten, Fortbildung...</p>
                    </div>
                </div>
                <div class="card">
                    <h2>ğŸ’° Sonderausgaben</h2>
                    <div class="beleg-list" id="kat-sonderausgaben">
                        <p>Versicherungen, Spenden, Vorsorge...</p>
                    </div>
                </div>
                <div class="card">
                    <h2>ğŸ¥ Vorsorgeaufwendungen</h2>
                    <div class="beleg-list" id="kat-vorsorge">
                        <p>Krankenversicherung, Rentenversicherung...</p>
                    </div>
                </div>
                <div class="card">
                    <h2>ğŸ“¦ Sonstiges</h2>
                    <div class="beleg-list" id="kat-sonstiges">
                        <p>Noch nicht kategorisierte Belege...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Anbieter -->
        <div id="tab-anbieter" class="tab-content">
            <div class="card">
                <h2>ğŸª Verbundene Anbieter</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Automatischer Import von Kontoauszuegen und Rechnungen.
                </p>
                <div class="action-buttons" style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="addAnbieter()">+ Anbieter hinzufuegen</button>
                    <button class="btn btn-secondary" onclick="syncAnbieter()">ğŸ”„ Alle synchronisieren</button>
                </div>
                <div class="beleg-list" id="anbieter-list">
                    <div class="beleg-item">
                        <div>
                            <strong>Noch keine Anbieter verbunden</strong>
                            <div class="beleg-kategorie">Siehe: bach --help anbieter</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <h2>ğŸ¦ Bank-Beleg-Abgleich</h2>
                <p class="text-muted">Gleicht Bank-Transaktionen (CAMT.053 XML) automatisch mit erfassten Posten ab.</p>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>CAMT.053 Datei auswÃ¤hlen</label>
                    <input type="file" id="camt-upload" accept=".xml">
                </div>
                <div class="action-buttons" style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="runBankMatching()">ğŸ” Abgleich starten</button>
                </div>
                <div id="matching-status"
                    style="margin-top:1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 4px; display: none;">
                    <p id="matching-results">Abgleich lÃ¤uft...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STEUER DASHBOARD - JavaScript
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let currentTab = 'uebersicht';

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // TAB NAVIGATION
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function showTab(tabName) {
            currentTab = tabName;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tabName) ||
                    (tabName === 'uebersicht' && btn.textContent === 'Uebersicht'));
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // DATA LOADING
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadStats() {
            // Placeholder - API noch nicht implementiert
            document.getElementById('stat-belege').textContent = '0';
            document.getElementById('stat-einnahmen').textContent = '0 EUR';
            document.getElementById('stat-ausgaben').textContent = '0 EUR';
            document.getElementById('stat-offen').textContent = '0';
        }

        async function loadBelege() {
            const container = document.getElementById('beleg-list');

            // Placeholder
            container.innerHTML = `
                <div class="beleg-item">
                    <div>
                        <strong>Noch keine Belege erfasst</strong>
                        <div class="beleg-kategorie">Starte mit "Belege scannen"</div>
                    </div>
                </div>
            `;
        }

        async function loadTasks() {
            const container = document.getElementById('task-list');

            try {
                const data = await api.get('/api/tasks?project=STEUER&status=open&limit=10');

                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML = `
                        <div class="beleg-item">
                            <div>
                                <strong>Keine offenen Tasks</strong>
                                <div class="beleg-kategorie">Alles erledigt!</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.tasks.map(task => `
                    <div class="beleg-item">
                        <div>
                            <strong>${task.title}</strong>
                            <div class="beleg-kategorie">${task.priority}</div>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                container.innerHTML = '<p>Tasks konnten nicht geladen werden.</p>';
            }
        }

        async function loadSummary() {
            const tbody = document.querySelector('#summary-table tbody');

            // Placeholder
            tbody.innerHTML = `
                <tr>
                    <td>Werbungskosten</td>
                    <td>0</td>
                    <td>0,00 EUR</td>
                </tr>
                <tr>
                    <td>Sonderausgaben</td>
                    <td>0</td>
                    <td>0,00 EUR</td>
                </tr>
                <tr>
                    <td>Vorsorgeaufwendungen</td>
                    <td>0</td>
                    <td>0,00 EUR</td>
                </tr>
                <tr style="font-weight: bold; background: var(--bg-secondary);">
                    <td>Gesamt</td>
                    <td>0</td>
                    <td>0,00 EUR</td>
                </tr>
            `;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ACTIONS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function scanBelege() {
            alert('Beleg-Scanner ist noch nicht implementiert.\n\nSiehe: bach steuer scan');
        }

        function syncAnbieter() {
            alert('Anbieter-Sync ist noch nicht implementiert.\n\nSiehe: bach --help anbieter');
        }

        function addAnbieter() {
            alert('Anbieter hinzufuegen ist noch nicht implementiert.\n\nSiehe: bach --help anbieter');
        }

        function uploadBeleg(input) {
            if (input.files && input.files[0]) {
                alert('Beleg-Upload: ' + input.files[0].name + '\n\nUpload-Funktion ist noch nicht implementiert.');
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // REFRESH & INIT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function refreshSteuer() {
            loadStats();
            loadBelege();
            loadTasks();
            loadSummary();
            loadUnlinkedDocs();
        }

        async function loadUnlinkedDocs() {
            const container = document.getElementById('unlinked-belege');
            const profil = document.getElementById('steuer-profil').value;
            const jahr = document.getElementById('steuer-jahr').value;

            try {
                const data = await api.get(`/api/steuer/dokumente/unlinked?username=${profil}&jahr=${jahr}`);
                if (!data.docs || data.docs.length === 0) {
                    container.innerHTML = '<p>Keine unverknÃ¼pften Belege gefunden.</p>';
                    return;
                }

                container.innerHTML = data.docs.map(doc => `
                    <div class="beleg-item">
                        <div>
                            <strong>${doc.dateiname}</strong>
                            <div class="beleg-kategorie">Vom: ${doc.hochgeladen_am.split('T')[0]}</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="linkToPosten(${doc.id})">ğŸ”— VerknÃ¼pfen</button>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p>Fehler beim Laden.</p>';
            }
        }

        async function linkToPosten(docId) {
            const postenId = prompt("ID des Postens eingeben (z.B. aus der Liste):");
            if (!postenId) return;

            try {
                const res = await api.post(`/api/steuer/posten/${postenId}/link`, { dokument_id: docId });
                if (res.success) {
                    alert("Erfolgreich verknÃ¼pft!");
                    refreshSteuer();
                } else {
                    alert("Fehler: " + res.error);
                }
            } catch (e) {
                alert("Verbindungsfehler");
            }
        }

        async function runBankMatching() {
            const fileInput = document.getElementById('camt-upload');
            if (fileInput.files.length === 0) {
                alert("Bitte wÃ¤hlen Sie eine XML-Datei aus.");
                return;
            }

            const statusPanel = document.getElementById('matching-status');
            const resultsText = document.getElementById('matching-results');

            statusPanel.style.display = 'block';
            resultsText.textContent = "Ãœbertrage Datei und starte Abgleich...";

            // Hinweis: Im echten System mÃ¼sste die Datei erst hochgeladen werden.
            // Hier simulieren wir den Pfad (aus VereinfachungsgrÃ¼nden fÃ¼r dieses Repo)
            const profil = document.getElementById('steuer-profil').value;
            const jahr = document.getElementById('steuer-jahr').value;

            try {
                // Mock-Aufruf: Wir nutzen den Dateinamen fÃ¼r das Tool
                const res = await api.post('/api/steuer/match-bank', {
                    camt_file: fileInput.files[0].name, // Hier steht im Produktivsystem der Serverpfad
                    username: profil,
                    jahr: jahr
                });

                if (res.success) {
                    resultsText.innerHTML = `<strong>Erfolg!</strong><br>${res.stdout}`;
                    refreshSteuer();
                } else {
                    resultsText.innerHTML = `<strong style="color:var(--error)">Fehler:</strong><br>${res.stderr || res.error}`;
                }
            } catch (e) {
                resultsText.textContent = "Verbindungsfehler zum Server.";
            }
        }

        document.addEventListener('DOMContentLoaded', refreshSteuer);
    </script>
</body>

</html>