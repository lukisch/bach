<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - Partner</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Top Partner Bar */
        .partner-bar-container {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .filter-tab {
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0.25rem 0.5rem;
            transition: color 0.2s;
        }

        .filter-tab.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        .partner-scroll-area {
            display: flex;
            gap: 0.75rem;
            /* Allow wrapping */
            flex-wrap: wrap;
            /* Max height for approximately 3 rows of buttons */
            max-height: 150px;
            overflow-y: auto;
            /* Custom scrollbar handling done via width: thin mostly supported */
            scrollbar-width: thin;
        }

        /* Compact Partner Button */
        .partner-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            user-select: none;
            /* Ensure height is consistent */
            height: 40px;
        }

        .partner-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .partner-btn.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .partner-icon {
            font-size: 1.2rem;
        }

        .partner-btn .status-dot {
            width: 8px;
            height: 8px;
            margin-right: 0;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        /* Interaction Area */
        .interaction-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
            /* Stretch items to equal height */
            align-items: stretch;
        }

        @media (max-width: 900px) {
            .interaction-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Assistants Card */
        /* Updated to match prompt-container style */
        .assistant-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            /* No fixed height, relies on grid stretch, but ensure full height usage */
            height: 100%;
        }

        /* Button override for Assistant Card */
        .assistant-card .btn {
            color: white !important;
            font-weight: 600;
        }

        /* Prompt Generator */
        .prompt-container {
            background: var(--bg-panel);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .prompt-header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .selected-big-icon {
            font-size: 2.5rem;
            background: var(--bg-card);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .prompt-textarea {
            flex: 1;
            width: 100%;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'Consolas', monospace;
            font-size: 1rem;
            resize: none;
            margin-bottom: 1rem;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .prompt-templates {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .template-chip {
            padding: 0.3rem 0.8rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .template-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .footer-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Helpers */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            background: var(--text-muted);
        }

        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 5px var(--success);
        }

        .status-dot.offline {
            background: var(--text-muted);
            opacity: 0.3;
        }

        .status-dot.available {
            background: var(--warning);
        }
    </style>
</head>

<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <!-- Top Stats (Condensed) -->
        <div style="display: flex; gap: 2rem; margin-bottom: 1rem; align-items: flex-end;">
            <h1 style="margin: 0;">Partner & Zuweisungen</h1>
            <div style="font-size: 0.85rem; color: var(--text-muted); padding-bottom: 5px;">
                <span id="stat-online" style="color: var(--success); font-weight: bold;">0</span> Online &bull;
                <span id="stat-total">0</span> Partner Insgesamt
            </div>
        </div>

        <!-- 1. Partner Selection Bar -->
        <div class="partner-bar-container">
            <div class="filter-tabs">
                <div class="filter-tab active" onclick="filterPartners('all', this)">Alle</div>
                <div class="filter-tab" onclick="filterPartners('agent', this)">Agenten</div>
                <div class="filter-tab" onclick="filterPartners('expert', this)">Experten</div>
                <div class="filter-tab" onclick="filterPartners('connection', this)">Verbindungen</div>
            </div>

            <div class="partner-scroll-area" id="partner-list-container">
                <p style="padding: 1rem; color: var(--text-muted);">Lade Partner...</p>
            </div>
        </div>

        <!-- 2. Interaction Area -->
        <div class="interaction-grid">

            <!-- Linke Spalte: Pers√∂nlicher Assistent (Fixed) -->
            <div class="card assistant-card">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem;">üë§</span>
                    <h2 style="margin: 0; font-size: 1.1rem;">Pers√∂nlicher Assistent</h2>
                </div>
                <div class="form-group">
                    <textarea id="assistent-text" placeholder="Notiz, Reminder oder Aufgabe f√ºr mich..."
                        style="height: 150px; width: 100%; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);"></textarea>
                </div>
                <button class="btn" onclick="sendToAssistent()" style="width: 100%; background: var(--primary);">
                    An Assistenten senden
                </button>
            </div>

            <!-- Rechte Spalte: Main Prompt Generator (Dynamic Context) -->
            <div class="prompt-container">
                <div class="prompt-header-info">
                    <div class="selected-big-icon" id="selected-icon">üì¶</div>
                    <div>
                        <h2 style="margin: 0; font-size: 1.4rem;" id="selected-name">Kein Partner</h2>
                        <div style="color: var(--text-muted); font-size: 0.9rem;" id="selected-role">Bitte oben
                            ausw√§hlen</div>
                    </div>
                    <div style="margin-left: auto;">
                        <span class="status-dot" id="selected-status-dot"></span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);" id="selected-status-text"></span>
                    </div>
                </div>

                <div class="prompt-templates">
                    <div class="template-chip" onclick="useTemplate('task')">üìã Aufgabe</div>
                    <div class="template-chip" onclick="useTemplate('question')">‚ùì Frage</div>
                    <div class="template-chip" onclick="useTemplate('analysis')">üîç Analyse</div>
                    <div class="template-chip" onclick="useTemplate('report')">üìù Report</div>
                </div>

                <textarea class="prompt-textarea" id="prompt-text"
                    placeholder="W√§hlen Sie einen Partner oben aus, um zu beginnen..."></textarea>

                <div class="footer-actions">
                    <button class="btn btn-secondary" onclick="clearPrompt()">Leeren</button>
                    <button class="btn btn-secondary" onclick="copyPrompt()">Kopieren</button>
                    <button class="btn btn-primary" onclick="createTaskFromPrompt()">Als Task zuweisen</button>
                </div>
            </div>

        </div>

    </main>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        let allPartners = [];
        let selectedPartner = null;

        const partnerIcons = {
            'agent': 'ü§ñ',
            'expert': 'üë®‚Äçüíº',
            'connection': 'üîó',
            'user': 'üë§',
            'system': '‚öôÔ∏è'
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadPartners();
        });

        async function loadPartners() {
            try {
                const data = await api.get('/api/assignees');
                allPartners = data.assignees || [];

                // Sortierung: Online zuerst, dann nach Typ
                allPartners.sort((a, b) => {
                    const statusA = (a.status === 'online') ? 1 : 0;
                    const statusB = (b.status === 'online') ? 1 : 0;
                    if (statusA !== statusB) return statusB - statusA; // Online first
                    return a.display_name.localeCompare(b.display_name);
                });

                // Stats Update
                const onlineCount = allPartners.filter(p => p.status === 'online').length;
                document.getElementById('stat-online').textContent = onlineCount;
                document.getElementById('stat-total').textContent = allPartners.length;

                renderPartners('all');

            } catch (e) {
                console.error('Partner laden fehlgeschlagen:', e);
            }
        }

        function filterPartners(type, tabEl) {
            // UI Tabs
            if (tabEl) {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tabEl.classList.add('active');
            }
            renderPartners(type);
        }

        function renderPartners(filterType) {
            const container = document.getElementById('partner-list-container');
            container.innerHTML = '';

            let filtered = allPartners;
            if (filterType !== 'all') {
                filtered = allPartners.filter(p => p.type === filterType);
            }

            filtered.forEach(p => {
                const btn = document.createElement('div');
                btn.className = `partner-btn ${selectedPartner?.id === p.id ? 'selected' : ''}`;
                btn.onclick = () => selectPartner(p.id);

                const statusClass = (p.status || 'offline').toLowerCase();
                const icon = partnerIcons[p.type] || 'üì¶';

                btn.innerHTML = `
                    <span class="partner-icon">${icon}</span>
                    <span style="font-weight:500;">${p.display_name}</span>
                    <span class="status-dot ${statusClass}"></span>
                `;
                container.appendChild(btn);
            });
        }

        function selectPartner(id) {
            selectedPartner = allPartners.find(p => p.id === id);

            // Re-render buttons to update selection state
            const currentFilter = document.querySelector('.filter-tab.active').innerText === 'Alle' ? 'all' :
                document.querySelector('.filter-tab.active').innerText === 'Agenten' ? 'agent' :
                    document.querySelector('.filter-tab.active').innerText === 'Experten' ? 'expert' : 'connection';

            // Just update classes instead of full re-render to keep scroll position
            document.querySelectorAll('.partner-btn').forEach(btn => {
                // This check is a bit fragile if display_name contains special chars or is not unique.
                // A better way would be to store the partner ID on the button itself (e.g., data-partner-id)
                // and compare that. For now, assuming display_name is sufficient for this context.
                if (btn.innerText.includes(selectedPartner.display_name)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });

            updateMainView();
        }

        function updateMainView() {
            if (!selectedPartner) return;

            document.getElementById('selected-name').textContent = selectedPartner.display_name;
            document.getElementById('selected-role').textContent = selectedPartner.category || selectedPartner.type.toUpperCase();
            document.getElementById('selected-icon').textContent = partnerIcons[selectedPartner.type] || 'üì¶';

            const status = selectedPartner.status || 'offline';
            const dot = document.getElementById('selected-status-dot');
            dot.className = `status-dot ${status.toLowerCase()}`;
            document.getElementById('selected-status-text').textContent = status.toUpperCase();

            // Update placeholder
            const ta = document.getElementById('prompt-text');
            if (!ta.value) {
                ta.placeholder = `Aufgabe f√ºr ${selectedPartner.display_name} formulieren...`;
            }

            // Pre-fill header in text if empty
            if (!ta.value.trim()) {
                ta.value = `[Fuer: ${selectedPartner.display_name}]\n\n`;
            } else if (ta.value.includes('[Fuer:')) {
                ta.value = ta.value.replace(/\[Fuer:.*?\]/, `[Fuer: ${selectedPartner.display_name}]`);
            }
        }

        // --- Action Logic (restored) ---

        async function sendToAssistent() {
            const text = document.getElementById('assistent-text').value.trim();
            if (!text) return;

            try {
                await api.post('/api/tasks', {
                    title: 'Memo an Personal Assistant',
                    description: text,
                    priority: 'P2',
                    project: 'Personal',
                    assigned_to: 'agent:persoenlich',
                    created_by: 'user'
                });
                alert('Gesendet!');
                document.getElementById('assistent-text').value = '';
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        async function createTaskFromPrompt() {
            if (!selectedPartner) { alert('Bitte Partner w√§hlen'); return; }
            const prompt = document.getElementById('prompt-text').value.trim();
            if (!prompt) { alert('Bitte Text eingeben'); return; }

            const lines = prompt.split('\n');
            let title = `Task f√ºr ${selectedPartner.display_name}`;
            // Simple heuristics for title
            for (let l of lines) {
                if (l.startsWith('AUFGABE:') || l.startsWith('FRAGE:')) {
                    title = l.split(':')[1].trim().substring(0, 60);
                    break;
                }
            }

            try {
                await api.post('/api/tasks', {
                    title: title,
                    description: prompt,
                    priority: 'P3',
                    assigned_to: selectedPartner.name, // ID format usually
                    created_by: 'user'
                });
                alert('Task erstellt!');
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        const templates = {
            task: `[Fuer: {partner}]\n\nAUFGABE:\n\n\nERWARTETES ERGEBNIS:\n-`,
            question: `[Fuer: {partner}]\n\nFRAGE:\n\n\nKONTEXT:\n-`,
            analysis: `[Fuer: {partner}]\n\nANALYSE-AUFTRAG:\n\n\nZU UNTERSUCHEN:\n-`,
            report: `[Fuer: {partner}]\n\nREPORT-ANFRAGE:\n\n\nZEITRAUM:\nFOKUS:`
        };

        function useTemplate(key) {
            if (!selectedPartner) { alert('Bitte erst Partner w√§hlen'); return; }
            const tpl = templates[key].replace('{partner}', selectedPartner.display_name);
            document.getElementById('prompt-text').value = tpl;
        }

        function clearPrompt() { document.getElementById('prompt-text').value = ''; }
        function copyPrompt() {
            navigator.clipboard.writeText(document.getElementById('prompt-text').value);
            alert('Kopiert');
        }

    </script>
</body>

</html>