<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - Scanner</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .scanner-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 1000px) {
            .scanner-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .scanner-status {
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .scanner-status.idle {
            background: #e2e3e5;
        }
        
        .scanner-status.running {
            background: #cce5ff;
        }
        
        .scanner-status.success {
            background: #d4edda;
        }
        
        .tools-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .tool-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .tool-item:last-child {
            border-bottom: none;
        }
        
        .tool-info {
            flex: 1;
        }
        
        .tool-name {
            font-weight: 600;
        }
        
        .tool-path {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .tool-badges {
            display: flex;
            gap: 0.5rem;
        }
        
        .badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .badge.tasks {
            background: #cce5ff;
            color: #004085;
        }
        
        .scanned-tasks-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .scanned-task {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .scanned-task:last-child {
            border-bottom: none;
        }
        
        .scanned-task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .scanned-task-tool {
            font-weight: 600;
            color: var(--primary);
        }
        
        .aufwand {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .aufwand.hoch { background: #f8d7da; color: #721c24; }
        .aufwand.mittel { background: #fff3cd; color: #856404; }
        .aufwand.niedrig { background: #d4edda; color: #155724; }
        
        .scanned-task-text {
            margin: 0.5rem 0;
        }
        
        .scanned-task-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <div class="page-header">
            <h1>üîç Task Scanner</h1>
            <div class="page-actions">
                <button class="btn btn-primary" onclick="runScan()" id="scan-btn">‚ñ∂Ô∏è Scan starten</button>
                <button class="btn btn-secondary" onclick="refreshAll()">üîÑ Aktualisieren</button>
            </div>
        </div>

        <div class="scanner-grid">
            <!-- Linke Spalte: Status & Tools -->
            <div>
                <!-- Scan Status -->
                <div class="card">
                    <h2>Status</h2>
                    <div class="scanner-status idle" id="scanner-box">
                        <p id="last-scan">Letzter Scan: -</p>
                        <p id="scan-stats">-</p>
                    </div>
                </div>

                <!-- Registrierte Tools -->
                <div class="card" style="margin-top: 1.5rem;">
                    <h2>Registrierte Tools (<span id="tools-count">0</span>)</h2>
                    <div class="tools-list" id="tools-list">
                        <p class="loading">Lade...</p>
                    </div>
                </div>
            </div>

            <!-- Rechte Spalte: Gescannte Tasks -->
            <div class="card">
                <h2>Gescannte Aufgaben (<span id="scanned-count">0</span>)</h2>
                <div class="scanned-tasks-list" id="scanned-list">
                    <p class="loading">Lade...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        async function loadScannerStatus() {
            try {
                const data = await api.get('/api/scanner/status');
                
                document.getElementById('last-scan').textContent = 
                    data.last_run 
                        ? `Letzter Scan: ${data.last_run.started_at}`
                        : 'Noch kein Scan durchgefuehrt';
                
                document.getElementById('scan-stats').textContent = 
                    `${data.total_tools} Tools, ${data.total_tasks} Tasks`;
                
            } catch (e) {
                console.error('Status laden fehlgeschlagen:', e);
            }
        }
        
        async function loadTools() {
            try {
                const data = await api.get('/api/scanner/tools');
                const list = document.getElementById('tools-list');
                document.getElementById('tools-count').textContent = data.count || 0;
                
                if (!data.tools || data.tools.length === 0) {
                    list.innerHTML = '<p>Keine Tools registriert. Starte einen Scan!</p>';
                    return;
                }
                
                list.innerHTML = data.tools.map(tool => `
                    <div class="tool-item">
                        <div class="tool-info">
                            <div class="tool-name">${tool.name}</div>
                            <div class="tool-path">${tool.path}</div>
                        </div>
                        <div class="tool-badges">
                            ${tool.task_count > 0 ? `<span class="badge tasks">${tool.task_count} Tasks</span>` : ''}
                        </div>
                    </div>
                `).join('');
                
            } catch (e) {
                console.error('Tools laden fehlgeschlagen:', e);
            }
        }
        
        async function loadScannedTasks() {
            try {
                const data = await api.get('/api/scanned-tasks?limit=50');
                const list = document.getElementById('scanned-list');
                document.getElementById('scanned-count').textContent = data.count || 0;
                
                if (!data.tasks || data.tasks.length === 0) {
                    list.innerHTML = '<p>Keine offenen Tasks gefunden.</p>';
                    return;
                }
                
                list.innerHTML = data.tasks.map(task => `
                    <div class="scanned-task">
                        <div class="scanned-task-header">
                            <span class="scanned-task-tool">${task.tool_name}</span>
                            <span class="aufwand ${task.aufwand}">${task.aufwand}</span>
                        </div>
                        <p class="scanned-task-text">${task.task_text}</p>
                        <div class="scanned-task-meta">
                            Status: ${task.status} ¬∑ Prioritaet: ${task.priority_score.toFixed(1)}
                        </div>
                    </div>
                `).join('');
                
            } catch (e) {
                console.error('Tasks laden fehlgeschlagen:', e);
            }
        }
        
        async function runScan() {
            const btn = document.getElementById('scan-btn');
            const box = document.getElementById('scanner-box');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Scannt...';
            box.className = 'scanner-status running';
            
            try {
                await api.post('/api/scanner/run');
                
                // Warte und aktualisiere
                setTimeout(() => {
                    box.className = 'scanner-status success';
                    refreshAll();
                    btn.disabled = false;
                    btn.textContent = '‚ñ∂Ô∏è Scan starten';
                }, 3000);
                
            } catch (e) {
                alert('Scan fehlgeschlagen: ' + e.message);
                btn.disabled = false;
                btn.textContent = '‚ñ∂Ô∏è Scan starten';
                box.className = 'scanner-status idle';
            }
        }
        
        function refreshAll() {
            loadScannerStatus();
            loadTools();
            loadScannedTasks();
        }
        
        // Initial laden
        document.addEventListener('DOMContentLoaded', refreshAll);
    </script>
</body>
</html>
