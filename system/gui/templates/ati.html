<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - ATI Agent Dashboard</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .ati-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .ati-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-tool {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .task-priority {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .task-priority.high {
            background: #f8d7da;
            color: #721c24;
        }

        .task-priority.medium {
            background: #fff3cd;
            color: #856404;
        }

        .task-priority.low {
            background: #d4edda;
            color: #155724;
        }

        .session-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .session-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .session-summary {
            margin-top: 0.25rem;
            font-size: 0.9rem;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .tool-item {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tool-item.has-tasks {
            border-left: 3px solid var(--primary);
        }

        .tool-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .tool-count {
            margin-left: auto;
            background: var(--primary);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--text);
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Scanner Section */
        .scanner-status-box {
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
        }

        .scanner-status-box.idle {
            background: #e2e3e5;
        }

        .scanner-status-box.running {
            background: #cce5ff;
        }

        .scanner-status-box.success {
            background: #d4edda;
        }

        .scanned-tasks-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .scanned-task {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .scanned-task:last-child {
            border-bottom: none;
        }

        .scanned-task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .scanned-task-tool {
            font-weight: 600;
            color: var(--primary);
        }

        .aufwand {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .aufwand.hoch {
            background: #f8d7da;
            color: #721c24;
        }

        .aufwand.mittel {
            background: #fff3cd;
            color: #856404;
        }

        .aufwand.niedrig {
            background: #d4edda;
            color: #155724;
        }

        /* Task Actions */
        .task-actions {
            display: flex;
            gap: 0.25rem;
            margin-left: auto;
        }

        .task-action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            background: var(--bg-secondary);
            color: var(--text);
            transition: all 0.2s;
        }

        .task-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        .task-action-btn.transfer {
            background: var(--primary);
            color: white;
        }

        .task-action-btn.delete {
            background: #dc3545;
            color: white;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin: 0 0 1rem 0;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text);
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .hidden {
            display: none !important;
        }

        /* Transfer Preview */
        .transfer-preview {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <div class="page-header">
            <h1>ğŸ› ï¸ ATI - Advanced Tool Integration</h1>
            <div class="page-actions action-buttons">
                <button class="btn btn-primary" onclick="showNewTaskModal()">+ Neue Aufgabe</button>
                <button class="btn btn-secondary" onclick="runScan()">ğŸ” Scan starten</button>
                <button class="btn btn-secondary" onclick="startSession()">ğŸ¤– Session starten</button>
                <button class="btn btn-secondary" onclick="startClaudeCode()">âŒ¨ï¸ Claude Code</button>
                <button class="btn btn-secondary" onclick="refreshATI()">ğŸ”„</button>
            </div>
        </div>

        <!-- Statistik-Karten -->
        <div class="stat-cards">
            <div class="stat-card">
                <div class="stat-value" id="stat-tools">-</div>
                <div class="stat-label">Tools gescannt</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-tasks">-</div>
                <div class="stat-label">Offene Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-sessions">-</div>
                <div class="stat-label">Sessions heute</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-completed">-</div>
                <div class="stat-label">Erledigt heute</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="showTab('uebersicht')">Uebersicht</button>
            <button class="tab-btn" onclick="showTab('scanner')">ğŸ” Scanner</button>
            <button class="tab-btn" onclick="showTab('sessions')">ğŸ¤– Sessions</button>
            <button class="tab-btn" onclick="showTab('onboarding')">ğŸ“¦ Onboarding</button>
        </div>

        <!-- Tab: Uebersicht -->
        <div id="tab-uebersicht" class="tab-content active">
            <div class="ati-grid">
                <!-- Offene Tasks -->
                <div class="card">
                    <h2>ğŸ“‹ Offene Tasks</h2>
                    <div class="task-list" id="task-list">
                        <p class="loading">Lade...</p>
                    </div>
                </div>

                <!-- Letzte Sessions -->
                <div class="card">
                    <h2>ğŸ¤– Letzte Sessions</h2>
                    <div class="task-list" id="session-list">
                        <p class="loading">Lade...</p>
                    </div>
                </div>
            </div>

            <!-- Gescannte Tools -->
            <div class="card" style="margin-top: 1.5rem;">
                <h2>ğŸ”§ Gescannte Tools</h2>
                <div class="tool-grid" id="tool-grid">
                    <p class="loading">Lade...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Scanner -->
        <div id="tab-scanner" class="tab-content">
            <div class="ati-grid">
                <div class="card">
                    <h2>Scanner Status</h2>
                    <div class="scanner-status-box idle" id="scanner-box">
                        <p id="last-scan">Letzter Scan: -</p>
                        <p id="scan-stats">-</p>
                    </div>
                    <button class="btn btn-primary" onclick="runScan()" style="width:100%">ğŸ” Scan starten</button>
                </div>

                <div class="card">
                    <h2>Registrierte Tools (<span id="tools-count">0</span>)</h2>
                    <div class="task-list" id="tools-list">
                        <p class="loading">Lade...</p>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <h2>Gescannte Aufgaben (<span id="scanned-count">0</span>)</h2>
                <div class="scanned-tasks-list" id="scanned-list">
                    <p class="loading">Lade...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Sessions -->
        <div id="tab-sessions" class="tab-content">
            <div class="card">
                <h2>ğŸ¤– Headless Sessions</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Sessions ermÃ¶glichen automatisierte Interaktion mit Claude Code.
                </p>
                <div class="action-buttons" style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="startSession()">ğŸ¤– Desktop Session</button>
                    <button class="btn btn-primary" onclick="startClaudeCode()">âŒ¨ï¸ Claude Code (CLI)</button>
                    <button class="btn btn-secondary" onclick="loadSessionHistory()">ğŸ”„ Aktualisieren</button>
                </div>
                <div class="task-list" id="session-history">
                    <div class="session-item">
                        <div class="session-time">Noch keine Sessions</div>
                        <div class="session-summary">Headless Sessions sind noch in Entwicklung.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Onboarding -->
        <div id="tab-onboarding" class="tab-content">
            <div class="card">
                <h2>ğŸ“¦ Tool Onboarding</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Neue Tools werden automatisch erkannt und fuer Onboarding-Tasks vorbereitet.
                </p>
                <div class="action-buttons" style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="checkNewTools()">ğŸ” Neue Tools pruefen</button>
                    <button class="btn btn-secondary" onclick="loadOnboardingTasks()">ğŸ”„ Aktualisieren</button>
                </div>
                <div class="task-list" id="onboarding-list">
                    <p class="loading">Lade...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- New/Edit Task Modal -->
    <div class="modal-overlay hidden" id="task-modal" onclick="closeTaskModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 id="modal-title">Neue ATI-Aufgabe</h2>
            <form onsubmit="saveTask(event)">
                <input type="hidden" id="edit-task-id">
                <div class="form-group">
                    <label>Aufgabe</label>
                    <textarea id="task-text" placeholder="Was soll getan werden?" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tool</label>
                        <input type="text" id="task-tool" placeholder="Tool-Name (optional)">
                    </div>
                    <div class="form-group">
                        <label>Aufwand</label>
                        <select id="task-aufwand">
                            <option value="niedrig">Niedrig</option>
                            <option value="mittel" selected>Mittel</option>
                            <option value="hoch">Hoch</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Prioritaet (0-100)</label>
                        <input type="number" id="task-priority" min="0" max="100" value="50">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="task-status">
                            <option value="offen">Offen</option>
                            <option value="in_arbeit">In Arbeit</option>
                            <option value="erledigt">Erledigt</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transfer to BACH Modal -->
    <div class="modal-overlay hidden" id="transfer-modal" onclick="closeTransferModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>ğŸš€ Transfer zu BACH Tasks</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                Diese Aufgabe wird ins BACH Task-System uebertragen und mit einem ATI-Prompt versehen.
            </p>
            <input type="hidden" id="transfer-task-id">

            <div class="form-group">
                <label>Task-Titel</label>
                <input type="text" id="transfer-title" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Prioritaet</label>
                    <select id="transfer-priority">
                        <option value="P3" selected>P3 - Normal</option>
                        <option value="P1">P1 - Kritisch</option>
                        <option value="P2">P2 - Wichtig</option>
                        <option value="P4">P4 - Niedrig</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Kategorie</label>
                    <input type="text" id="transfer-category" value="ATI">
                </div>
            </div>

            <div class="form-group">
                <label>ATI-Prompt Preview</label>
                <div class="transfer-preview" id="transfer-preview">Wird generiert...</div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="executeTransfer()">ğŸš€ Transferieren</button>
                <button type="button" class="btn btn-secondary" onclick="closeTransferModal()">Abbrechen</button>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ATI DASHBOARD - JavaScript
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let currentTab = 'uebersicht';

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // TAB NAVIGATION
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function showTab(tabName) {
            currentTab = tabName;

            // Tabs aktualisieren
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tabName) ||
                    (tabName === 'uebersicht' && btn.textContent === 'Uebersicht'));
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });

            // Tab-spezifische Daten laden
            if (tabName === 'scanner') loadScannerData();
            if (tabName === 'onboarding') loadOnboardingTasks();
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STATS & OVERVIEW
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadStats() {
            try {
                const stats = await api.get('/api/ati/stats');

                document.getElementById('stat-tools').textContent = stats.tools_scanned || 0;
                document.getElementById('stat-tasks').textContent = stats.open_tasks || 0;
                document.getElementById('stat-sessions').textContent = stats.sessions_today || 0;
                document.getElementById('stat-completed').textContent = stats.completed_today || 0;
            } catch (e) {
                console.error('Stats laden fehlgeschlagen:', e);
            }
        }

        async function loadTasks() {
            try {
                // Keine Status-Filterung = zeigt offen & in_arbeit gemaess API-Default
                const data = await api.get('/api/ati/tasks?limit=20');
                const container = document.getElementById('task-list');

                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML = '<div class="session-item"><div class="session-summary">Keine offenen Aufgaben gefunden.</div></div>';
                    return;
                }

                container.innerHTML = data.tasks.map(task => {
                    const statusClass = task.status === 'in_arbeit' ? 'in-progress' : '';
                    return `
                        <div class="task-item ${statusClass}">
                            <div style="flex-grow: 1;">
                                <strong>${escapeHtml(task.task_text)}</strong>
                                <div class="task-tool">${escapeHtml(task.tool_name || 'Allgemein')}</div>
                            </div>
                            <div class="task-actions">
                                <button class="task-action-btn" onclick="showTransferModal(${task.id})" title="Zu BACH Tasks transferieren">ğŸš€</button>
                                <button class="task-action-btn" onclick="showEditTaskModal(${task.id})" title="Bearbeiten">âœï¸</button>
                                <button class="task-action-btn delete" onclick="deleteATITask(${task.id})" title="LÃ¶schen">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Tasks laden fehlgeschlagen:', e);
                document.getElementById('task-list').innerHTML = '<p class="error">Fehler beim Laden.</p>';
            }
        }

        async function loadSessions() {
            try {
                const data = await api.get('/api/ati/sessions');

                // Update Overview List
                const listOverview = document.getElementById('session-list');
                if (listOverview) {
                    if (!data.sessions || data.sessions.length === 0) {
                        listOverview.innerHTML = '<div class="session-item"><div class="session-summary">Noch keine Sessions.</div></div>';
                    } else {
                        listOverview.innerHTML = data.sessions.map(session => {
                            const date = new Date(session.started_at).toLocaleTimeString('de-DE');
                            return `
                                <div class="session-item">
                                    <div class="session-time">${date}</div>
                                    <div class="session-summary">
                                        <strong>${session.partner_id || 'System'}</strong>: 
                                        ${session.summary || 'Laufende AktivitÃ¤t...'}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                // Update Session History Tab
                const listHistory = document.getElementById('session-history');
                if (listHistory) {
                    if (!data.sessions || data.sessions.length === 0) {
                        listHistory.innerHTML = '<div class="session-item"><div class="session-summary">Keine Historie verfÃ¼gbar.</div></div>';
                    } else {
                        listHistory.innerHTML = data.sessions.map(session => {
                            const date = new Date(session.started_at).toLocaleString('de-DE');
                            return `
                                <div class="session-item">
                                    <div class="session-time">${date}</div>
                                    <div class="session-summary">
                                        <strong>${session.partner_id}</strong> (Tokens: ${session.tokens_used || '?'})<br>
                                        ${session.summary || '<i>Keine Zusammenfassung.</i>'}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error('Sessions laden fehlgeschlagen:', e);
            }
        }

        async function loadTools() {
            try {
                const data = await api.get('/api/scanner/tools');
                const container = document.getElementById('tool-grid');

                if (!data.tools || data.tools.length === 0) {
                    container.innerHTML = '<p>Keine Tools gescannt. Starte einen Scan!</p>';
                    return;
                }

                container.innerHTML = data.tools.map(tool => `
                    <div class="tool-item ${tool.task_count > 0 ? 'has-tasks' : ''}">
                        <span class="tool-name">${tool.name}</span>
                        ${tool.task_count > 0 ? `<span class="tool-count">${tool.task_count}</span>` : ''}
                    </div>
                `).join('');

            } catch (e) {
                document.getElementById('tool-grid').innerHTML =
                    '<p>Tools konnten nicht geladen werden.</p>';
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // SCANNER TAB
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadScannerData() {
            await loadScannerStatus();
            await loadToolsList();
            await loadScannedTasks();
        }

        async function loadScannerStatus() {
            try {
                const data = await api.get('/api/scanner/status');

                document.getElementById('last-scan').textContent =
                    data.last_run
                        ? `Letzter Scan: ${data.last_run.started_at}`
                        : 'Noch kein Scan durchgefuehrt';

                document.getElementById('scan-stats').textContent =
                    `${data.total_tools || 0} Tools, ${data.total_tasks || 0} Tasks`;

            } catch (e) {
                console.error('Scanner Status laden fehlgeschlagen:', e);
            }
        }

        async function loadToolsList() {
            try {
                const data = await api.get('/api/scanner/tools');
                const list = document.getElementById('tools-list');
                document.getElementById('tools-count').textContent = data.count || 0;

                if (!data.tools || data.tools.length === 0) {
                    list.innerHTML = '<p>Keine Tools registriert. Starte einen Scan!</p>';
                    return;
                }

                list.innerHTML = data.tools.map(tool => `
                    <div class="task-item">
                        <div>
                            <strong>${tool.name}</strong>
                            <div class="task-tool">${tool.path || ''}</div>
                        </div>
                        ${tool.task_count > 0 ? `<span class="task-priority medium">${tool.task_count} Tasks</span>` : ''}
                    </div>
                `).join('');

            } catch (e) {
                console.error('Tools laden fehlgeschlagen:', e);
            }
        }

        async function loadScannedTasks() {
            try {
                const data = await api.get('/api/scanned-tasks?limit=50');
                const list = document.getElementById('scanned-list');
                document.getElementById('scanned-count').textContent = data.count || 0;

                if (!data.tasks || data.tasks.length === 0) {
                    list.innerHTML = '<p>Keine offenen Tasks gefunden.</p>';
                    return;
                }

                list.innerHTML = data.tasks.map(task => `
                    <div class="scanned-task">
                        <div class="scanned-task-header">
                            <span class="scanned-task-tool">${escapeHtml(task.tool_name)}</span>
                            <div class="task-actions">
                                <button class="task-action-btn transfer" onclick="showTransferModal(${task.id})" title="Zu BACH transferieren">ğŸš€</button>
                                <button class="task-action-btn" onclick="showEditTaskModal(${task.id})" title="Bearbeiten">âœï¸</button>
                                <button class="task-action-btn delete" onclick="deleteATITask(${task.id})" title="Loeschen">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <p style="margin: 0.5rem 0;">${escapeHtml(task.task_text)}</p>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Status: ${task.status} | Aufwand: ${task.aufwand} | Prioritaet: ${task.priority_score ? task.priority_score.toFixed(1) : '-'}
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                document.getElementById('scanned-list').innerHTML =
                    '<p>Tasks konnten nicht geladen werden.</p>';
            }
        }

        async function runScan() {
            const box = document.getElementById('scanner-box');
            if (box) box.className = 'scanner-status-box running';

            try {
                await api.post('/api/scanner/run');
                alert('Scan gestartet!');

                setTimeout(() => {
                    if (box) box.className = 'scanner-status-box success';
                    refreshATI();
                    if (currentTab === 'scanner') loadScannerData();
                }, 3000);

            } catch (e) {
                if (box) box.className = 'scanner-status-box idle';
                alert('Scan fehlgeschlagen: ' + e.message);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // SESSIONS TAB
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function startSession() {
            try {
                const workTime = prompt('Arbeitszeit in Minuten (Standard: 15):', '15');
                if (workTime === null) return;  // Abgebrochen

                const minutes = parseInt(workTime) || 15;
                const result = await api.post(`/api/ati/session/start?work_time=${minutes}`);

                if (result.success) {
                    if (result.triggered) {
                        alert(`ATI-Session gestartet!\n\nArbeitszeit: ${result.work_time} Min\nEnde: ${result.session_end}`);
                    } else {
                        alert(`Prompt in Zwischenablage kopiert!\n\nArbeitszeit: ${result.work_time} Min\nEnde: ${result.session_end}\n\nDruecke Ctrl+Space um Claude zu oeffnen, dann Ctrl+V.`);
                    }
                    // Stats aktualisieren
                    loadStats();
                    loadSessions();
                } else {
                    alert('Session-Start fehlgeschlagen: ' + (result.error || 'Unbekannter Fehler'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        function loadSessionHistory() {
            // Placeholder
            document.getElementById('session-history').innerHTML = `
                <div class="session-item">
                    <div class="session-time">Noch keine Sessions</div>
                    <div class="session-summary">Headless Sessions sind noch in Entwicklung.</div>
                </div>
            `;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CLAUDE CODE CLI START
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function startClaudeCode() {
            try {
                const taskPrompt = prompt('Direktauftrag (leer = SKILL.md Startprozedur):', '');
                if (taskPrompt === null) return;

                const workTime = 15;
                const params = new URLSearchParams({work_time: workTime});
                if (taskPrompt) params.append('task_prompt', taskPrompt);

                const result = await api.post(`/api/ati/session/start-cli?${params}`);

                if (result.success) {
                    alert(`Claude Code Terminal geoeffnet!\n\nArbeitszeit: ${result.work_time} Min\nEnde: ${result.session_end}\n\n${result.hint || ''}`);
                    loadStats();
                } else {
                    alert('Start fehlgeschlagen: ' + (result.error || 'Unbekannter Fehler'));
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ONBOARDING TAB
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadOnboardingTasks() {
            try {
                const data = await api.get('/api/ati/tasks?limit=20&status=offen');
                const container = document.getElementById('onboarding-list');

                // Filtere nach Aufgaben die mit "Neues Tool" oder Onboarding zu tun haben
                const onboardingTasks = data.tasks.filter(t =>
                    (t.tool_name && (t.tool_name === 'Neues Tool' || t.tool_name.includes('Discovery'))) ||
                    t.task_text.toLowerCase().includes('onboarding') ||
                    t.task_text.toLowerCase().includes('einrichten')
                );

                if (onboardingTasks.length === 0) {
                    container.innerHTML = `
                        <div class="session-item">
                            <div class="session-time">Keine Onboarding-Tasks</div>
                            <div class="session-summary">Alle Tools sind bereits eingerichtet oder keine neuen Tools wurden identifiziert.</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = onboardingTasks.map(task => `
                    <div class="task-item">
                        <div>
                            <strong>${escapeHtml(task.task_text)}</strong>
                            <div class="task-tool">${escapeHtml(task.tool_name || 'Neues Tool')}</div>
                        </div>
                        <div class="task-actions">
                             <button class="task-action-btn" onclick="showEditTaskModal(${task.id})" title="Bearbeiten/Satus Ã¤ndern">âš™ï¸</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Onboarding-Daten konnten nicht geladen werden:', e);
            }
        }

        async function checkNewTools() {
            alert('Tool-Discovery wird beim naechsten Scan automatisch ausgefuehrt.\n\nSiehe: python skills/_agents/ati/onboarding/tool_discovery.py check');
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // TASK CRUD OPERATIONS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        let allATITasks = [];

        function showNewTaskModal() {
            document.getElementById('modal-title').textContent = 'Neue ATI-Aufgabe';
            document.getElementById('edit-task-id').value = '';
            document.getElementById('task-text').value = '';
            document.getElementById('task-tool').value = '';
            document.getElementById('task-aufwand').value = 'mittel';
            document.getElementById('task-priority').value = '50';
            document.getElementById('task-status').value = 'offen';
            document.getElementById('task-modal').classList.remove('hidden');
        }

        async function showEditTaskModal(taskId) {
            try {
                const data = await api.get(`/api/ati/tasks/${taskId}`);
                const task = data.task || data;

                document.getElementById('modal-title').textContent = 'Aufgabe bearbeiten';
                document.getElementById('edit-task-id').value = taskId;
                document.getElementById('task-text').value = task.task_text || '';
                document.getElementById('task-tool').value = task.tool_name || '';
                document.getElementById('task-aufwand').value = task.aufwand || 'mittel';
                document.getElementById('task-priority').value = task.priority_score || 50;
                document.getElementById('task-status').value = task.status || 'offen';
                document.getElementById('task-modal').classList.remove('hidden');
            } catch (e) {
                alert('Aufgabe konnte nicht geladen werden: ' + e.message);
            }
        }

        function closeTaskModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('task-modal').classList.add('hidden');
        }

        async function saveTask(e) {
            e.preventDefault();

            const taskId = document.getElementById('edit-task-id').value;
            const data = {
                task_text: document.getElementById('task-text').value,
                tool_name: document.getElementById('task-tool').value || 'Manuell',
                aufwand: document.getElementById('task-aufwand').value,
                priority_score: parseInt(document.getElementById('task-priority').value),
                status: document.getElementById('task-status').value
            };

            try {
                if (taskId) {
                    await api.put(`/api/ati/tasks/${taskId}`, data);
                } else {
                    await api.post('/api/ati/tasks', data);
                }

                closeTaskModal();
                refreshATI();
                if (currentTab === 'scanner') loadScannerData();
            } catch (e) {
                alert('Fehler beim Speichern: ' + e.message);
            }
        }

        async function deleteATITask(taskId) {
            if (!confirm('Aufgabe wirklich loeschen?')) return;

            try {
                await api.delete(`/api/ati/tasks/${taskId}`);
                refreshATI();
                if (currentTab === 'scanner') loadScannerData();
            } catch (e) {
                alert('Fehler beim Loeschen: ' + e.message);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // TRANSFER TO BACH
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function showTransferModal(taskId) {
            try {
                const data = await api.get(`/api/ati/tasks/${taskId}`);
                const task = data.task || data;

                document.getElementById('transfer-task-id').value = taskId;
                document.getElementById('transfer-title').value = task.task_text.substring(0, 100);
                document.getElementById('transfer-category').value = 'ATI';

                // ATI-Prompt generieren
                const prompt = generateATIPrompt(task);
                document.getElementById('transfer-preview').textContent = prompt;

                // Prioritaet basierend auf priority_score
                let prio = 'P3';
                if (task.priority_score > 70) prio = 'P1';
                else if (task.priority_score > 40) prio = 'P2';
                document.getElementById('transfer-priority').value = prio;

                document.getElementById('transfer-modal').classList.remove('hidden');
            } catch (e) {
                alert('Aufgabe konnte nicht geladen werden: ' + e.message);
            }
        }

        function closeTransferModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('transfer-modal').classList.add('hidden');
        }

        function generateATIPrompt(task) {
            return `[ATI Task Transfer]

Tool: ${task.tool_name || 'Unbekannt'}
Aufwand: ${task.aufwand || 'mittel'}
Original Prioritaet: ${task.priority_score || 50}

AUFGABE:
${task.task_text}

---
Dieser Task wurde vom ATI-System (Advanced Tool Integration) erkannt.
Bitte bearbeite diese Aufgabe mit entsprechender Sorgfalt.
Nach Abschluss: bach task done <ID>`;
        }

        async function executeTransfer() {
            const taskId = document.getElementById('transfer-task-id').value;
            const title = document.getElementById('transfer-title').value;
            const priority = document.getElementById('transfer-priority').value;
            const category = document.getElementById('transfer-category').value;
            const description = document.getElementById('transfer-preview').textContent;

            try {
                // BACH Task erstellen
                await api.post('/api/tasks', {
                    title: title,
                    priority: priority,
                    project: category,
                    description: description,
                    created_by: 'ati',
                    assigned_to: 'user'
                });

                // ATI Task als erledigt markieren
                await api.put(`/api/ati/tasks/${taskId}`, {
                    status: 'transferiert'
                });

                closeTransferModal();
                alert('Aufgabe erfolgreich zu BACH Tasks transferiert!');
                refreshATI();
                if (currentTab === 'scanner') loadScannerData();
            } catch (e) {
                alert('Transfer fehlgeschlagen: ' + e.message);
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // HELPERS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // REFRESH & INIT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function refreshATI() {
            loadStats();
            loadTasks();
            loadSessions();
            loadTools();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTaskModal();
                closeTransferModal();
            }
        });

        document.addEventListener('DOMContentLoaded', refreshATI);
    </script>
</body>

</html>