<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACH - Memory</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .memory-layout {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            min-height: calc(100vh - 180px);
        }

        @media (max-width: 1400px) {
            .memory-layout {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 800px) {
            .memory-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Memory Panel */
        .memory-panel {
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
        }

        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
        }

        .panel-title {
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        /* Memory Entry */
        .memory-entry {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--accent);
        }

        .memory-entry.lesson {
            border-left-color: var(--success);
        }

        .memory-entry.session {
            border-left-color: var(--accent-blue);
        }

        .entry-content {
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .entry-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .entry-category {
            background: var(--bg-dark);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }

        .entry-actions {
            display: flex;
            gap: 0.25rem;
        }

        .entry-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .entry-btn:hover {
            opacity: 1;
        }

        /* Session Entry */
        .session-entry {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .session-id {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent-blue);
        }

        .session-status {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }

        .session-status.active {
            background: var(--success);
            color: white;
        }

        .session-status.ended {
            background: var(--text-muted);
            color: white;
        }

        .session-summary {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .session-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .session-entry {
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        .session-entry:hover {
            transform: translateY(-2px);
            background: var(--bg-hover);
        }

        /* Add Entry */
        .add-entry {
            padding: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .add-input {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.85rem;
            resize: none;
        }

        .add-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .add-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .add-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            border: 1px solid var(--border);
            flex: 1;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Tabs styling */
        .tabs-header {
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .tab-btn:hover {
            color: var(--text);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Full-width mode for single tab */
        .memory-layout.single-tab {
            grid-template-columns: 1fr;
        }

        .memory-layout.single-tab .memory-panel {
            max-height: none;
            min-height: 400px;
        }

        .memory-panel.hidden {
            display: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <header class="main-header" id="main-header"></header>

    <main class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1 style="margin: 0;">Memory System</h1>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <label
                    style="font-size: 0.85rem; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 0.3rem;"
                    title="Schaltet Loesch-Optionen frei">
                    <input type="checkbox" id="dev-mode" onchange="toggleDevMode()"> Dev Mode
                </label>
                <button class="btn btn-primary" onclick="showSessionEndDialog()">Session beenden</button>
            </div>
        </div>

        <!-- Cognitive Metaphor Visualization -->
        <div
            style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; border-left: 5px solid var(--accent);">
            <div
                style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--accent);">
                <span>üß† Kognitives Memory-Modell</span>
                <span style="font-size: 0.8rem; font-weight: 400; color: var(--text-muted);">(Zustand:
                    Konsolidiert)</span>
            </div>
            <div
                style="display: flex; justify-content: center; gap: 2rem; align-items: stretch; font-family: monospace; font-size: 0.85rem;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                    <div style="border: 2px solid var(--accent); padding: 0.5rem 1rem; border-radius: 4px; background: var(--bg-card);"
                        title="Aufmerksamkeit & Steuerung">
                        Zentrale Exekutive<br>(Injektoren)
                    </div>
                    <div style="height: 20px; border-left: 2px dashed var(--accent);"></div>
                    <div style="display: flex; gap: 1rem;">
                        <div style="border: 1px solid var(--accent-blue); padding: 0.5rem; border-radius: 4px; text-align: center;"
                            title="Sessions & Erlebnisse">
                            Episodisch<br>(Sessions)
                        </div>
                        <div style="border: 1px solid var(--warning); padding: 0.5rem; border-radius: 4px; text-align: center;"
                            title="Weltwissen & Fakten">
                            Semantisch<br>(Facts)
                        </div>
                        <div style="border: 1px solid var(--success); padding: 0.5rem; border-radius: 4px; text-align: center;"
                            title="Workflows & Skills">
                            Prozedural<br>(Workflows)
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; color: var(--text-muted);">
                    <span>‚óÄ‚îÄ‚îÄ‚îÄ Konsolidierung ‚îÄ‚îÄ‚îÄ‚ñ∂</span>
                </div>
                <div
                    style="border: 1px solid var(--border); padding: 1rem; border-radius: 4px; display: flex; align-items: center; text-align: center; color: var(--text-muted);">
                    Schlaf-Phase /<br>Verarbeitung
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-bar" style="flex-wrap: wrap;">
            <div class="stat-card">
                <div class="stat-value" id="stat-working">0</div>
                <div class="stat-label">Working</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-facts">0</div>
                <div class="stat-label">Facts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-lessons">0</div>
                <div class="stat-label">Lessons</div>
            </div>
            <div class="stat-card" style="border-bottom: 2px solid var(--accent-blue);">
                <div class="stat-value" id="stat-sessions">0</div>
                <div class="stat-label">Sessions</div>
            </div>
            <div class="stat-card" style="border-bottom: 2px solid var(--warning);">
                <div class="stat-value" id="stat-consolidation">0</div>
                <div class="stat-label">Consolid.</div>
            </div>
            <div class="stat-card" style="border-bottom: 2px solid var(--accent);">
                <div class="stat-value" id="stat-triggers">0</div>
                <div class="stat-label">Triggers</div>
            </div>
            <div class="stat-card" style="border-bottom: 2px solid var(--success);">
                <div class="stat-value" id="stat-workflows">0</div>
                <div class="stat-label">Workflows</div>
            </div>
        </div>

        <!-- Untertabs (Task #712/828) -->
        <div class="tabs-header" style="overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch;">
            <button class="tab-btn active" onclick="switchMemoryTab('all')">√úbersicht</button>
            <button class="tab-btn" onclick="switchMemoryTab('working')">Working</button>
            <button class="tab-btn" onclick="switchMemoryTab('facts')">Facts</button>
            <button class="tab-btn" onclick="switchMemoryTab('lessons')">Lessons</button>
            <button class="tab-btn" onclick="switchMemoryTab('sessions')">Sessions</button>
            <button class="tab-btn" onclick="switchMemoryTab('consolidation')">Konsolidierung</button>
            <button class="tab-btn" onclick="switchMemoryTab('triggers')">Injektoren</button>
            <button class="tab-btn" onclick="switchMemoryTab('workflows')">Prozedural</button>
            <button class="tab-btn" onclick="switchMemoryTab('practices')">Best Practices</button>
        </div>

        <!-- Layout Grid -->
        <div class="memory-layout" id="memory-board-layout">
            <!-- Working Memory -->
            <div class="memory-panel" id="panel-working">
                <div class="panel-header">
                    <span class="panel-title">Working Memory</span>
                    <span class="panel-count" id="working-count">0</span>
                </div>
                <div class="panel-content" id="working-list">
                    <div class="empty-state">Lade...</div>
                </div>
                <div class="add-entry">
                    <textarea class="add-input" id="working-input" rows="2"
                        placeholder="Neuen Eintrag hinzufuegen..."></textarea>
                    <div class="add-actions">
                        <button class="btn add-btn btn-primary" onclick="addWorkingMemory()">Hinzufuegen</button>
                    </div>
                </div>
            </div>

            <!-- Facts -->
            <div class="memory-panel" id="panel-facts">
                <div class="panel-header">
                    <span class="panel-title">Facts (Semantisch)</span>
                    <span class="panel-count" id="facts-count">0</span>
                </div>
                <div class="panel-content" id="facts-list">
                    <div class="empty-state">Lade...</div>
                </div>
                <div class="add-entry">
                    <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
                        <input class="add-input" id="fact-key" placeholder="Schluessel" style="flex:1;">
                        <input class="add-input" id="fact-value" placeholder="Wert" style="flex:2;">
                    </div>
                    <div class="add-actions">
                        <button class="btn add-btn btn-primary" onclick="addFact()">Hinzufuegen</button>
                    </div>
                </div>
            </div>

            <!-- Lessons Learned -->
            <div class="memory-panel" id="panel-lessons">
                <div class="panel-header">
                    <span class="panel-title">Lessons Learned</span>
                    <span class="panel-count" id="lessons-count">0</span>
                </div>
                <div class="panel-content" id="lessons-list">
                    <div class="empty-state">Lade...</div>
                </div>
                <div class="add-entry">
                    <textarea class="add-input" id="lesson-input" rows="2"
                        placeholder="Neue Lesson hinzufuegen..."></textarea>
                    <div class="add-actions">
                        <button class="btn add-btn btn-primary" onclick="addLesson()">Hinzufuegen</button>
                    </div>
                </div>
            </div>

            <!-- Sessions -->
            <div class="memory-panel" id="panel-sessions">
                <div class="panel-header">
                    <span class="panel-title">Sessions (Episodisch)</span>
                    <span class="panel-count" id="sessions-count">0</span>
                </div>
                <div class="panel-content" id="sessions-list">
                    <div class="empty-state">Lade...</div>
                </div>
            </div>

            <!-- Consolidation (Neu) -->
            <div class="memory-panel" id="panel-consolidation">
                <div class="panel-header">
                    <span class="panel-title">Konsolidierung</span>
                    <span class="panel-count" id="consolidation-count">0</span>
                </div>
                <div class="panel-content" id="consolidation-list">
                    <div class="empty-state">Lade...</div>
                </div>
            </div>

            <!-- Injektoren / Triggers (Neu) -->
            <div class="memory-panel" id="panel-triggers">
                <div class="panel-header">
                    <span class="panel-title">Injektoren (Trigger)</span>
                    <span class="panel-count" id="triggers-count">0</span>
                </div>
                <div class="panel-content" id="triggers-list">
                    <div class="empty-state">Lade...</div>
                </div>
            </div>

            <!-- Prozedural / Workflows -->
            <div class="memory-panel" id="panel-workflows">
                <div class="panel-header">
                    <span class="panel-title">Prozedural (Workflows)</span>
                    <span class="panel-count" id="workflows-count">0</span>
                </div>
                <div class="panel-content" id="workflows-list">
                    <div class="empty-state">Lade...</div>
                </div>
            </div>

            <!-- Best Practices (Neu) -->
            <div class="memory-panel" id="panel-practices">
                <div class="panel-header">
                    <span class="panel-title">Best Practices</span>
                    <span class="panel-count" id="practices-count">0</span>
                </div>
                <div class="panel-content" id="practices-list">
                    <div class="empty-state">Lade...</div>
                </div>
            </div>
        </div>

        <!-- Dev Mode Section (Task 479) -->
        <div id="dev-section"
            style="display: none; margin-top: 2rem; border-top: 2px dashed var(--border); padding-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: var(--accent); margin: 0;">üõ†Ô∏è Maintenance & DB</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="refreshDevData()">Refresh DB Stats</button>
                    <button class="btn btn-danger btn-sm" onclick="cleanupOrphanedMemory()">Cleanup Orphans</button>
                </div>
            </div>

            <div class="memory-layout">
                <!-- DB Tables -->
                <div class="memory-panel">
                    <div class="panel-header">
                        <span class="panel-title">DB Tabellen</span>
                        <span class="panel-count" id="db-table-count">?</span>
                    </div>
                    <div class="panel-content" id="db-tables-list" style="font-family: monospace; font-size: 0.85rem;">
                        <div class="empty-state">Dev Mode Details...</div>
                    </div>
                </div>

                <!-- Raw JSON View -->
                <div class="memory-panel" style="flex: 2;">
                    <div class="panel-header">
                        <span class="panel-title">Raw Memory Structure</span>
                    </div>
                    <div class="panel-content" id="raw-json-view"
                        style="font-family: monospace; font-size: 0.75rem; background: rgba(0,0,0,0.3); padding: 1rem; overflow-x: auto; white-space: pre;">
                        { "status": "dev_mode_active" }
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Session Ende Dialog -->
    <div class="modal" id="session-end-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; max-width: 600px; width: 90%;">
            <h3 style="margin-top: 0;">Session beenden</h3>

            <!-- Aktivitaeten-Vorschau -->
            <div id="session-activities"
                style="background: var(--bg-card); border-radius: 4px; padding: 1rem; margin-bottom: 1rem; max-height: 150px; overflow-y: auto;">
                <div style="color: var(--text-muted);">Lade Aktivitaeten...</div>
            </div>

            <!-- Template-Buttons -->
            <div style="margin-bottom: 1rem;">
                <span style="font-size: 0.85rem; color: var(--text-muted);">Vorlage:</span>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                        onclick="useTemplate('tasks')">Tasks</button>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                        onclick="useTemplate('files')">Dateien</button>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                        onclick="useTemplate('full')">Vollstaendig</button>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                        onclick="useTemplate('auto')">Auto-Generate</button>
                </div>
            </div>

            <!-- Summary-Eingabe -->
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Session-Zusammenfassung</label>
                <textarea id="session-summary" rows="5" placeholder="Beschreibe was in dieser Session erreicht wurde..."
                    style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 0.9rem; resize: vertical;"></textarea>
            </div>

            <!-- Optionen -->
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                    <input type="checkbox" id="session-shutdown" checked>
                    BACH herunterfahren
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                    <input type="checkbox" id="session-export-tasks">
                    Offene Tasks exportieren
                </label>
            </div>

            <!-- Aktionen -->
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="closeSessionEndDialog()">Abbrechen</button>
                <button class="btn btn-primary" onclick="endSession()">Session beenden</button>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        let isDevMode = false;

        function toggleDevMode() {
            isDevMode = document.getElementById('dev-mode').checked;
            document.getElementById('dev-section').style.display = isDevMode ? 'block' : 'none';
            if (isDevMode) refreshDevData();
            loadMemory(); // Neu rendern mit Buttons
        }

        function switchMemoryTab(tabId) {
            const layout = document.getElementById('memory-board-layout');
            const panels = ['working', 'facts', 'lessons', 'sessions', 'consolidation', 'triggers', 'workflows', 'practices'];

            // Update Header
            document.querySelectorAll('.tabs-header .tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('onclick').includes(`'${tabId}'`)) {
                    btn.classList.add('active');
                }
            });

            if (tabId === 'all') {
                layout.classList.remove('single-tab');
                panels.forEach(p => document.getElementById(`panel-${p}`).classList.remove('hidden'));
            } else {
                layout.classList.add('single-tab');
                panels.forEach(p => {
                    const el = document.getElementById(`panel-${p}`);
                    if (p === tabId) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });
            }
        }

        async function loadMemory() {
            try {
                const data = await api.get('/api/memory/overview');

                // Stats
                document.getElementById('stat-working').textContent = data.stats?.working_count || 0;
                document.getElementById('stat-facts').textContent = data.stats?.facts_count || 0;
                document.getElementById('stat-lessons').textContent = data.stats?.lessons_count || 0;
                document.getElementById('stat-sessions').textContent = data.stats?.sessions_count || 0;
                document.getElementById('stat-consolidation').textContent = data.stats?.consolidation_count || 0;
                document.getElementById('stat-triggers').textContent = data.stats?.triggers_count || 0;
                document.getElementById('stat-workflows').textContent = data.stats?.workflows_count || 0;

                // Render Panels
                renderWorking(data.working || []);
                renderFacts(data.facts || []);
                renderLessons(data.lessons || []);
                renderSessions(data.sessions || []);
                renderConsolidation(data.consolidation || []);
                renderTriggers(data.triggers || []);
                renderWorkflows(data.workflows || []);
                renderBestPractices(data.best_practices || []);

                // Raw JSON
                if (isDevMode) {
                    document.getElementById('raw-json-view').textContent = JSON.stringify(data, null, 2);
                }

                // Status
                document.getElementById('status-dot').classList.add('online');
                document.getElementById('status-text').textContent = 'Online';

            } catch (e) {
                console.error('Load memory failed:', e);
            }
        }

        // Render Functions
        function renderConsolidation(entries) {
            const list = document.getElementById('consolidation-list');
            document.getElementById('consolidation-count').textContent = entries.length;
            if (entries.length === 0) {
                list.innerHTML = '<div class="empty-state">Keine aktiven Prozesse</div>';
                return;
            }
            list.innerHTML = entries.map(e => `
                <div class="memory-entry" style="border-left-color: var(--warning);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                        ${e.source_table} [${e.source_id}]
                    </div>
                    <div class="entry-content">Weight: ${e.weight || 0} | Status: ${e.status || 'active'}</div>
                    <div class="entry-meta">
                        <span>${formatDate(e.created_at)}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderTriggers(entries) {
            const list = document.getElementById('triggers-list');
            document.getElementById('triggers-count').textContent = entries.length;
            if (entries.length === 0) {
                list.innerHTML = '<div class="empty-state">Keine aktiven Injektoren</div>';
                return;
            }
            list.innerHTML = entries.map(e => `
                <div class="memory-entry" style="border-left-color: var(--accent);">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 600; color: var(--accent);">${escapeHtml(e.trigger_key)}</span>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">${e.trigger_type}</span>
                    </div>
                    <div class="entry-meta">
                        <span>Fired: ${e.last_fired ? formatDate(e.last_fired) : 'Never'}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderWorkflows(entries) {
            const list = document.getElementById('workflows-list');
            document.getElementById('workflows-count').textContent = entries.length;
            if (entries.length === 0) {
                list.innerHTML = '<div class="empty-state">Keine Workflows gefunden</div>';
                return;
            }
            list.innerHTML = entries.map(e => `
                <div class="memory-entry" style="border-left-color: var(--success);">
                    <div style="font-weight: 600; color: var(--success);">${escapeHtml(e.name)}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">${e.filename}</div>
                </div>
            `).join('');
        }

        function renderBestPractices(entries) {
            const list = document.getElementById('practices-list');
            document.getElementById('practices-count').textContent = entries.length;
            if (entries.length === 0) {
                list.innerHTML = '<div class="empty-state">Keine Best Practices</div>';
                return;
            }
            list.innerHTML = entries.map(e => `
                <div class="memory-entry" style="border-left-color: var(--accent-blue); background: linear-gradient(to right, rgba(0,188,212,0.05), transparent);">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(e.title)}</div>
                    <div class="entry-content">${escapeHtml(e.content)}</div>
                    <div class="entry-meta">
                        <span class="entry-category">${e.category}</span>
                    </div>
                </div>
            `).join('');
        }

        // Render Working Memory
        function renderWorking(entries) {
            const list = document.getElementById('working-list');
            document.getElementById('working-count').textContent = entries.length;

            if (entries.length === 0) {
                list.innerHTML = '<div class="empty-state">Keine Eintraege</div>';
                return;
            }

            list.innerHTML = entries.map(e => `
                <div class="memory-entry">
                    <div class="entry-content">${escapeHtml(e.content)}</div>
                    <div class="entry-meta">
                        <span>${formatDate(e.created_at)}</span>
                        ${isDevMode ? `
                        <div class="entry-actions">
                            <button class="entry-btn" onclick="deleteWorking(${e.id})" title="Loeschen" style="color: #f44336; font-weight: bold;">[x]</button>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Render Facts
        function renderFacts(entries) {
            const list = document.getElementById('facts-list');
            document.getElementById('facts-count').textContent = entries.length;

            if (entries.length === 0) {
                list.innerHTML = '<div class="empty-state">Keine Facts</div>';
                return;
            }

            list.innerHTML = entries.map(e => `
                <div class="memory-entry" style="border-left-color: var(--warning);">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <span style="font-weight:600; color:var(--accent-blue); font-size:0.85rem;">${escapeHtml(e.key)}</span>
                            <div class="entry-content" style="margin-top:0.25rem;">${escapeHtml(e.value)}</div>
                        </div>
                    </div>
                    <div class="entry-meta">
                        ${e.category ? `<span class="entry-category">${e.category}</span>` : '<span></span>'}
                        <span>${formatDate(e.created_at)}</span>
                        ${isDevMode ? `
                        <div class="entry-actions">
                            <button class="entry-btn" onclick="deleteFact(${e.id})" title="Loeschen" style="color: #f44336; font-weight: bold;">[x]</button>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Render Lessons
        function renderLessons(entries) {
            const list = document.getElementById('lessons-list');
            document.getElementById('lessons-count').textContent = entries.length;

            if (entries.length === 0) {
                list.innerHTML = '<div class="empty-state">Keine Lessons</div>';
                return;
            }

            list.innerHTML = entries.map(e => `
                <div class="memory-entry lesson">
                    <div class="entry-content">${escapeHtml(e.content)}</div>
                    <div class="entry-meta">
                        ${e.category ? `<span class="entry-category">${e.category}</span>` : '<span></span>'}
                        <span>${formatDate(e.created_at)}</span>
                        ${isDevMode ? `
                        <div class="entry-actions">
                            <button class="entry-btn" onclick="deleteLesson(${e.id})" title="Loeschen" style="color: #f44336; font-weight: bold;">[x]</button>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Render Sessions
        function renderSessions(sessions) {
            const list = document.getElementById('sessions-list');
            document.getElementById('sessions-count').textContent = sessions.length;

            if (sessions.length === 0) {
                list.innerHTML = '<div class="empty-state">Keine Sessions</div>';
                return;
            }

            list.innerHTML = sessions.map(s => `
                <div class="session-entry" onclick="showSessionDetail(${s.id})">
                    <div class="session-header">
                        <span class="session-id">${escapeHtml(s.session_id || '#' + s.id)}</span>
                        <span class="session-status ${s.ended_at ? 'ended' : 'active'}">
                            ${s.ended_at ? 'Beendet' : 'Aktiv'}
                        </span>
                    </div>
                    ${s.summary ? `<div class="session-summary">${escapeHtml(s.summary.substring(0, 100))}${s.summary.length > 100 ? '...' : ''}</div>` : ''}
                    <div class="session-time">
                        Start: ${formatDate(s.started_at)}
                        ${s.ended_at ? ' | Ende: ' + formatDate(s.ended_at) : ''}
                    </div>
                </div>
            `).join('');
        }

        async function showSessionDetail(id) {
            try {
                const data = await api.get(`/api/memory/sessions/${id}`);
                if (data.success) {
                    const s = data.session;
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'flex';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.background = 'rgba(0,0,0,0.8)';
                    modal.style.zIndex = '2000';
                    modal.style.alignItems = 'center';
                    modal.style.justifyContent = 'center';
                    modal.id = 'session-detail-modal';

                    modal.innerHTML = `
                        <div class="modal-content" style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 2rem; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                                <div>
                                    <h2 style="margin: 0; color: var(--accent);">Session Detail</h2>
                                    <code style="color: var(--text-muted);">${s.session_id}</code>
                                </div>
                                <button class="btn btn-secondary" onclick="document.getElementById('session-detail-modal').remove()">Schlie√üen</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                <div>
                                    <h4 style="margin-top: 0; border-left: 3px solid var(--accent); padding-left: 0.5rem;">Zeitraum</h4>
                                    <p style="font-size: 0.9rem;">Start: ${formatDate(s.started_at)}</p>
                                    <p style="font-size: 0.9rem;">Ende: ${s.ended_at ? formatDate(s.ended_at) : 'Aktiv'}</p>
                                </div>
                                <div>
                                    <h4 style="margin-top: 0; border-left: 3px solid var(--success); padding-left: 0.5rem;">Statistik</h4>
                                    <p style="font-size: 0.9rem;">Completion: ${s.tasks_completed} Tasks</p>
                                    <p style="font-size: 0.9rem;">Created: ${s.tasks_created} Tasks</p>
                                </div>
                            </div>
                            
                            <h4 style="border-left: 3px solid var(--accent-blue); padding-left: 0.5rem;">Zusammenfassung</h4>
                            <div style="background: var(--bg-card); padding: 1rem; border-radius: 4px; font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; margin-bottom: 2rem;">
                                ${escapeHtml(s.summary || 'Keine Zusammenfassung vorhanden.')}
                            </div>
                            
                            ${s.continuation_context ? `
                                <h4 style="border-left: 3px solid var(--warning); padding-left: 0.5rem;">Fortsetzungs-Kontext</h4>
                                <div style="background: var(--bg-card); padding: 1rem; border-radius: 4px; font-size: 0.8rem; font-family: monospace; white-space: pre-wrap;">
                                    ${escapeHtml(s.continuation_context)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
            } catch (e) {
                alert("Fehler beim Laden der Session-Details: " + e.message);
            }
        }

        // Add Working Memory
        async function addWorkingMemory() {
            const input = document.getElementById('working-input');
            const content = input.value.trim();

            if (!content) return;

            try {
                await api.post('/api/memory/working', { content });
                input.value = '';
                loadMemory();
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // Add Lesson
        async function addLesson() {
            const input = document.getElementById('lesson-input');
            const category = document.getElementById('lesson-category').value;
            const content = input.value.trim();

            if (!content) return;

            try {
                await api.post('/api/memory/lessons', { content, category });
                input.value = '';
                loadMemory();
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // Add Fact
        async function addFact() {
            const key = document.getElementById('fact-key').value.trim();
            const value = document.getElementById('fact-value').value.trim();
            const category = document.getElementById('fact-category').value;

            if (!key || !value) return;

            try {
                await api.post('/api/memory/facts', { key, value, category });
                document.getElementById('fact-key').value = '';
                document.getElementById('fact-value').value = '';
                loadMemory();
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // Delete Fact
        async function deleteFact(id) {
            if (!confirm('Fact wirklich loeschen?')) return;
            try {
                const res = await api.delete(`/api/memory/facts/${id}`);
                if (res.status === 'deleted') loadMemory();
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // Delete Working Memory
        async function deleteWorking(id) {
            if (!confirm('Working Memory Eintrag wirklich loeschen?')) return;

            try {
                const res = await api.delete(`/api/memory/working/${id}`);
                if (res.status === 'deleted') {
                    loadMemory();
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // Delete Lesson (Task 486)
        async function deleteLesson(id) {
            if (!confirm('Lesson Learned wirklich loeschen?')) return;

            try {
                const res = await api.delete(`/api/memory/lessons/${id}`);
                if (res.status === 'deleted') {
                    loadMemory();
                }
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // Helpers
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[m]);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('de-DE') + ' ' + d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }

        // ‚ïê‚ïê‚ïê Session-Ende Dialog ‚ïê‚ïê‚ïê

        let sessionActivities = [];

        function showSessionEndDialog() {
            document.getElementById('session-end-modal').style.display = 'flex';
            loadSessionActivities();
        }

        function closeSessionEndDialog() {
            document.getElementById('session-end-modal').style.display = 'none';
        }

        async function loadSessionActivities() {
            const container = document.getElementById('session-activities');
            container.innerHTML = '<div style="color: var(--text-muted);">Lade Aktivitaeten...</div>';

            try {
                // Autolog analysieren
                const res = await fetch('/api/session/activities');
                const data = await res.json();

                sessionActivities = data.activities || [];

                if (sessionActivities.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted);">Keine Aktivitaeten in dieser Session gefunden.</div>';
                    return;
                }

                container.innerHTML = sessionActivities.map(a => `
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.25rem; font-size: 0.85rem;">
                        <span style="color: var(--text-muted); min-width: 50px;">${a.time || ''}</span>
                        <span style="color: ${a.type === 'task' ? 'var(--success)' : a.type === 'file' ? 'var(--accent)' : 'var(--text)'};">
                            ${a.type === 'task' ? '‚úì' : a.type === 'file' ? 'üìÑ' : '‚Üí'} ${escapeHtml(a.summary)}
                        </span>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div style="color: var(--text-muted);">Fehler beim Laden der Aktivitaeten</div>';
            }
        }

        function useTemplate(type) {
            const textarea = document.getElementById('session-summary');
            let template = '';

            switch (type) {
                case 'tasks':
                    const tasks = sessionActivities.filter(a => a.type === 'task');
                    template = 'ERLEDIGT:\n' + (tasks.length > 0 ?
                        tasks.map(t => '- ' + t.summary).join('\n') :
                        '- [keine Tasks erfasst]');
                    break;

                case 'files':
                    const files = sessionActivities.filter(a => a.type === 'file');
                    template = 'DATEIEN:\n' + (files.length > 0 ?
                        files.map(f => '- ' + f.summary).join('\n') :
                        '- [keine Dateien geaendert]');
                    break;

                case 'full':
                    const taskList = sessionActivities.filter(a => a.type === 'task');
                    const fileList = sessionActivities.filter(a => a.type === 'file');
                    template = 'ERLEDIGT:\n' + (taskList.length > 0 ?
                        taskList.map(t => '- ' + t.summary).join('\n') :
                        '- [keine Tasks]') +
                        '\n\nDATEIEN:\n' + (fileList.length > 0 ?
                            fileList.map(f => '- ' + f.summary).join('\n') :
                            '- [keine Aenderungen]') +
                        '\n\nNAECHSTE:\n- ';
                    break;

                case 'auto':
                    // Ruft Auto-Generierung auf
                    generateAutoSummary();
                    return;
            }

            textarea.value = template;
            textarea.focus();
        }

        async function generateAutoSummary() {
            const textarea = document.getElementById('session-summary');
            textarea.value = 'Generiere Zusammenfassung...';

            try {
                const res = await fetch('/api/session/generate-summary', { method: 'POST' });
                const data = await res.json();

                if (data.summary) {
                    textarea.value = data.summary;
                } else {
                    textarea.value = 'Fehler bei der Generierung. Bitte manuell eingeben.';
                }
            } catch (e) {
                textarea.value = 'Fehler: ' + e.message;
            }
        }

        async function endSession() {
            const summary = document.getElementById('session-summary').value.trim();
            const shutdown = document.getElementById('session-shutdown').checked;
            const exportTasks = document.getElementById('session-export-tasks').checked;

            if (!summary && !confirm('Ohne Zusammenfassung fortfahren? Es wird eine automatische Zusammenfassung erstellt.')) {
                return;
            }

            try {
                // Session-Summary speichern
                if (summary) {
                    await api.post('/api/memory/sessions', {
                        content: summary,
                        session_id: new Date().toISOString().split('T')[0]
                    });
                }

                // Optional: Tasks exportieren
                if (exportTasks) {
                    await fetch('/api/tasks/export', { method: 'POST' });
                }

                // Optional: Shutdown
                if (shutdown) {
                    const res = await fetch('/api/session/end', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        alert('Session beendet. BACH wird heruntergefahren.');
                    }
                } else {
                    alert('Session-Summary gespeichert.');
                    loadMemory();
                }

                closeSessionEndDialog();
            } catch (e) {
                alert('Fehler: ' + e.message);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', loadMemory);

        // Enter to submit
        document.getElementById('working-input').addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addWorkingMemory();
            }
        });

        document.getElementById('lesson-input').addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addLesson();
            }
        });
    </script>
</body>

</html>