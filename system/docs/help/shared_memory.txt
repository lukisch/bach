# Portabilitaet: UNIVERSAL
# Version: 1.0.0
# Zuletzt validiert: 2026-02-28
# Naechste Pruefung: 2026-08-28
# Ressourcen: [hub/shared_memory.py, shared_memory_*, shared_context_triggers]

SHARED MEMORY - Multi-Agent Memory-Verwaltung
===============================================

STAND: 2026-02-28

Das Shared Memory System ermoeglicht den gemeinsamen Speicherzugriff
mehrerer Agenten (Claude, Gemini, etc.). Im Gegensatz zum normalen
Memory-System koennen hier mehrere Partner gleichzeitig lesen und
schreiben.

Ref: SQ043 Stufe A-2

ARCHITEKTUR
-----------

  Agent A ─┐
  Agent B ─┤─> shared_memory_* (bach.db) <─┬─> Kontext-Block
  Agent C ─┘                                └─> Changes-Feed

Eigenschaften:
  - Multi-Agent-faehig (agent_id, namespace)
  - Visibility-Levels (private, team, global)
  - Decay-Tracking fuer automatisches Cleanup
  - Conflict Resolution via Konfidenz-Werte
  - dist_type fuer Distribution-System

CLI-BEFEHLE (bach shared-mem)
------------------------------

FACTS (Geteilte Fakten):
  facts list                    Alle shared Facts anzeigen
  facts add <key> <value>       Neuen Fact hinzufuegen
  facts get <id>                Bestimmten Fact anzeigen
  facts delete <id>             Fact loeschen

LESSONS (Geteilte Lektionen):
  lessons list                  Alle shared Lessons anzeigen
  lessons add <titel>           Neue Lesson hinzufuegen
  lessons activate <id>         Lesson aktivieren
  lessons deactivate <id>       Lesson deaktivieren

WORKING MEMORY (Kurzzeitgedaechtnis):
  working list                  Aktive Eintraege anzeigen
  working add <inhalt>          Eintrag hinzufuegen
  working cleanup               Abgelaufene Eintraege loeschen
  working current-task <text>   Aktuellen Task setzen (max. 1 pro Agent)

SESSIONS:
  sessions list [N]             Sessions anzeigen (Standard: 20)
  sessions current              Aktive Sessions anzeigen
  sessions archive <tage>       Alte Sessions archivieren

CONSOLIDATION (Speicher-Gewichtung):
  consolidation list            Consolidation-Eintraege anzeigen
  consolidation stats           Statistiken anzeigen
  consolidation add <t> <id>    Eintrag manuell hinzufuegen
  consolidation consolidate     Schwache Eintraege konsolidieren
  consolidation run             Decay-Logik ausfuehren (B57)

KONTEXT & AENDERUNGEN:
  context                       Kontext-Block generieren (B55)
  changes <timestamp>           Aenderungen seit Zeitstempel (B58)

BEISPIELE
---------

  # Fact hinzufuegen
  bach shared-mem facts add "api.endpoint" "https://api.example.com"
  bach shared-mem facts add "server.ip" "192.168.1.1" --agent CLAUDE --confidence 0.9

  # Lesson teilen
  bach shared-mem lessons add "Windows: UTF-8 mit PYTHONIOENCODING setzen" --severity high

  # Aktuellen Task setzen (Session-Anker)
  bach shared-mem working current-task "Migration von PyMuPDF auf pypdf"
  bach shared-mem working current-task "BACH Release vorbereiten" --agent GEMINI

  # Kontext-Block generieren (fuer Agenten-Initialisierung)
  bach shared-mem context

  # Aenderungen seit gestern abfragen
  bach shared-mem changes 2026-02-27T00:00:00

  # Decay-Logik ausfuehren (Speicher-Cleanup)
  bach shared-mem consolidation run
  bach shared-mem consolidation run --dry-run

CONFLICT RESOLUTION (B56)
--------------------------

Beim `facts add` mit bestehendem Key:
  - Neuer Confidence >= bestehender Confidence → Eintrag wird aktualisiert
  - Neuer Confidence < bestehender Confidence → Eintrag bleibt unveraendert

  Beispiel:
    bach shared-mem facts add "version" "2.5" --confidence 0.9
    # Ueberschreibt bestehenden Eintrag wenn dessen Confidence < 0.9

DECAY-SYSTEM (B57)
------------------

`consolidation run` fuehrt Decay-Logik durch:
  - Jeder Eintrag: weight *= decay_rate (Standard: 95% Erhalt)
  - Unterschreitet weight den threshold (Standard: 0.1) → Archivierung
  - Haeufig aufgerufene Eintraege erhalten Boost und werden seltener archiviert

CONTEXT-BLOCK (B55)
--------------------

`bach shared-mem context` generiert einen Markdown-Block:

  ## Shared Memory Context

  ### Current Tasks
  - **CLAUDE**: Migration laeuft (seit ...)

  ### Top Facts
  - **api.endpoint** [0.9]: https://api.example.com

  ### Aktive Lessons
  - [high] Windows: UTF-8 mit PYTHONIOENCODING setzen

Wird fuer Agenten-Initialisierung genutzt.

CHANGES-FEED (B58)
-------------------

`bach shared-mem changes <timestamp>` liefert alle Aenderungen
seit dem angegebenen ISO-Zeitstempel:

  bach shared-mem changes 2026-02-28T10:00:00

Nuetzlich fuer Agenten-Synchronisation: Ein Agent prueft regelmaessig
ob andere Agenten Fakten oder Lektionen hinzugefuegt haben.

OPTIONEN FUER FACTS ADD
-----------------------

  --agent <id>              Agent-ID (Standard: GLOBAL)
  --namespace <ns>          Namespace (Standard: default)
  --visibility <level>      private|team|global (Standard: global)
  --confidence <0.0-1.0>    Konfidenz-Wert (Standard: 0.5)

OPTIONEN FUER LESSONS ADD
--------------------------

  --severity info|warn|high|critical   Schwere (Standard: info)
  --agent <id>                          Agent-ID (Standard: GLOBAL)
  --namespace <ns>                      Namespace (Standard: default)

DATENBANK-TABELLEN
------------------

  shared_memory_facts         Geteilte Fakten (key-value)
  shared_memory_lessons       Geteilte Lektionen
  shared_memory_sessions      Geteilte Session-Historie
  shared_memory_working       Kurzzeitgedaechtnis (is_active, expires_at)
  shared_memory_consolidation Decay-Tracking (weight, decay_rate, threshold)
  shared_context_triggers     Geteilte Context-Trigger

UNTERSCHIED ZUM NORMALEN MEMORY
---------------------------------

  Normales Memory (bach mem, bach --memory):
    - Fuer EINEN Agenten/Partner
    - memory_working, memory_facts, memory_lessons

  Shared Memory (bach shared-mem):
    - Fuer MEHRERE Agenten gleichzeitig
    - Visibility-Control (private/team/global)
    - Conflict Resolution via Konfidenz
    - Decay-System fuer Cleanup

DATEIEN
-------
  hub/shared_memory.py     Handler-Implementation

SIEHE AUCH
----------
  bach --help memory        Normales Memory-System (einzelner Agent)
  bach --help consolidation Konsolidierungs-Engine
  bach --help connector     Connector-System (Multi-Partner)
