# Template-Konfiguration fuer WhatsApp-Connector
# Basis: Baileys WhatsApp Web API oder WhatsApp Business API

connector_name: WhatsApp
connector_type: whatsapp
connector_display_name: WhatsApp Business API
connector_description: |
  Implementiert BaseConnector fuer WhatsApp Business API.
  Unterstuetzt Baileys (WhatsApp Web) oder offizielle Business API.

# Module und Klassen-Namen
connector_module: whatsapp_connector
connector_instance_name: whatsapp_main
recipient_example: "49123456789@s.whatsapp.net"

# Auth-Konfiguration
auth_type: api_key
auth_config_example: |
  {"api_token": "YOUR_BUSINESS_API_TOKEN", "phone_number_id": "123456789"}
options_example: |
  {"mode": "business_api", "webhook_verify_token": "your_verify_token"}

# API-Konfiguration
api_base_comment: "# WhatsApp Business API"
api_base_url: "https://graph.facebook.com/v18.0"

# Code-Snippets
init_variables: |
  self._api_token = config.auth_config.get("api_token", "")
  self._phone_number_id = config.auth_config.get("phone_number_id", "")
  self._mode = config.options.get("mode", "business_api")  # oder "baileys"
  self._session_data = None

connect_validation: |
  if not self._api_token or not self._phone_number_id:
      self._status = ConnectorStatus.ERROR
      return False

connect_implementation: |
  # Verbindung testen via Account-Info
  url = f"{self.API_BASE}/{self._phone_number_id}"
  headers = {"Authorization": f"Bearer {self._api_token}"}
  req = urllib.request.Request(url, headers=headers)

  with urllib.request.urlopen(req, timeout=10) as resp:
      result = json.loads(resp.read().decode("utf-8"))
      if result:
          self._session_data = result

send_message_implementation: |
  url = f"{self.API_BASE}/{self._phone_number_id}/messages"
  headers = {
      "Authorization": f"Bearer {self._api_token}",
      "Content-Type": "application/json"
  }

  payload = {
      "messaging_product": "whatsapp",
      "to": recipient,
      "type": "text",
      "text": {"body": content}
  }

  data = json.dumps(payload).encode("utf-8")
  req = urllib.request.Request(url, data=data, headers=headers)

  with urllib.request.urlopen(req, timeout=15) as resp:
      result = json.loads(resp.read().decode("utf-8"))
      return result is not None

get_messages_implementation: |
  # WhatsApp Business API verwendet Webhooks fuer eingehende Nachrichten
  # Hier koennte man einen Webhook-Server implementieren oder
  # einen lokalen Cache von empfangenen Nachrichten abfragen
  # Fuer dieses Template geben wir eine leere Liste zurueck
  # und verlassen uns auf den Webhook-Mechanismus
  return []

parse_messages_implementation: |
  # Wird nur verwendet wenn Webhook-Daten gecacht werden
  pass

helper_methods: |
  def _api_call(self, method: str, endpoint: str, data: dict = None) -> any:
      """WhatsApp Business API aufrufen."""
      url = f"{self.API_BASE}/{endpoint}"
      headers = {
          "Authorization": f"Bearer {self._api_token}",
          "Content-Type": "application/json"
      }

      if data:
          payload = json.dumps(data).encode("utf-8")
          req = urllib.request.Request(url, data=payload, headers=headers, method=method)
      else:
          req = urllib.request.Request(url, headers=headers, method=method)

      try:
          with urllib.request.urlopen(req, timeout=15) as resp:
              return json.loads(resp.read().decode("utf-8"))
      except Exception as e:
          print(f"[WhatsApp API Error] {endpoint}: {e}", file=sys.stderr)
          return None

  def process_webhook(self, webhook_data: dict) -> List[Message]:
      """Webhook-Daten von WhatsApp Business API verarbeiten."""
      messages = []

      try:
          entry = webhook_data.get("entry", [])
          for e in entry:
              changes = e.get("changes", [])
              for change in changes:
                  value = change.get("value", {})
                  msgs = value.get("messages", [])

                  for msg in msgs:
                      if msg.get("type") == "text":
                          messages.append(Message(
                              channel="whatsapp",
                              sender=msg.get("from", ""),
                              content=msg.get("text", {}).get("body", ""),
                              timestamp=datetime.fromtimestamp(int(msg.get("timestamp", 0))).isoformat(),
                              direction="in",
                              message_id=msg.get("id", ""),
                              metadata={"type": msg.get("type", "text")}
                          ))
      except Exception as e:
          print(f"[WhatsApp Webhook Error] {e}", file=sys.stderr)

      return messages

# Setup-Wizard Fragen
setup_questions:
  - name: api_token
    prompt: "WhatsApp Business API Token (von Meta Business Manager)"
    type: secret
    required: true
    storage: auth_config

  - name: phone_number_id
    prompt: "Phone Number ID (aus WhatsApp Business Manager)"
    type: text
    required: true
    storage: auth_config

  - name: mode
    prompt: "Modus (business_api oder baileys)"
    type: choice
    choices: ["business_api", "baileys"]
    default: business_api
    required: true
    storage: options

  - name: webhook_verify_token
    prompt: "Webhook Verify Token (fuer Webhook-Setup)"
    type: secret
    required: false
    storage: options
